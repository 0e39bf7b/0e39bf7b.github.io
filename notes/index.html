<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.102.3" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Developer&#39;s blog">
  <title>Developer&#39;s blog</title>
  

  
  <link type="text/css" rel="stylesheet" href="../css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="../css/poole.css">
  <link type="text/css" rel="stylesheet" href="../css/syntax.css">
  <link type="text/css" rel="stylesheet" href="../css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="../favicon.png">

  
  <link href="../notes/index.xml" rel="alternate" type="application/rss+xml" title="Developer&#39;s blog" />
</head>

  <body>
    <header class="site-title">
      <h1><a href="../notes">Developer's notes</a></h1>
      <h4><a href="../">Go to Blog</a></h4>
    </header>
    <main class="container">
    <div class="posts">
<article class="post">
  <p>Finally I have returned to GitHub Pages.</p>

  <div class="post-date">
    <a href="../notes/1691984073/"><time datetime="2023-08-14T03:34:33Z">Aug 14, 2023 03:34</time></a>
  </div>
</article><article class="post">
  <p>I&rsquo;d found an article &ldquo;<a href="https://fedoramagazine.org/lenovo-fedora-now-available/">Now available: Fedora on Lenovo
laptops!</a>&rdquo;. It is said that Lenovo sells
ThinkPad X1 Carbon Gen 8, ThinkPad P53, and ThinkPad P1 Gen 2 laptops with Fedora pre-installed.
From the one side, it&rsquo;s great for the Linux community, because pre-installed Linux means that all
laptop systems are tested and work properly. From the other side, <a href="https://docs.fedoraproject.org/en-US/releases/lifecycle/">Fedora provides updated packages
for approximately 13 months</a>, so it&rsquo;s not
the best choice for a pre-installed system.</p>

  <div class="post-date">
    <a href="../notes/1682588621/"><time datetime="2023-04-27T09:43:41Z">Apr 27, 2023 09:43</time></a>
  </div>
</article><article class="post">
  <p>All smartphones are similar to each other nowadays. It&rsquo;s just a screen with several buttons on the
edge. Most of the time it&rsquo;s OK, but some tasks require typing a lot of text, so an on-screen
keyboard is not the best solution. Several years ago, it was possible to buy a slider keyboard case
for popular smartphones, so most of the time you use your smartphone as usual, but when you want to
type a long email or execute several command over SSH you just slide a physical keyboard and use
your device like a PDA. It&rsquo;s a bit strange that there is no such an option nowadays. Of course, it&rsquo;s
possible to buy a <a href="https://store.planetcom.co.uk/products/cosmo-communicator">Cosmo communicator</a> or
<a href="https://www.pine64.org/pinephonepro/">PinePhone Pro</a> with a
<a href="https://pine64.com/product/pinephone-pinephone-pro-keyboard-case/">keyboard</a>, but these devices are
for hardcore enthusiasts and it can be difficult to use them every day.</p>

  <div class="post-date">
    <a href="../notes/1681681157/"><time datetime="2023-04-16T21:39:17Z">Apr 16, 2023 21:39</time></a>
  </div>
</article><article class="post">
  <p>It looks like Mastodon is becoming more and more popular. Maybe in the future it will become a real
alternative to Twitter.</p>

  <div class="post-date">
    <a href="../notes/1681560124/"><time datetime="2023-04-15T12:02:04Z">Apr 15, 2023 12:02</time></a>
  </div>
</article><article class="post">
  <p>After the installation of language packages in Kubuntu 22.04, I&rsquo;d found that <code>LANGUAGE</code> variable had
been changed. There was nothing in <code>/etc/default/locale</code> or <code>~/.pam_environment</code>, so it looked a bit
strange. I&rsquo;d realized that KDE writes locale configs into <code>~/.config/plasma-localerc</code>, so I changed
settings there and reload session. Now I have the desired value of the <code>LANGUAGE</code> variable.</p>

  <div class="post-date">
    <a href="../notes/1680425973/"><time datetime="2023-04-02T08:59:33Z">Apr 2, 2023 08:59</time></a>
  </div>
</article><article class="post">
  <p>After almost three years with Ubuntu 20.04 on my desktop, I&rsquo;ve finally updated to Kubuntu 22.04.</p>

  <div class="post-date">
    <a href="../notes/1680370774/"><time datetime="2023-04-01T17:39:34Z">Apr 1, 2023 17:39</time></a>
  </div>
</article><article class="post">
  <p>Sometimes I come across an idea that today&rsquo;s computers are too complicated, and it&rsquo;s difficult to
understand them. People think that it was a lot easier in the 80s during the 8-Bit computer era to
grasp all of what is going on inside of any single machine, because the computers were relatively
simple and constrained.</p>
<p>I think it&rsquo;s a controversial question. In the 80s, the computers were easier, but it was more
difficult to find the information about them. There was no modern Internet with Google,
StackOverflow and Open Source, so the computer enthusiasts spent a lot of time to understand
relatively basic things. Today, there are a lot of possibilities to understand how computers work.
There are books like
<a href="https://www.amazon.com/Computer-Organization-Design-RISC-V-Architecture/dp/0128122757">Computer Organization and Design RISC-V Edition</a>
or university courses like
<a href="https://pdos.csail.mit.edu/6.S081/2020/schedule.html">MIT Operating Systems Engineering OCW course</a>.
Also, it&rsquo;s possible to start your research with RISC-V microcontrollers that are a lot easier than
X86 CPU.</p>
<p>I know a lot of developers who do not have enough time or desire to explore internal mechanisms of
the frameworks and libraries they use every day and very few people even try to read the
documentation and the source code to go deeper. The same was during 80s: people just learn some
basic commands to start the game from ZX Spectrum cassette, but they did not understand how these
commands actually worked. If someone really wants to understand the computer&rsquo;s internal mechanisms,
it&rsquo;s possible to do. The only required thing is a desire to learn.</p>

  <div class="post-date">
    <a href="../notes/1679757044/"><time datetime="2023-03-25T15:10:44Z">Mar 25, 2023 15:10</time></a>
  </div>
</article><article class="post">
  <p>Never used <a href="https://www.postgresql.org/docs/current/sql-savepoint.html">savepoints</a> in SQL in my
projects, but this feature can be really useful for some edge cases.</p>

  <div class="post-date">
    <a href="../notes/1678474413/"><time datetime="2023-03-10T18:53:33Z">Mar 10, 2023 18:53</time></a>
  </div>
</article><article class="post">
  <p><code>GENERATED ALWAYS AS IDENTITY</code> is a PostgreSQL construction that creates an identity column for
a table and forbids to specify a value for this field manually. E.g.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">CREATE</span> <span style="color:#719e07">TABLE</span> users (
</span></span><span style="display:flex;"><span>    id <span style="color:#b58900">INT</span> <span style="color:#719e07">GENERATED</span> ALWAYS <span style="color:#719e07">AS</span> <span style="color:#719e07">IDENTITY</span>,
</span></span><span style="display:flex;"><span>    name <span style="color:#b58900">VARCHAR</span> <span style="color:#719e07">NOT</span> <span style="color:#719e07">NULL</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">INSERT</span> <span style="color:#719e07">INTO</span> users(name) <span style="color:#719e07">VALUES</span> (<span style="color:#2aa198">&#39;John Smith&#39;</span>); <span style="color:#586e75">-- generates id value
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#719e07">INSERT</span> <span style="color:#719e07">INTO</span> users(id, name) <span style="color:#719e07">VALUES</span> (<span style="color:#2aa198">42</span>, <span style="color:#2aa198">&#39;Sam Smith&#39;</span>); <span style="color:#586e75">-- throws an error
</span></span></span></code></pre></div>
  <div class="post-date">
    <a href="../notes/1678304751/"><time datetime="2023-03-08T19:45:51Z">Mar 8, 2023 19:45</time></a>
  </div>
</article><article class="post">
  <p>When I need to access my home network from remote locations, I use WireGuard. It&rsquo;s fast and simple
to configure. In some countries, WireGuard is blocked by authorities. OpenVPN and L2TP/IPSec are
often blocked as well. The option that works almost always is Cisco AnyConnect. It&rsquo;s possible to run
AnyConnect compatible server with <a href="https://gitlab.com/openconnect/ocserv">ocserv</a>. It is slower than
WireGuard, but it can solve the problem when everything else is blocked.</p>

  <div class="post-date">
    <a href="../notes/1678273741/"><time datetime="2023-03-08T11:09:01Z">Mar 8, 2023 11:09</time></a>
  </div>
</article><article class="post">
  <p>I&rsquo;d tried <a href="https://www.deepl.com">DeepL</a>. It produces accurate translations for my use cases.</p>

  <div class="post-date">
    <a href="../notes/1677397576/"><time datetime="2023-02-26T07:46:16Z">Feb 26, 2023 07:46</time></a>
  </div>
</article><article class="post">
  <p><a href="https://kde.org/announcements/plasma/5/5.27.0/">KDE Plasma 5.27</a> has initial implementation of
window tiling.</p>

  <div class="post-date">
    <a href="../notes/1677142283/"><time datetime="2023-02-23T08:51:24Z">Feb 23, 2023 08:51</time></a>
  </div>
</article><article class="post">
  <p>In September 2020 I&rsquo;d written an article <a href="https://0e39bf7b.blog/posts/ubuntu-snap-the-price-of-the-isolation/">Ubuntu Snap: the Price of the
Isolation</a>. One inconvenience
with Snap was the updates mechanism: it was impossible to disable auto-updates and check for new
versions of software by hands. The epic with updates in Snap finally has ended:</p>
<ul>
<li>August 15, 2022: <a href="https://github.com/snapcore/snapd/pull/12035">the PR</a> that allows to hold
refreshes indefinitely for all the system&rsquo;s snaps;</li>
<li>November 15, 2022: it&rsquo;s possible to disable auto-updates in Snap from the edge channel (here is
<a href="https://snapcraft.io/blog/hold-your-horses-i-mean-snaps-new-feature-lets-you-stop-snap-updates-for-as-long-as-you-need">the post in snapcraft blog</a>);</li>
<li>January 10, 2023: snapd 2.58 released, it&rsquo;s possible to disable auto-updates in Snap from the
stable channel.</li>
</ul>
<p>It was a <a href="https://forum.snapcraft.io/t/disabling-automatic-refresh-for-snap-from-store/707">really long
discussion</a> since
2017.</p>

  <div class="post-date">
    <a href="../notes/1674540731/"><time datetime="2023-01-24T06:12:11Z">Jan 24, 2023 06:12</time></a>
  </div>
</article><article class="post">
  <p><a href="https://librearts.org/2023/01/year-in-preview/">Interesting article </a> about Open Source software
for creators. The author provides the annual recap and preview of FOSS projects across the
ecosystem: image editing, painting, photography, 3D, special effects, CAD, animation, video, and
audio.</p>

  <div class="post-date">
    <a href="../notes/1674038448/"><time datetime="2023-01-18T10:40:48Z">Jan 18, 2023 10:40</time></a>
  </div>
</article><article class="post">
  <p>Continue <a href="https://0e39bf7b.github.io/notes/1650372413/">talking about self-hosted services</a>. There
is a subreddit <a href="https://www.reddit.com/r/selfhosted">r/selfhosted</a> where people discuss alternatives
to popular online services that can be self-hosted without giving up privacy or locking you into a
service you don&rsquo;t control. In this subreddit I&rsquo;d found a link to a repository
<a href="https://github.com/awesome-foss/awesome-sysadmin">awesome-sysadmin</a> that contains a list of
different Open Source admin tools.</p>

  <div class="post-date">
    <a href="../notes/1673174608/"><time datetime="2023-01-08T10:43:28Z">Jan 8, 2023 10:43</time></a>
  </div>
</article><article class="post">
  <p>Some people use GitHub&rsquo;s Gist as a blogging platform. It seems like an interesting idea: you can
publish posts using built in Markdown, follow the other GitHub members and comment on their posts.
Gist has a lot of useful features for technical writing, like source code syntax highlighting, or
advanced formatting.</p>
<p>On the other hand, Gist is another vendor lock, like Twitter or Facebook. Actually, you do not own
your account and it can be terminated any time without violation of the GitHub user agreement. I
also use GitHub for this blog, but I use it as a static pages hosting platform, so if I will find
something better or GitHub will disable my account, I can switch to something else without losing my
blog.</p>
<p>Maybe it&rsquo;s some sort of paranoia, but it&rsquo;s better to do something before it will be too late.</p>

  <div class="post-date">
    <a href="../notes/1672425121/"><time datetime="2022-12-30T18:32:02Z">Dec 30, 2022 18:32</time></a>
  </div>
</article><article class="post">
  <p>I use Evolution mail client because it&rsquo;s the only client that works well with Exchange. I used to
install Evolution using <code>flatpak</code>, and it requires a password each time I start it. Today I&rsquo;ve
switched from <code>flatpak</code> version to <code>apt</code> version and now Evolution starts <code>gnome-keyring-daemon</code> and
uses it to store passwords. So I type my keyring password only once. It&rsquo;s a lot more convenient.</p>

  <div class="post-date">
    <a href="../notes/1671690580/"><time datetime="2022-12-22T06:29:40Z">Dec 22, 2022 06:29</time></a>
  </div>
</article><article class="post">
  <p>I use <a href="https://www.nordicsemi.com/products/nrf24-series">NRF24L01</a> chips from time to time. It&rsquo;s a
low-cost radio with small power consumption. That is why these chips are really useful for
communications between IoT devices. NRF24L01 exposes an interface for low-level communications
between two chips. Sometimes it&rsquo;s enough, but the other tasks require higher-level network protocols
like TCP. Recently I&rsquo;ve found <a href="http://www.theresistornetwork.com/2020/11/nerfnet-wireless-networking-over.html">an inspiring
post</a> that explains
how to set up a TCP/IP stack over NRF24L01. The author had developed
<a href="https://github.com/aarossig/nrfnet">nrfnet</a> — an application that creates virtual interface on
Raspberry PI and uses NRF24L01 as a backend for data transmission. The speed of such connection is
not too high, but it allows to use software like SSH or web server.</p>
<p>The nrfnet project looks like a proof of concept that connects two Raspberry PI nodes. I&rsquo;ve found a
more mature project about NRF24L01 Networking — <a href="https://github.com/TMRh20">TMRh20</a>. It comprises a
plenty of libraries that allow to create a network of Internet enabled RF24/Arduino sensors by
providing an API similar to the Arduino Ethernet library. If you are interested in this subject, you
should definitely take a look at <a href="https://tmrh20.blogspot.com/">TMRh20s Project Blog</a>.</p>

  <div class="post-date">
    <a href="../notes/1670911951/"><time datetime="2022-12-13T06:12:32Z">Dec 13, 2022 06:12</time></a>
  </div>
</article><article class="post">
  <p>It&rsquo;s time to update my desktop at Kubuntu 22.04. To be sure that there will be no problems with
devices and the software that I use every day, it&rsquo;s important to a check new distro before
installing it on the internal hard drive. I&rsquo;d decided to <a href="https://0e39bf7b.blog/posts/install-ubuntu-on-external-disk/">install Kubuntu on an external
disk</a>.</p>
<p>First, I&rsquo;d used one of my USB flash drives. Unfortunately, all of them were extremely slow, that is
why I gave up on this idea. Also, I have one relatively old HDD that I used for backups several
years ago. Usually, HDD is much faster and reliable than USB flash drives, so it looked like a
suitable solution for my task. I&rsquo;d bought 2.5&quot; HDD enclosure and connected the HDD to my desktop. I
tried to install Kubuntu on it, but with no luck: it had shown an I/O error on the FS creation step.
An error reproduced on different distros, so it was not a distro-specific.</p>
<p>I thought the HDD was too old and had a lot of bad blocks, so I tried to run <code>badblocks -svn -b 512 -c 65536 /dev/sda</code> to check the device. Unfortunately, it took an hour to check 0.1%, so I&rsquo;d
canceled the operation. I was ready to give up on the whole idea, but suddenly I tried a different
USB cable, and it worked! Kubuntu had installed with no errors.</p>
<p>The moral: all parts of the chain can be faulty, so check all of them one by one, and it can help
you solve the problem.</p>

  <div class="post-date">
    <a href="../notes/1668575623/"><time datetime="2022-11-16T05:13:43Z">Nov 16, 2022 05:13</time></a>
  </div>
</article><article class="post">
  <p>Suppose you configure network settings on a remote Linux machine. The only way to access this
machine is an SSH connection. To prevent access problems in case of network configuration failure,
try such option:</p>
<ul>
<li>open <code>tmux</code>;</li>
<li>write <code>sleep 600 &amp;&amp; reboot</code> (you should cancel this command every 5-9 minutes and start again);</li>
<li>perform network configuration in a separate tab.</li>
</ul>
<p>It&rsquo;s important to make only temporary changes that will be lost after a reboot:</p>
<ul>
<li>do not execute commands like <code>systemctl enable nftables</code>, use <code>systemctl start nftables</code> instead;</li>
<li>do not use <code>--permanent</code> option for <code>firewall-cmd</code>.</li>
</ul>
<p>In case of network configuration failure, your machine will be rebooted in 10 minutes. All
configuration changes will be wiped out and you&rsquo;ll be able to connect.</p>

  <div class="post-date">
    <a href="../notes/1668257505/"><time datetime="2022-11-12T12:51:45Z">Nov 12, 2022 12:51</time></a>
  </div>
</article><article class="post">
  <p>TLDR; after several years with Vim I&rsquo;d found that it&rsquo;s difficult to leave the editor even if I know
about <code>:q!</code>.</p>
<p><img src="../my-vim-story/vim.png" alt="Vim"></p>
<p>I use Vim for a long time. For the first time, Vim looked confusing and illogical comparing with
mainstream IDEs like Eclipse or NetBeans. What is the purpose of different Vim modes? Why there are
no menu and tabs on the interface? Why do commands for ordinary actions look like combos from Mortal
Kombat? I asked myself these questions every day. Today I do not understand why I&rsquo;d started this
journey and why I&rsquo;d not abandoned it after several months. I&rsquo;m pretty sure that today I would not
start something like this.</p>
<p>The primary task that I solved using Vim was the editing of source code and configs on the Linux
servers. There was <a href="https://www.nano-editor.org/">nano</a>, but I did not like it, because it was too
primitive and lacked a lot of useful features, so I was looking for something more advanced. I had
no admin rights on that servers, that is why it was impossible to install something different. Even
today I do not know what alternative editor I could try. Emacs? May be. But life turned out the way
it turned out.</p>
<p>It was difficult to get used to the idea of
<a href="https://www.freecodecamp.org/news/vim-editor-modes-explained/">modes</a>, that is why typing was a
torture. But everything changed as soon as I&rsquo;d stopped using arrow keys and switched to <code>hjkl</code>.
Later, I&rsquo;d achieved the next level of Vim skills when I&rsquo;d found
<a href="https://vim.fandom.com/wiki/Macros">macros</a>. Assume, there are 100 uniform lines (it&rsquo;s a typical
for some sort of Linux configs) and I need to change these lines somehow. Sometimes it&rsquo;s easier for
me to plan a sequence of actions (like, delete a word, move the cursor to the end of the line, add a
comma and go to the next line) rather than write a regular expression. Here, recording a macro is
the best way to solve the problem.</p>
<p>I&rsquo;d tried to switch from Vim to <a href="https://code.visualstudio.com/">Visual Studio Code</a> and <a href="https://www.sublimetext.com/">Sublime
Text</a> several times, but always returned, because it&rsquo;s difficult to
work without core Vim features like <a href="https://vim.fandom.com/wiki/Using_marks">marks</a>,
<a href="https://vim.fandom.com/wiki/Folding">folding</a> or
<a href="https://www.sourceallies.com/2009/11/vim-splits-an-introduction/">splits</a>. An example of my
everyday task: remove all symbols before <code>:</code>. It&rsquo;s possible to do this in Vim simply type <code>dt:</code>,
without mouse, without deleting symbols manually one by one.</p>
<p>Vim is a hugely customizable platform: just compare default config, <a href="https://spacevim.org">spacevim</a>
and <a href="https://vim.spf13.com">vim.spf13</a>. Nowadays,
<a href="https://microsoft.github.io/language-server-protocol/">LSP</a>s are available for different
programming languages, so even if Vim does not have build in support for some programming language,
it&rsquo;s always possible to use plugins from the other editors.</p>
<p><img src="../my-vim-story/spacevim.png" alt="SpaceVim"></p>
<p>If you want to try Vim, I suggest looking through the official tutorial: type <code>vimtutor</code> in the
terminal and follow the instructions. Recently I&rsquo;d found that Frontend Masters have developed a
high-quality course <a href="https://frontendmasters.com/courses/vim-fundamentals/">VIM Fundamentals</a> that
covers different aspects of the editor, so you can try it.</p>
<p>Some time ago I&rsquo;d found a <a href="https://github.com/foxweb/vim-pedal">vim-pedal</a> project on GitHub. It&rsquo;s a
device, recognized by as a USB keyboard. The device generates <code>i</code> symbol on press and <code>ESC</code> on
release. The user moves the cursor around the document in normal mode and when it&rsquo;s required to
inserts something — presses the pedal, insert some string and then releases the pedal. It looked
interesting.</p>
<p>I&rsquo;d decided to implement a prototype of such a device using STM32 microcontroller and digital piano
pedal. I&rsquo;d bought <a href="https://www.amazon.com/Cherub-WTB-004-Sustain-Pedal/dp/B008LMSDKI">Cherub
WTB-004</a>. Some user reviews said
that the pedal had a loud click, and that is why it&rsquo;s not the best choice for piano players, but for
me the pedal sounds like a mechanical keyboard with blue switches and I like it. I&rsquo;d taken my
Nucleo-64 evaluation kit out of the cabinet and had started prototyping.</p>
<p>I can&rsquo;t say that I&rsquo;d developed nothing for microcontrollers, but most of the time I used
<a href="https://en.wikipedia.org/wiki/AVR_microcontrollers">AVR</a> chips. I used Vim to write code,
<a href="https://gcc.gnu.org/wiki/avr-gcc">avr-gcc</a> to build a binary and
<a href="https://github.com/avrdudes/avrdude">avrdude</a> to upload the program to the on-chip memory. As I
found, in the STM32 world the software development looks a bit more complicated, especially for
newbie. Almost any tutorial from the Internet relies on the IDE and some standard libraries. I&rsquo;m
sure that it&rsquo;s possible to use only Vim and the terminal to build STM32 software, but I have limited
time, so I went a mainstream way.</p>
<p>Most of the tutorials rely on the official IDE by ST Electronics — STM32CubeIDE. I&rsquo;d found a Linux
version on the <a href="https://www.st.com/en/development-tools/stm32cubeide.html">ST Electronics site</a>. One
of the useful features of this IDE is a code generation: the developer selects a target
microcontroller, enables and configures hardware interfaces and timers using GUI, then IDE generates
all required boilerplate code and then the developer can focus on the business logic.</p>
<p><img src="../my-vim-story/mcu-configuration.png" alt="MCU Configuration"></p>
<p>The first program I wrote was the classic &ldquo;Hello, World&rdquo; with blinking led. I found all the required
information in <a href="https://www.hackster.io/jenfoxbot/hello-world-with-the-st-nucleo-64-6cd97f">the article from
Hackster</a>.</p>
<p>The next step was controlling the button state. It&rsquo;s possible to read MCU pin state synchronously in
the main loop, using <code>HAL_GPIO_ReadPin</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>GPIO_PINState btn_state;
</span></span><span style="display:flex;"><span><span style="color:#586e75">// Main loop
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#719e07">while</span> (<span style="color:#2aa198">1</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  btn_state <span style="color:#719e07">=</span> HAL_GPIO_ReadPin(GPIOC, GPIO_PIN_13);
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">if</span> (btn_state <span style="color:#719e07">==</span> GPIO_PIN_SET)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// High level on PC13
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// Low level on PC13
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Sometimes such an approach is inconvenient. Assume an application should perform two actions: react
on the button state change and send a block of data through UART. The transmission function is
implemented in a synchronous manner, so if it starts sending data, the MCU can&rsquo;t do anything else
until the transmission is complete. If transmission takes a lot of time, the MCU can&rsquo;t react on the
button state change on time.</p>
<p>There is an approach that allows to perform several operations simultaneously. It&rsquo;s called
<a href="https://deepbluembedded.com/stm32-interrupts-tutorial-nvic-exti/">interrupts</a>. When some external
events, like button state change, occur, the MCU stops its main loop and executes an interrupt
handler function. After that, MCU continues to execute the main loop. An example of button state
change processing with interrupts is explained in <a href="https://deepbluembedded.com/stm32-external-interrupt-example-lab/">the article from
DeepBlue</a>.</p>
<p>One problem I need to solve when working with mechanical buttons is a <a href="https://www.allaboutcircuits.com/textbook/digital/chpt-4/contact-bounce/">contact
bounce</a>. The button&rsquo;s
switches comprise spring materials. When any switch actuates, the contact touches one another.
Under the force of actuation, continuity is expected at a single steady moment. But the momentum
produced because of the mass of the moving contact and the inherent elasticity in this mechanism
makes the contact bounce several times before achieving a steady contact and coming to a full rest.
This effect is unnoticeable for devices like LED flashlight but it causes unwanted consequences when
working with MCU.</p>
<p>One of the software ways to neutralize the contact bounce is adding a delay after first button state
change detection. The MCU detects button state change, waits for some time (e.g. 20 ms) and after
that checks the button state again.</p>
<p>In my code, I&rsquo;d implemented contact bounce protection in such a way:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>GPIO_PinState old_btn_state <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>GPIO_PinState new_btn_state <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#dc322f">int</span> <span style="color:#268bd2">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// Main loop
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  <span style="color:#719e07">while</span> (<span style="color:#2aa198">1</span>)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (old_btn_state <span style="color:#719e07">!=</span> new_btn_state) {
</span></span><span style="display:flex;"><span>      old_btn_state <span style="color:#719e07">=</span> new_btn_state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#586e75">// Button state had changed
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>      <span style="color:#586e75">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">// External interrupt handler
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#dc322f">void</span> <span style="color:#268bd2">HAL_GPIO_EXTI_Callback</span>(<span style="color:#dc322f">uint16_t</span> GPIO_Pin)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// The same interrupt handler is called for different buttons,
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  <span style="color:#586e75">// so check the target pin before further actions
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  <span style="color:#719e07">if</span>(GPIO_Pin <span style="color:#719e07">==</span> GPIO_PIN_13)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// Disable further interrupts to solve contact bounce issues
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>    HAL_NVIC_DisableIRQ(EXTI15_10_IRQn);
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// Start timer
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>    HAL_TIM_Base_Start_IT(<span style="color:#719e07">&amp;</span>htim2);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">// Timer interrupt handler
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#dc322f">void</span> <span style="color:#268bd2">HAL_TIM_PeriodElapsedCallback</span>(TIM_HandleTypeDef <span style="color:#719e07">*</span>htim)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// The same interrupt handler is called for different timers,
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  <span style="color:#586e75">// so check the target timer before further actions
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  <span style="color:#719e07">if</span>(htim<span style="color:#719e07">-&gt;</span>Instance <span style="color:#719e07">==</span> TIM2)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// Stop the timer
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>    HAL_TIM_Base_Stop_IT(<span style="color:#719e07">&amp;</span>htim2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// Enable external interrupts
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>    __HAL_GPIO_EXTI_CLEAR_IT(GPIO_PIN_13);
</span></span><span style="display:flex;"><span>    NVIC_ClearPendingIRQ(EXTI15_10_IRQn);
</span></span><span style="display:flex;"><span>    HAL_NVIC_EnableIRQ(EXTI15_10_IRQn);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// Save new button state to process it in the main loop
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>    new_btn_state <span style="color:#719e07">=</span> HAL_GPIO_ReadPin(GPIOC, GPIO_PIN_13);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s say a few words about USB. Today, it&rsquo;s one of the most popular protocols. It is used in
different devices like keyboards, mice, cameras, flash drives and a lot more. The USB protocol
specification can be found on an <a href="https://www.usb.org/documents">official site</a>. It&rsquo;s a huge
document that is difficult to read, that is why I suggest reading <a href="https://www.beyondlogic.org/usbnutshell/usb1.shtml">USB in a
NutShell</a> first.</p>
<p>STM32F446 has a hardware USB support. It allows to work as a USB device using interrupts. Read an
<a href="https://www.instructables.com/STM32-As-HID-USB-Keyboard-STM32-Tutorials/">article from instructables
circuits</a> to find out how
to configure STM MCU to work with USB.</p>
<p>I used code generation to add USB support into my project and found an annoying issue. By default,
IDE configures the MCU to work as a USB mouse. I need to change several files to switch from a mouse
to a keyboard. When I change some MCU settings in the GUI, it starts a new code generation cycle and
reverts all previous changes. I use git and commit my changes from time to time. That is why this
issue does not affect me a lot, but it&rsquo;s better to know about it in advance.</p>
<p>After all modifications, my <code>main</code> function looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#719e07">extern</span> USBD_HandleTypeDef hUsbDeviceFS;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">typedef</span> <span style="color:#719e07">struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">uint8_t</span> MODIFIER;
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">uint8_t</span> RESERVED;
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">uint8_t</span> KEYCODE1;
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">uint8_t</span> KEYCODE2;
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">uint8_t</span> KEYCODE3;
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">uint8_t</span> KEYCODE4;
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">uint8_t</span> KEYCODE5;
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">uint8_t</span> KEYCODE6;
</span></span><span style="display:flex;"><span>} keyboardHID;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>keyboardHID keyboardhid <span style="color:#719e07">=</span> {<span style="color:#2aa198">0</span>, <span style="color:#2aa198">0</span>, <span style="color:#2aa198">0</span>, <span style="color:#2aa198">0</span>, <span style="color:#2aa198">0</span>, <span style="color:#2aa198">0</span>, <span style="color:#2aa198">0</span>, <span style="color:#2aa198">0</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GPIO_PinState old_btn_state <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>GPIO_PinState new_btn_state <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#dc322f">int</span> <span style="color:#268bd2">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
</span></span><span style="display:flex;"><span>  HAL_Init();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">/* Configure the system clock */</span>
</span></span><span style="display:flex;"><span>  SystemClock_Config();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">/* Initialize all configured peripherals */</span>
</span></span><span style="display:flex;"><span>  MX_GPIO_Init();
</span></span><span style="display:flex;"><span>  MX_USART2_UART_Init();
</span></span><span style="display:flex;"><span>  MX_USB_DEVICE_Init();
</span></span><span style="display:flex;"><span>  MX_TIM2_Init();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// Read initial button state
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  new_btn_state <span style="color:#719e07">=</span> HAL_GPIO_ReadPin(GPIOC, GPIO_PIN_13);
</span></span><span style="display:flex;"><span>  old_btn_state <span style="color:#719e07">=</span> new_btn_state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// Main loop
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  <span style="color:#719e07">while</span> (<span style="color:#2aa198">1</span>)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (old_btn_state <span style="color:#719e07">!=</span> new_btn_state) {
</span></span><span style="display:flex;"><span>      old_btn_state <span style="color:#719e07">=</span> new_btn_state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">if</span> (new_btn_state)
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        keyboardhid.KEYCODE1 <span style="color:#719e07">=</span> <span style="color:#2aa198">0x29</span>; <span style="color:#586e75">// Button released, generate ESC
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">else</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        keyboardhid.KEYCODE1 <span style="color:#719e07">=</span> <span style="color:#2aa198">0x0C</span>; <span style="color:#586e75">// Button pressed, generate i
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#586e75">// Send virtual keyboard key pressed
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>      USBD_HID_SendReport(<span style="color:#719e07">&amp;</span>hUsbDeviceFS, (<span style="color:#dc322f">uint8_t</span> <span style="color:#719e07">*</span>)<span style="color:#719e07">&amp;</span>keyboardhid, <span style="color:#719e07">sizeof</span>(keyboardhid));
</span></span><span style="display:flex;"><span>      HAL_Delay(<span style="color:#2aa198">50</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#586e75">// Send virtual keyboard key released
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>      keyboardhid.KEYCODE1 <span style="color:#719e07">=</span> <span style="color:#2aa198">0x00</span>;
</span></span><span style="display:flex;"><span>      USBD_HID_SendReport(<span style="color:#719e07">&amp;</span>hUsbDeviceFS, (<span style="color:#dc322f">uint8_t</span> <span style="color:#719e07">*</span>)<span style="color:#719e07">&amp;</span>keyboardhid, <span style="color:#719e07">sizeof</span>(keyboardhid));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I was working with Vim pedal for several days. It was an interesting experiment. Suddenly, I&rsquo;d
realized, that I often switches from normal mode to insert mode not only with <code>i</code> key but also with
different commands like <code>cw</code>, <code>cc</code>, <code>A</code> and <code>I</code>. I can&rsquo;t use Vim pedal for such cases for now, so
some sort of further improvements are required.</p>
<p>In conclusion, I want to say that building the Vim keyboard was an outstanding adventure. I learned
a lot of useful info about USB protocol, mechanical switches and improved STM32 programming skills.</p>
  <div class="post-date">
    <a href="../posts/my-vim-story/"><time datetime="2022-11-06T13:00:00Z">Nov 6, 2022 13:00</time></a>
  </div>
</article><article class="post">
  <p><a href="https://www.ired.team/">ired.team</a> — a site dedicated to pentesting, security tools and techniques.
Recently I&rsquo;d read an article about <a href="https://www.ired.team/offensive-security/code-injection-process-injection/how-to-hook-windows-api-using-c++">Windows API
Hooking</a>
from this resource. It describes a technique that can be used to intercept API calls. Malware
software often uses such technique to different malware software to inject malicious code into the
user&rsquo;s process.</p>

  <div class="post-date">
    <a href="../notes/1667560202/"><time datetime="2022-11-04T11:10:02Z">Nov 4, 2022 11:10</time></a>
  </div>
</article><article class="post">
  <p>Nginx is a standard de facto in my projects. On the weekend, I&rsquo;d read <a href="https://www.nginx.com/resources/library/complete-nginx-cookbook/">The Complete NGINX
Cookbook</a>. I&rsquo;d found some useful
tips about <code>$request_id</code> variable or <code>rate_limit</code> directive. I think the book is worth reading.</p>

  <div class="post-date">
    <a href="../notes/1667203537/"><time datetime="2022-10-31T08:05:37Z">Oct 31, 2022 08:05</time></a>
  </div>
</article><article class="post">
  <p>Most of the time, I use nginx as an HTTP load balancer, but it can also <a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-udp-load-balancer/">balance raw TCP and UDP
streams</a> with
<code>stream</code> block.</p>

  <div class="post-date">
    <a href="../notes/1667027350/"><time datetime="2022-10-29T07:09:10Z">Oct 29, 2022 07:09</time></a>
  </div>
</article><article class="post">
  <p><a href="http://www.hping.org/">hping</a> is a really flexible network diagnostic tool. It supports TCP, UDP,
ICMP and RAW-IP protocols, has a traceroute mode, the ability to send files between a covered
channel, and many other features. It helps to investigate network failures and fix its, so I think,
it&rsquo;s a must-have instrument for every developer and admin.</p>

  <div class="post-date">
    <a href="../notes/1665949478/"><time datetime="2022-10-16T19:44:38Z">Oct 16, 2022 19:44</time></a>
  </div>
</article><article class="post">
  <p>Today I&rsquo;d accidentally pressed some buttons and Firefox changed text alignment from left to right.
It was a bit confusing. If someone experienced the same issue and wants to return everything back,
it can be done with <code>Ctrl-Shift-X</code>.</p>

  <div class="post-date">
    <a href="../notes/1665914946/"><time datetime="2022-10-16T10:09:06Z">Oct 16, 2022 10:09</time></a>
  </div>
</article><article class="post">
  <p>The required things for offline coding:</p>
<ol>
<li>Books about programming environment (OS, network, compiler, security and so on).</li>
<li><code>pdfgrep</code> to search through these books.</li>
<li><a href="https://zealdocs.org/">zeal</a> to browse documentation about programming language, web server and
different libraries like Qt.</li>
<li>Full stackoverflow dump made by <a href="https://www.kiwix.org/en/">kiwix</a>.</li>
</ol>

  <div class="post-date">
    <a href="../notes/1665297164/"><time datetime="2022-10-09T06:32:44Z">Oct 9, 2022 06:32</time></a>
  </div>
</article><article class="post">
  <p>Do you know that it&rsquo;s possible to download the whole Wikipedia or Stack Overflow with
<a href="https://www.kiwix.org/en/">kiwix</a>? Just go to
<a href="https://library.kiwix.org/?lang=eng&amp;category=wikipedia">library.kiwix.org</a>, select required
resource and download the dump. It can take several hours, even on a fast connection. Then use <a href="https://www.kiwix.org/en/download/">the
reader</a> to explore the resource offline. I prefer to install the
reader from Flatpak: <code>flatpak install flathub org.kiwix.desktop</code>.</p>
<p>Kiwix is barely useful for fast Internet connection, but for some corner cases it can be extremely
important.</p>

  <div class="post-date">
    <a href="../notes/1665269268/"><time datetime="2022-10-08T22:47:48Z">Oct 8, 2022 22:47</time></a>
  </div>
</article><article class="post">
  <p>Today I&rsquo;ve discovered <a href="https://www.redhat.com/en/command-line-heroes">Command Line Heroes</a> — the
podcast from RedHat. It tells stories about different tech fields like security, programming
languages or open source. It&rsquo;s more like an audio book than a radio show. I think it&rsquo;s worth
listening.</p>

  <div class="post-date">
    <a href="../notes/1664982645/"><time datetime="2022-10-05T15:10:45Z">Oct 5, 2022 15:10</time></a>
  </div>
</article><article class="post">
  <p>Found <a href="https://chat.stackoverflow.com">chat.stackoverflow.com</a>. Stackoverflow had reinvented IRC.</p>

  <div class="post-date">
    <a href="../notes/1664972966/"><time datetime="2022-10-05T12:29:26Z">Oct 5, 2022 12:29</time></a>
  </div>
</article><article class="post">
  <p>When you need to transfer Git repo, e.g. send it by email, it&rsquo;s possible to use <a href="https://git-scm.com/docs/git-bundle">git
bundle</a>. Create <code>.bundle</code> file with <code>git bundle create my-repo.bundle master</code>, send it, and then extract data with <code>git checkout my-repo.bundle my-repo</code>.</p>

  <div class="post-date">
    <a href="../notes/1664551116/"><time datetime="2022-09-30T15:18:37Z">Sep 30, 2022 15:18</time></a>
  </div>
</article><article class="post">
  <p>Also, there is <a href="https://www.reddit.com/r/embedded/comments/drbot7/programming_stm32_on_a_linux_environment_without/">a Reddit
thread</a>
about development environments for STM32 on Linux. So if you think STM32CubeIDE is not your choice,
you&rsquo;d better look at this discussion.</p>

  <div class="post-date">
    <a href="../notes/1663436755/"><time datetime="2022-09-17T17:45:55Z">Sep 17, 2022 17:45</time></a>
  </div>
</article><article class="post">
  <p>Found <a href="https://gitlab.com/stm32mcu/wiki/-/wikis/home">a nice wiki page about STM32 Development
tools</a>. There are some interesting alternatives to
the STM32CubeIDE. It&rsquo;s worth reading.</p>

  <div class="post-date">
    <a href="../notes/1663435954/"><time datetime="2022-09-17T17:32:34Z">Sep 17, 2022 17:32</time></a>
  </div>
</article><article class="post">
  <p>Talking about Linux Kernel on Ubuntu 20.04 Server: found that it&rsquo;s possible to install 5.15 LTS
manually using <code>sudo apt install --install-recommends linux-generic-hwe-20.04</code>. Looks reasonable:
for server installations it may be dangerous to perform such updates automatically.</p>

  <div class="post-date">
    <a href="../notes/1662243994/"><time datetime="2022-09-03T22:26:34Z">Sep 3, 2022 22:26</time></a>
  </div>
</article><article class="post">
  <p>Switched from Adobe Acrobat Reader to <a href="https://www.sumatrapdfreader.org/free-pdf-reader">Sumatra
PDF</a> for viewing PDFs on my Windows machine. It&rsquo;s
a lot smaller, faster and the source code is <a href="https://github.com/sumatrapdfreader/sumatrapdf">available on
GitHub</a>.</p>

  <div class="post-date">
    <a href="../notes/1662226606/"><time datetime="2022-09-03T17:36:47Z">Sep 3, 2022 17:36</time></a>
  </div>
</article><article class="post">
  <p>I always thought that PNG is a file format for static images, but today I was searching for a new
emoji for Slack and found an animated image with <code>.png</code> extension. Surprisingly, there is an
<a href="https://en.wikipedia.org/wiki/APNG">Animated Portable Network graphics</a> (APNG) file format, and
it&rsquo;s supported by the most of the modern web browsers.</p>

  <div class="post-date">
    <a href="../notes/1661450929/"><time datetime="2022-08-25T18:08:49Z">Aug 25, 2022 18:08</time></a>
  </div>
</article><article class="post">
  <p>Actually, the previous message is correct for desktop version only: Ubuntu Server 20.04 uses Linux
kernel 5.4.0.</p>

  <div class="post-date">
    <a href="../notes/1661425714/"><time datetime="2022-08-25T11:08:34Z">Aug 25, 2022 11:08</time></a>
  </div>
</article><article class="post">
  <p>Found that Ubuntu 20.04.4 and Ubuntu 22.04.1 have the same kernel 5.15.0. I thought that 22.04
should have a later version, like 5.19.3.</p>

  <div class="post-date">
    <a href="../notes/1661281240/"><time datetime="2022-08-23T19:00:40Z">Aug 23, 2022 19:00</time></a>
  </div>
</article><article class="post">
  <p>After updating to Kubuntu 22.04 my OpenVPN stop working with an error like:</p>
<pre tabindex="0"><code>OpenSSL: error:0A00018E:SSL routines::ca md too weak
Cannot load inline certificate file
Exiting due to fatal error
</code></pre><p>The correct way to solve this issue is certificate regeneration, but I do not control the server. So
the temporary solution is to add the line <code>tls-cipher &quot;DEFAULT:@SECLEVEL=0&quot;</code> into <code>ovpn</code> config
file. It allows OpenVPN to use weak tls cipher, so the connection starts as usual.</p>

  <div class="post-date">
    <a href="../notes/1660623217/"><time datetime="2022-08-16T04:13:37Z">Aug 16, 2022 04:13</time></a>
  </div>
</article><article class="post">
  <p>Found <a href="https://daniel.haxx.se/blog/2018/04/05/curl-another-host/">an interesting article</a> about
curl&rsquo;s options for connecting to the different host. Most of the time I&rsquo;d changed <code>Host</code> HTTP
header, and it was enough for my cases, but today I&rsquo;ve realized that this solution is not acceptable
when for HTTPS resources. Here, I need to specify the host name during SSL connection negotiation,
so I can&rsquo;t use HTTP headers. There is an <a href="https://en.wikipedia.org/wiki/Server_Name_Indication">SNI
field</a> that allows to tell the server which
host I want to access. Curl uses URL to prepare SNI field value: for command <code>curl https://example.com/foo</code> SNI value is <code>example.com</code> and when I set <code>Host</code> header, it does not affect
SNI at all. To change SNI the <a href="https://curl.se/docs/manpage.html#--resolve">&ndash;resolve</a> option can be
used:</p>
<pre tabindex="0"><code>curl --resolve example.com:443:127.0.0.1 https://example.com/
</code></pre><p>The command above populates curl’s DNS cache with a custom entry for the host name <code>example.com</code> and
port <code>443</code> with the address <code>127.0.0.1</code>. That is why curl will use specified IP address to start TCP
connection and then use <code>example.com</code> for SNI field.</p>

  <div class="post-date">
    <a href="../notes/1660460219/"><time datetime="2022-08-14T06:56:59Z">Aug 14, 2022 06:56</time></a>
  </div>
</article><article class="post">
  <p>And one more useful Vim command: to make my markdown files easy to read, I limit the line width with
100 chars and highlight longer lines:</p>
<pre tabindex="0"><code>set tw=100
2mat ErrorMsg &#39;\%101v.&#39;
</code></pre><p>The editor split lines automatically as I type, but if I add some text in the middle of the line, I
have to select a paragraph with <code>vap</code> command and reformat it with <code>gq</code>.</p>

  <div class="post-date">
    <a href="../notes/1660420739/"><time datetime="2022-08-13T19:58:59Z">Aug 13, 2022 19:58</time></a>
  </div>
</article><article class="post">
  <p>I write articles and docs using Vim. It&rsquo;s convenient when the editor can check spelling on the fly,
so I can fix mistakes as soon as possible. Sometimes I use different languages in one file and I
want the editor to find spelling issues for all languages in it. It&rsquo;s possible to set multiple
languages for spell check in Vim with a command like <code>:set spelllang=en_us,de_de</code>, so the editor
will use several dictionaries. I prefer to underline incorrect works with <code>:hi SpellBad cterm=underline</code>.</p>

  <div class="post-date">
    <a href="../notes/1660420024/"><time datetime="2022-08-13T19:47:04Z">Aug 13, 2022 19:47</time></a>
  </div>
</article><article class="post">
  <p>I work on several projects. Each of them require a VPN connection. Sometimes, I work from remote
locations and I need to access my home network. It&rsquo;s one more VPN connection. It&rsquo;s convenient to
have an ability to access different private networks at the same time. Let&rsquo;s discuss the issues of
multi-VPN setups and possible.</p>
<p>TL;DR:</p>
<ol>
<li>Use NetworkManager to manage VPN connections.</li>
<li>Disable systemd-resolved.</li>
<li>Use dnsmasq to process DNS requests.</li>
</ol>
<p>The most common commercial VPN I&rsquo;d encountered is Cisco AnyConnect. For my personal projects, I use
WireGuard. When I need to access my home network, I have an OpenVPN server on my router. It&rsquo;s an
interesting task to make all these connections work at the same time without conflicts.</p>
<p>Each VPN connection has routes and DNS configurations. AnyConnect and OpenVPN push routes and DNS to
the client during the connection startup and WireGuard has a static setup in the config file. Some
VPN setups provide a lot of routes or even try to route all client&rsquo;s traffic though the VPN
connection. It&rsquo;s useful when working from untrusted location like cafe, hotel or airport and there
are a lot of free and commercial VPN solutions that work this way. But when there are several active
VPN connections, this behavior can cause different issues.</p>
<p>Most corporate networks have private DNS servers with addresses of internal resources like an issue
tracker, a source code repository or a monitoring system. VPN connection changes the system DNS
settings, so it&rsquo;s possible to resolve private domains and to access internal resources. Most of the
time, the operating system works with only one DNS server or several servers that work identically.
This scheme does not work for a multi-VPN setup, because it&rsquo;s required to process different domains
in different ways. That is why an addition configuration is required.</p>
<p>The main idea of multi-VPN setup is to restrict routes for each connection and to configure
different DNS servers for different domains.</p>
<p>There is an official
<a href="https://www.cisco.com/c/en/us/support/docs/smb/routers/cisco-rv-series-small-business-routers/Kmgmt-785-AnyConnect-Linux-Ubuntu.html">Cisco AnyConnect</a>
utility for Linux, but I prefer to use <a href="https://www.infradead.org/openconnect/">OpenConnect</a>. It
allows to change routes that the client receives from the server and seamlessly integrates with
NetworkManager, so I can manage all my network connections in one place.</p>
<p>OpenConnect command looks like <code>sudo openconnect vpn.example.com</code>. It asks username and password and
then creates a connection. To stop this connection, <code>Ctrl-C</code> can be used. OpenConnect executes
<code>vpnc-script</code> when the connection starts to set the routing and name service up. On Kubuntu 22.04,
the location of this script is <code>/usr/share/vpnc-scripts/vpnc-script</code>. The default script accepts all
routes and DNS settings from the server. The script can be redefined with <code>--script</code> option. From
<a href="https://unix.stackexchange.com/questions/220380/openconnect-setting-default-routes">the Stack Exchange post</a>
I&rsquo;d found the way to create a wrapper for the default script that restricts the routes for the
connection, but there is an easier way to solve this problem —
<a href="https://github.com/dlenski/vpn-slice">vpn-slice</a>. Assume I want to route only <code>10.0.8.0/24</code> network
through the VPN connection. It can be achieved this way:</p>
<pre tabindex="0"><code>sudo openconnect vpn.example.com --script &#39;vpn-slice 10.0.8.0/24&#39;
</code></pre><p>Any additional routes or DNS config will be ignored.</p>
<p>For the WireGuard the configuration looks like:</p>
<pre tabindex="0"><code>[Interface]
PrivateKey = client-private-key
Address = 10.0.8.2/32 # IP address of the client in the VPN network
DNS = 10.0.8.5

[Peer]
PublicKey = remote-public-key
AllowedIPs = 10.0.8.0/24
Endpoint = 1.2.3.4:12345 # Public address of VPN server
</code></pre><p>It&rsquo;s easy to restrict routes by editing the value of the <code>AllowedIPs</code> option. Just remove
unnecessary networks. <code>DNS</code> option makes WireGuard to change the system DNS server on the connection
startup. For multi-VPN setup, It&rsquo;s better to remove this option and configure domain name resolution
manually in a different way.</p>
<p>For the OpenVPN connection, use <code>route-nopull</code> option to restrict routes. It says that the client
should ignore routes from the server, so it&rsquo;s possible to define all required routes in the client&rsquo;s
config file:</p>
<pre tabindex="0"><code>route 10.0.8.0 255.255.255.0
route-nopull
</code></pre><p>I prefer to manage all my VPN connections through the NetworkManager GUI. First, I install the
packages:</p>
<pre tabindex="0"><code>sudo apt install network-manager-openconnect network-manager-openvpn
</code></pre><p>OpenConnect connection has a few settings, so it&rsquo;s easy to create and configure new connection
through the network settings GUI of Gnome or KDE. In the IPv4 section choose
<code>Automatic (Only addresses)</code> option, press <code>Routes</code> button, configure necessary networks and select
<code>Ignore automatically obtained routes</code> checkbox.</p>
<p><img src="../working-with-multiple-vpns/vpn-config.png" alt="vpn config"></p>
<p>It&rsquo;s difficult to configure OpenVPN through the GUI because there are a lot of different settings.
That is why I prefer to import the connection config to the NetworkManager with
<code>nmcli connection import type openvpn file home.ovpn</code> where <code>home.ovpn</code> is a connection config file
name.</p>
<p>For the WireGuard I import a connection with a command
<code>nmcli connection import type wireguard file wg0.conf</code> where <code>wg0.conf</code> is a name of a config file.
After the import, connection activates automatically. To turn the WireGuard VPN off, use the command
<code>nmcli connection down wg0</code>. It is also possible to control WireGuard connection through KDE GUI.
There is no support for WireGuard in a Gnome NetworkManager GUI (here is a
<a href="https://gitlab.gnome.org/GNOME/gnome-control-center/-/issues/982">ticket in the Gnome&rsquo;s GitLab</a>)
but it is always possible to use <code>nm-connection-editor</code> as a workaround.</p>
<p>To solve the DNS problem, I execute such steps:</p>
<ol>
<li>Disable <code>systemd-resolved</code>.</li>
<li>Install <code>dnsmasq</code>.</li>
<li>Configure different forwarders for different domains.</li>
<li>Make <code>dnsmasq</code> the system resolver.</li>
</ol>
<p><a href="https://www.freedesktop.org/software/systemd/man/systemd-resolved.service.html">systemd-resolved</a>
is a part of systemd that provides network name resolution,
<a href="https://en.wikipedia.org/wiki/Link-Local_Multicast_Name_Resolution">LLMNR</a> and MulticastDNS
resolver and responder. It can be used as a network service and through a
<a href="https://www.freedesktop.org/wiki/Software/dbus/">D-Bus</a> API. The most applications use only basic
feature of DNS resolution so it&rsquo;s safe to disable <code>systemd-resolved</code>. I tried to set different DNS
servers for different domains with <code>systemd-resolved</code>, but it&rsquo;s a too hard task. From the
<a href="https://gist.github.com/brasey/fa2277a6d7242cdf4e4b7c720d42b567">discussion on GitHub</a>, I&rsquo;d found
that it&rsquo;s possible, but the configuration is obscure and it makes more troubles than solves. So I&rsquo;d
disabled <code>systemd-resolved</code> and switched to the dnsmasq. To disable <code>systemd-resolved</code> in the config
<code>/etc/NetworkManager/NetworkManager.conf</code> add <code>dns=none</code> to the <code>[main]</code> section and execute the
following commands:</p>
<pre tabindex="0"><code>systemctl stop systemd-resolved
systemctl disable systemd-resolved
rm /etc/resolv.conf
systemctl restart NetworkManager
</code></pre><p><a href="https://en.wikipedia.org/wiki/Dnsmasq">dnsmasq</a> is a DNS forwarder that can be used as a local DNS
server. It does not host DNS zones itself, but only forwards requests to the configured servers.
Install dnsmasq with <code>apt install dnsmasq</code> and add such lines to the <code>/etc/dnsmasq.conf</code>:</p>
<pre tabindex="0"><code># Do not use or poll /etc/resolv.conf
no-resolv
no-poll

# Expose dns server for the local machine only
interface=lo

# Disable DNS cache, so there will be less issues if DNS server
# of the VPN connection returns different domains for external
# and internal clients.
cache-size=0
no-negcache

# Set one DNS forwarder for first domain
server=/example1.com/1.2.3.4

# Set another DNS forwarder for second domain
server=/example2.com/5.6.7.8

# Set default DNS forwarder
server=8.8.8.8
</code></pre><p>Start the server:</p>
<pre tabindex="0"><code>systemctl start dnsmasq
systemctl enable dnsmasq
</code></pre><p>Set dnsmasq as a system resolver in <code>/etc/resolv.conf</code>:</p>
<pre tabindex="0"><code>nameserver 127.0.0.1
</code></pre><p>Such setup allows me to work simultaneously with several projects in different private networks,
resolve domain names correctly and send only required traffic to the particular VPN connection.</p>
  <div class="post-date">
    <a href="../posts/working-with-multiple-vpns/"><time datetime="2022-08-04T18:00:00Z">Aug 4, 2022 18:00</time></a>
  </div>
</article><article class="post">
  <p><strong>Update for the previous message</strong>: A moment ago I&rsquo;ve realized that Ubuntu apt repo contains grip
<code>4.2.0</code>. It&rsquo;s an old version that generates strange pages. The best decision was to switch from an
old <code>apt</code> version to the grip <code>4.6.1</code> from PyPi. It can be installed with such a command:
<code>pip3 install --user grip</code>. Now the page looks great with no additional options in the config file.</p>

  <div class="post-date">
    <a href="../notes/1659500215/"><time datetime="2022-08-03T04:16:55Z">Aug 3, 2022 04:16</time></a>
  </div>
</article><article class="post">
  <p>I use <a href="https://github.com/joeyespo/grip">grip</a> to preview markdown documents locally. To make the
generated page looks like README on GitHub add such line into <code>~/.grip/settings.py</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>STYLE_URLS <span style="color:#719e07">=</span> [<span style="color:#2aa198">&#39;https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.1.0/github-markdown.min.css&#39;</span>]
</span></span></code></pre></div><p>It&rsquo;s a CDN URL for <a href="https://github.com/sindresorhus/github-markdown-css">github-markdown-css</a>. This
library is a minimal amount of CSS to replicate the GitHub Markdown style.</p>

  <div class="post-date">
    <a href="../notes/1659498630/"><time datetime="2022-08-03T03:50:30Z">Aug 3, 2022 03:50</time></a>
  </div>
</article><article class="post">
  <p>Found an outstanding <a href="https://github.com/xolox/vim-notes">notes.vim</a> plugin for Vim. It allows to
write some notes with basic formatting and navigation. The syntax highlighting of the source code
can be useful for notes of software developers.</p>

  <div class="post-date">
    <a href="../notes/1659290553/"><time datetime="2022-07-31T18:02:33Z">Jul 31, 2022 18:02</time></a>
  </div>
</article><article class="post">
  <p>Useful tip: it&rsquo;s possible to execute some code on the Vim&rsquo;s startup with <code>-c</code> argument. I use it to
prepare Vim for blog post editing like this: <code>vim -c 'call ConfigDoc()' post.md</code>. I don&rsquo;t want to
add this function call into <code>.vimrc</code> for all <code>.md</code> files, because there are a lot of different
markdown files that do not require this configuration. So command line argument does the trick.</p>

  <div class="post-date">
    <a href="../notes/1659288194/"><time datetime="2022-07-31T17:23:14Z">Jul 31, 2022 17:23</time></a>
  </div>
</article><article class="post">
  <p>I tried to download a file with curl on Oracle Linux 8 and got an error:
<code>routines:ssl_choose_client_version:unsupported protocol</code>. It&rsquo;s an old host and I have no access to
upgrade the software. So I had to relax my encryption settings with
<code>update-crypto-policies --set LEGACY</code>. It&rsquo;s not the best way to solve this issue, but if you need to
download a file and you don&rsquo;t have any other options, it is worth doing.</p>

  <div class="post-date">
    <a href="../notes/1657969466/"><time datetime="2022-07-16T11:04:26Z">Jul 16, 2022 11:04</time></a>
  </div>
</article><article class="post">
  <p>The easiest way to find Ubuntu installation date is checking the installer&rsquo;s directory:
<code>ls -lt /var/log/installer</code>.</p>

  <div class="post-date">
    <a href="../notes/1657799440/"><time datetime="2022-07-14T11:50:40Z">Jul 14, 2022 11:50</time></a>
  </div>
</article><article class="post">
  <p>Sometimes I need to test new software or prepare isolated stands. I use
<a href="https://www.virtualbox.org/">VirtualBox</a> for these tasks. I want to access VMs from the host PC and
the easiest way to achieve this is by using bridged network adapters. Unfortunately, VM with a
bridged network is exposed not only to the host but also to all machines in the network. VM relies
on the router DHCP. It&rsquo;s can be unacceptable for some locations.</p>
<p>Today I&rsquo;ve found
<a href="https://www.xmodulo.com/access-nat-guest-from-host-virtualbox.html">how to access a NAT guest from host</a>,
so I can forward VM&rsquo;s port to the host and do not expose the VM for the entire network.</p>

  <div class="post-date">
    <a href="../notes/1657717546/"><time datetime="2022-07-13T13:05:46Z">Jul 13, 2022 13:05</time></a>
  </div>
</article><article class="post">
  <p>Found <a href="https://www.youtube.com/watch?v=uqY3FMuMuRo">an outstanding video about VGA signal</a>. Ben
Eater explains what VGA display actually does when it receives an input, how it processes this input
to display pixels on the screen and how to make a circuit using primitive ICs that can generate such
signal for the display.</p>

  <div class="post-date">
    <a href="../notes/1657695928/"><time datetime="2022-07-13T07:05:28Z">Jul 13, 2022 07:05</time></a>
  </div>
</article><article class="post">
  <p>I have several devices that I use every day: PC, laptop and phone. I want to share some notes
between them, but I don&rsquo;t want to use cloud solutions like Google Docs. So today I&rsquo;ve installed
<a href="https://js.wiki/">Wiki.js</a> instance on my Ubuntu server. It works fast, uses a few resources on my
workloads and has a lot of useful docs.</p>

  <div class="post-date">
    <a href="../notes/1657608401/"><time datetime="2022-07-12T06:46:41Z">Jul 12, 2022 06:46</time></a>
  </div>
</article><article class="post">
  <p><a href="https://sssd.io/troubleshooting/sudo.html">This article</a> about sudo rules troubleshooting helped me
a lot with FreeIPA configuration. It was difficult to understand what was going on before I turn
debug logs of the SSSD on.</p>

  <div class="post-date">
    <a href="../notes/1657109836/"><time datetime="2022-07-06T12:17:16Z">Jul 6, 2022 12:17</time></a>
  </div>
</article><article class="post">
  <p>Vim 9.0 <a href="https://www.vim.org/vim90.php">had been released</a> several days ago. I started using Vim
when the latest version was 6.4. The modes idea and navigation with j, k, k and l keys were
unfamiliar to me and I&rsquo;d spent a lot of time to get used to it. Now it&rsquo;s something natural, so
sometimes it&rsquo;s difficult to use mainstream editors without Vim features. The most annoying thing
with Vim 6.4 was the lack of editor tabs. I knew that there were
<a href="https://vim.fandom.com/wiki/Buffers">buffers</a>, but I did not like it. That is why I was extremely
happy when Vim 7, with tabs support, was released. I rarely use this feature nowadays. What a twist
of fate.</p>

  <div class="post-date">
    <a href="../notes/1656760056/"><time datetime="2022-07-02T11:07:36Z">Jul 2, 2022 11:07</time></a>
  </div>
</article><article class="post">
  <p>One task that I perform these days is the configuration of the FreeIPA domain. Sometimes it&rsquo;s not
trivial, so I need to debug some sort of quirky errors from time to time. Today I&rsquo;d found
<a href="https://thomascfoulds.com/">Thomas C. Foulds&rsquo;s blog</a> that contains a lot of useful information
about FreeIPA debugging. It&rsquo;s definitely worth reading.</p>

  <div class="post-date">
    <a href="../notes/1656743408/"><time datetime="2022-07-02T06:30:08Z">Jul 2, 2022 06:30</time></a>
  </div>
</article><article class="post">
  <p>It&rsquo;s possible to connect to a remote host over SSH using a public key. It&rsquo;s a well-known feature
which I use every day. SSH protocol is also used for the <code>git clone</code> command. I was curious about
how Gitea implements the support of the SSH protocol. The first idea was about the custom SSH
server.  I&rsquo;d inspected my local Gitea installation and found that there was no custom SSH server
running, just the default <code>sshd</code>. Surprisingly, when I performed the command <code>ssh git@gitea</code> I got
the message:</p>
<blockquote>
<p>Hi there, &lt;username&gt;! You&rsquo;ve successfully authenticated with the key named &lt;key name&gt;, but Gitea
does not provide shell access. If this is unexpected, please log in with password and setup Gitea
under another user.</p>
</blockquote>
<p>I&rsquo;d looked at the source code of the Gitea and found
<a href="https://github.com/go-gitea/gitea/blob/1d04e8641d4abab6ce978bc2dc5523c2ddb2f628/cmd/serv.go#L140">serv.go</a>.
This module allows to perform <code>git clone</code> over SSH, but who calls it? I looked at the
<code>.ssh/authorized_keys</code> file in the Gitea home directory and get such a line:</p>
<pre tabindex="0"><code>command=&#34;/usr/local/bin/gitea --config=/etc/gitea/app.ini serv key-1&#34;,... ssh-rsa ...
</code></pre><p><code>man authorized_keys</code> explains that <code>command</code> option specifies the command is executed instead of
the default shell. So when I write <code>git clone</code> git starts SSH connection and OpenSSH server checks
my key and if it&rsquo;s OK starts Gitea <code>serv</code> module.</p>
<p>This OpenSSH feature allows to restrict certain public keys to perform just a specific operation.
E.g. I can create a key and specify the command that calculates some server statistics. So if this
key is compromised, the intruder can get only server statistics but can&rsquo;t execute arbitrary code.</p>
<p>There are a lot more options for the <code>authorized_keys</code> file. I think the man page is worth reading.
I got a lot of new info about the utility I use for a long time.</p>

  <div class="post-date">
    <a href="../notes/1654367223/"><time datetime="2022-06-04T18:27:03Z">Jun 4, 2022 18:27</time></a>
  </div>
</article><article class="post">
  <p>Ubuntu 22.04 distributes Firefox as a snap package. It starts slower than Firefox installed as a
deb-package and it&rsquo;s difficult to control updates of the browser. It&rsquo;s possible to install Firefox
as a deb package from <a href="https://launchpad.net/~mozillateam/+archive/ubuntu/ppa">Mozilla Team PPA</a>.
There is a
<a href="https://www.omgubuntu.co.uk/2022/04/how-to-install-firefox-deb-apt-ubuntu-22-04">useful guide from omgubuntu.co.uk</a>
about how to configure the system to use this PPA.</p>

  <div class="post-date">
    <a href="../notes/1653742728/"><time datetime="2022-05-28T12:58:48Z">May 28, 2022 12:58</time></a>
  </div>
</article><article class="post">
  <p>Most of <a href="https://en.wikipedia.org/wiki/RPM_Package_Manager">RPM</a>-based Linux distributions use
frontends like <a href="https://en.wikipedia.org/wiki/Yum_(software)">yum</a> or
<a href="https://en.wikipedia.org/wiki/DNF_(software)">dnf</a>. Most of
<a href="https://en.wikipedia.org/wiki/Deb_(file_format)">deb</a>-based Linux distributions use apt-get,
aptitude or apt. Surprisingly, there is an <a href="https://en.wikipedia.org/wiki/APT-RPM">APT-RPM</a> package
manager — a version of apt-get modified to work with RPM.</p>

  <div class="post-date">
    <a href="../notes/1652165698/"><time datetime="2022-05-10T06:54:58Z">May 10, 2022 06:54</time></a>
  </div>
</article><article class="post">
  <p><a href="https://bugs.launchpad.net/ubuntu/+source/gnome-control-center/+bug/1778190">Annoying bug</a>: it&rsquo;s
impossible to add a route without a gateway in NetworkManager GUI in Ubuntu 20.04. Fortunately,
there is a workaround: use <code>0.0.0.0</code> as a gateway.</p>

  <div class="post-date">
    <a href="../notes/1651653237/"><time datetime="2022-05-04T08:33:57Z">May 4, 2022 08:33</time></a>
  </div>
</article><article class="post">
  <p>Systemd allows to pass a single argument to a service. This feature is called
<a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html#Service%20Templates">Service Templates</a>.
It can be used for such applications as
<a href="https://community.openvpn.net/openvpn/wiki/Systemd">OpenVPN</a> (the argument is a connection config
name) or PostgreSQL (the argument is a cluster version).</p>

  <div class="post-date">
    <a href="../notes/1651607294/"><time datetime="2022-05-03T19:48:14Z">May 3, 2022 19:48</time></a>
  </div>
</article><article class="post">
  <p>Kubuntu 22.04 has libssl 3.0.2, that is not compatible with libssl from old releases, so Viber
messenger is not working. It shows an error message &ldquo;No Connection&rdquo; even the other network apps like
Firefox work well. I think this bug will be fixed in future Viber versions. For now, it&rsquo;s possible
to perform a hotfix:</p>
<p>Install libssl 1.2.1 from Ubuntu 21.10:</p>
<pre tabindex="0"><code>wget http://security.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1l-1ubuntu1.2_amd64.deb
sudo dpkg -i libssl1.1_1.1.1l-1ubuntu1.2_amd64.deb
</code></pre><p>Preload libssl 1.2.1 into Viber. Replace line that contains <code>Exec</code> instruction in
<code>/usr/share/applications/viber.desktop</code> with this:</p>
<pre tabindex="0"><code>Exec=LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libssl.so /opt/viber/Viber %u
</code></pre>
  <div class="post-date">
    <a href="../notes/1650723317/"><time datetime="2022-04-23T14:15:17Z">Apr 23, 2022 14:15</time></a>
  </div>
</article><article class="post">
  <p>I&rsquo;ve just updated from Kubuntu 21.04 to Kubuntu 22.04 on my laptop. From the
<a href="https://wiki.ubuntu.com/JammyJellyfish/ReleaseNotes/Kubuntu">release notes</a> I found no breaking
changes, but only minor updates for different programs. Everything works as expected.</p>

  <div class="post-date">
    <a href="../notes/1650661745/"><time datetime="2022-04-22T21:09:05Z">Apr 22, 2022 21:09</time></a>
  </div>
</article><article class="post">
  <p>It&rsquo;s convenient to monitor network activity in the terminal. There are several tools for this task:
bmon, slurm or tcptrack. I prefer to use slurm.</p>

  <div class="post-date">
    <a href="../notes/1650613842/"><time datetime="2022-04-22T07:50:42Z">Apr 22, 2022 07:50</time></a>
  </div>
</article><article class="post">
  <p>Some people prefer to use self-hosting services instead of consuming from SaaSS providers. It&rsquo;s
useful to look through the
<a href="https://github.com/awesome-selfhosted/awesome-selfhosted">comprehensive list</a> of different software
which can be hosted on your own server.</p>

  <div class="post-date">
    <a href="../notes/1650372413/"><time datetime="2022-04-19T12:46:53Z">Apr 19, 2022 12:46</time></a>
  </div>
</article><article class="post">
  <p><a href="https://hackaday.com/2020/06/24/whats-the-deal-with-snap-packages/">What’s The Deal With Snap Packages?</a>
Snap package system offers a controversial approach for managing software. It&rsquo;s definitely not a
silver bullet. Two years ago I wrote
<a href="https://0e39bf7b.blog/posts/ubuntu-snap-the-price-of-the-isolation/">an article</a> with such a point
of view and today I&rsquo;ve found an article that shares my point of view in some way. It&rsquo;s definitely
worth reading. I think the user should control the system and package manager should allow to do it.</p>

  <div class="post-date">
    <a href="../notes/1650186560/"><time datetime="2022-04-17T09:09:20Z">Apr 17, 2022 09:09</time></a>
  </div>
</article><article class="post">
  <p><a href="https://kernelnewbies.org">KernelNewbies</a> is an extremely useful resource for those who want to
explore kernel changes but yet not ready for reading <a href="https://lkml.org/">lkml</a>.</p>

  <div class="post-date">
    <a href="../notes/1650184950/"><time datetime="2022-04-17T08:42:30Z">Apr 17, 2022 08:42</time></a>
  </div>
</article><article class="post">
  <p>From time to time I have to check my disk usage. It&rsquo;s possible to use <code>df</code> and <code>du</code> for rough
estimate, but it&rsquo;s more convenient to have some UI for further analysis. I prefer to use <code>ncdu</code>.
Some other tools are described in the
<a href="https://www.makeuseof.com/tag/how-to-analyze-your-disk-usage-pattern-in-linux/">article</a>.</p>

  <div class="post-date">
    <a href="../notes/1649939747/"><time datetime="2022-04-14T12:35:48Z">Apr 14, 2022 12:35</time></a>
  </div>
</article><article class="post">
  <p><a href="https://github.com/evilsocket/opensnitch">OpenSnitch</a> is a GNU/Linux port of the Little Snitch
application firewall. Tried it today on Kubuntu 21.04. It works as expected, so if you got used to
Little Snitch on MacOS and switched to Linux you should definitely give it a chance.</p>

  <div class="post-date">
    <a href="../notes/1649006347/"><time datetime="2022-04-03T17:19:07Z">Apr 3, 2022 17:19</time></a>
  </div>
</article><article class="post">
  <p>Looked at <a href="https://gitea.io/en-us/">Gitea</a> as a self-hosted alternative for GitHub. It looks nice: a
lot of useful features like global code search and template repositories. There is a
<a href="https://docs.gitea.io/en-us/comparison/">comprehensive comparison</a> of Gitea to other Git hosting
solutions. It can help decide if Gitea is suited for your needs or not.</p>
<p>The only thing that surprised me a bit: the
<a href="https://docs.gitea.io/en-us/packages/overview/">information about package registry</a> is already in
the official docs, but <a href="https://github.com/go-gitea/gitea/pull/16510">PR with this feature</a> was
merged only several days ago, so it will be available only in v1.17.0. The most recent release for
now is <a href="https://github.com/go-gitea/gitea/releases/tag/v1.16.5">v1.16.5</a>.</p>

  <div class="post-date">
    <a href="../notes/1648910196/"><time datetime="2022-04-02T14:36:36Z">Apr 2, 2022 14:36</time></a>
  </div>
</article><article class="post">
  <p>Surprisingly found that Linux has multiple routing tables and set of rules that tell the kernel how
to choose the particular table for each packet. There are an
<a href="https://ro-che.info/articles/2021-02-27-linux-routing">article</a> and a
<a href="https://www.reddit.com/r/WireGuard/comments/m8jwnt/i_dont_understand_how_wgquick_adds_routes/">reddit discussion</a>
explaining this subject.</p>

  <div class="post-date">
    <a href="../notes/1648796908/"><time datetime="2022-04-01T07:08:28Z">Apr 1, 2022 07:08</time></a>
  </div>
</article><article class="post">
  <p>Today I&rsquo;ve created a test stand that consisted of several Debian VMs to learn some basic network
management and firewall and VPN configuration. It looks astonishing. My primary job is writing
software, that is why I configure Linux networks rarely, and it&rsquo;s a bit complicated for me. Maybe a
bit later I&rsquo;ll write an article about all this stuff.</p>

  <div class="post-date">
    <a href="../notes/1648670838/"><time datetime="2022-03-30T20:07:18Z">Mar 30, 2022 20:07</time></a>
  </div>
</article><article class="post">
  <p><a href="https://www.youtube.com/watch?v=IGehmL66uVw">Really awesome video</a> about hacking the Nintendo Game
&amp; Watch. It uses STM32 locked processor and AES-CTR encrypted flash, but it had not helped, and the
console was hacked one day before release.</p>

  <div class="post-date">
    <a href="../notes/1646983221/"><time datetime="2022-03-11T07:20:21Z">Mar 11, 2022 07:20</time></a>
  </div>
</article><article class="post">
  <p>I&rsquo;d used CentOS as a production environment for working projects. Some time ago Red Hat announced
its plans to replace stable CentOS 8 with rolling release
<a href="https://www.centos.org/centos-stream/">CentOS Stream</a>. So, CentOS had been replaced with
<a href="https://www.oracle.com/linux/">Oracle Linux</a>. Today I&rsquo;ve found that Oracle has its own Linux kernel
build that is called
<a href="https://docs.oracle.com/en/operating-systems/uek/">Unbreakable Enterprise Kernel</a>. They add some
features like <a href="https://en.wikipedia.org/wiki/Ksplice">Ksplice</a> that look interesting for high-load
enterprise platforms.</p>

  <div class="post-date">
    <a href="../notes/1646669969/"><time datetime="2022-03-07T16:19:29Z">Mar 7, 2022 16:19</time></a>
  </div>
</article><article class="post">
  <p>Unexpectedly discovered a lot of paid proprietary apps in <a href="https://snapcraft.io">snapcraft</a>. I think
it&rsquo;s great because Linux users and developers have more choices.</p>

  <div class="post-date">
    <a href="../notes/1645598791/"><time datetime="2022-02-23T06:46:31Z">Feb 23, 2022 06:46</time></a>
  </div>
</article><article class="post">
  <p>Do you feel like you getting old and new technologies do not excite you anymore? Do you think that
you have seen most things before? I&rsquo;ve found an
<a href="https://news.ycombinator.com/item?id=30230620">interesting discussion on Hacker News</a> about this
topic. Different people share their feelings and ways of getting through this period of life.</p>

  <div class="post-date">
    <a href="../notes/1645221056/"><time datetime="2022-02-18T21:50:56Z">Feb 18, 2022 21:50</time></a>
  </div>
</article><article class="post">
  <p>Falling down the rabbit hole of HiDPI screens and fractional scaling on Linux desktops I came across
<a href="https://www.reddit.com/r/kde/comments/lficfe/wayland_fractional_scaling_may_be_sort_of_a/">an interesting discussion on Reddit</a>.
It contains a lot of useful links that help to form an opinion on the subject.</p>
<p>I found that in the KDE X11 session fractional scaling is implemented on Qt Framework level, so each
app scales its output itself. Gnome uses a different technique. It implies rendering everything at
an integer factor and then downscaling using a raster operation. It&rsquo;s a more universal approach and
does not depend on the GUI framework, but it can lead to some sort of degradation for the font
rendering. It can be almost invisible for Apple-like retina displays with a 1.75 scale factor but
it&rsquo;s notable on the average 13&quot; - 14&quot; laptop 1080p screen.</p>
<p>I think the best way to avoid HiDPI rendering issues is using such displays that allow setting
integer scale factors like x2 on a 14&quot; screen with 2880х1800 resolution. All other techniques will
be always the compromise between GUI framework requirements, multi-screen setup support,
performance, and final picture quality.</p>

  <div class="post-date">
    <a href="../notes/1644658585/"><time datetime="2022-02-12T09:36:25Z">Feb 12, 2022 09:36</time></a>
  </div>
</article><article class="post">
  <p>The majority of GUI apps on Linux are written using some toolkit like <a href="https://www.gtk.org/">GTK</a> or
<a href="https://www.qt.io/">Qt</a>. Such libs provide high-level abstractions like buttons or labels but the
real rendering is executed on the backend like <a href="https://x.org/wiki/">X11</a> or
<a href="https://wayland.freedesktop.org/">Wayland</a>. I&rsquo;d never thought about it. Today I&rsquo;ve found that the
X11 backend uses <a href="https://www.x.org/releases/current/doc/libX11/libX11/libX11.html">Xlib</a>. To
understand what level of abstraction GUI libraries provide, you can take a look at
<a href="https://tronche.com/gui/x/xlib-tutorial/">this small tutorial</a>. After writing a Hello World with
Xlib it becomes clear for me why developers introduce more abstraction layers.</p>

  <div class="post-date">
    <a href="../notes/1644617329/"><time datetime="2022-02-11T22:08:49Z">Feb 11, 2022 22:08</time></a>
  </div>
</article><article class="post">
  <p>I&rsquo;m learning the STM32 platform. The code generation in
<a href="https://www.st.com/en/development-tools/stm32cubeide.html">STM32CubeIDE</a> makes it easier to
configure different MCU subsystems and start writing &ldquo;hello world&rdquo; apps. However, it can be
difficult to understand how all this magic works. Fortunately, there is a comprehensive explanation
in the
<a href="https://www.st.com/content/ccc/resource/technical/document/user_manual/10/c5/1a/43/3a/70/43/7d/DM00104712.pdf/files/DM00104712.pdf/jcr:content/translations/en.DM00104712.pdf">STM32CubeMX for STM32 configuration and initialization C code generation</a>
user manual in section 6.1.</p>

  <div class="post-date">
    <a href="../notes/1644078399/"><time datetime="2022-02-05T16:26:39Z">Feb 5, 2022 16:26</time></a>
  </div>
</article><article class="post">
  <p>To make L2TP/IPsec VPN client work under Kubuntu install <code>network-manager-l2tp</code> package.</p>

  <div class="post-date">
    <a href="../notes/1643143370/"><time datetime="2022-01-25T20:42:50Z">Jan 25, 2022 20:42</time></a>
  </div>
</article><article class="post">
  <p>Today I&rsquo;ve found that <a href="https://github.com/ytdl-org/youtube-dl">youtube-dl</a> downloads video too slow.
Switching to <a href="https://github.com/yt-dlp/yt-dlp">yt-dlp</a> helped: 10MiB/s instead of 50KiB/s.</p>

  <div class="post-date">
    <a href="../notes/1643060990/"><time datetime="2022-01-24T21:49:50Z">Jan 24, 2022 21:49</time></a>
  </div>
</article><article class="post">
  <p>Every computer program uses the main memory (RAM) to store data. RAM is considered to be fast
storage compared even to the fastest NVMe SSD or 100Gbit network. It seems that the RAM speed is
high enough and that is why no optimizations are required: just read or write any memory cell when
the program needs it.</p>
<p>From the famous article
<a href="https://people.freebsd.org/~lstewart/articles/cpumemory.pdf">What Every Programmer Should Know About Memory</a>,
I&rsquo;d found that memory access is more tricky than I used to think about.</p>
<p>Modern CPUs have a small amount of blazing-fast internal memory —
<a href="https://en.wikipedia.org/wiki/Processor_register">the registers</a>. There is no delay when accessing
data from the registers, <a href="https://en.wikipedia.org/wiki/Execution_unit">the functional units</a> can
operate on this data directly. Each CPU core has its own registers, so the access time does not
depend on the other cores&rsquo; load.</p>
<p>If there is no requested data in the CPU registers it should be loaded from the RAM to execute
operations on it. Accessing the RAM is 10 times slower than accessing the registers, so the CPU has
to request the data and wait a significant amount of time before it will be loaded into the
registers. Also, there is a shared bus between the RAM and CPUs, that is why if one core actively
access the RAM it can influence the accesses time for the other cores.</p>
<p>To reduce the average cost to access data from the main memory a mechanism called
<a href="https://en.wikipedia.org/wiki/CPU_cache">CPU cache</a> was introduced. It&rsquo;s a small amount of fast
on-chip memory, which stores copies of the data from the RAM. An access time to the cache is much
smaller than to the RAM. Most CPUs have a hierarchy of multiple cache levels (L1, L2, L3). Each next
level of cache is bigger but slower.</p>
<p>Data is transferred from the RAM and stored in the cache in blocks of fixed size, called cache
lines. When the CPU needs to read a location in memory, it first checks for a corresponding entry in
the cache. If the requested data is not found in the cache, a <em>cache miss</em> is occurred. A cache miss
is quite expensive because it requires not only to load new data from the memory into the cache but
also to evict one of the existing entries. That is why one of the crucial software developer&rsquo;s tasks
is organizing memory access of the program in such a way that minimizes the number of cache misses.</p>
<p>Consider the practical task. Matrix multiplication is one of the most important matrix operations.
It is used widely in such areas as machine learning or 3D graphics. For the huge matrices, the
computations can take a lot of time, so the optimization of this operation can increase the speed of
the whole program significantly.</p>
<p>The description of an algorithm can be easily found on
<a href="https://en.wikipedia.org/wiki/Matrix_multiplication">Wikipedia</a>.</p>
<p>The naive Plain C implementation looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#dc322f">void</span> <span style="color:#268bd2">matrix_multiply</span>(size_t sz, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>mul1, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>mul2, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>res) {
</span></span><span style="display:flex;"><span>  size_t i, j, k;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">for</span> (i <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; i <span style="color:#719e07">&lt;</span> sz; i<span style="color:#719e07">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">for</span> (j <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; j <span style="color:#719e07">&lt;</span> sz; j<span style="color:#719e07">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">for</span> (k <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; k <span style="color:#719e07">&lt;</span> sz; k<span style="color:#719e07">++</span>) {
</span></span><span style="display:flex;"><span>        res[i][j] <span style="color:#719e07">+=</span> mul1[i][k] <span style="color:#719e07">*</span> mul2[k][j];
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The function receives two square matrices <code>mul1</code> and <code>mul2</code> of size <code>sz x sz</code> and calculates their
multiplication into <code>res</code>. It&rsquo;s expected, that <code>res</code> is initialized by zeros.</p>
<p>Assume the matrix of size <code>1000x1000</code>. In this case, CPU cache can&rsquo;t hold an entire matrix. In the
inner loop, the elements of <code>mul1</code> are accessed sequentially, so it uses CPU cache effectively. For
the <code>mul2</code> argument, the elements are accessed more-or-less randomly. For each element of the result
matrix, 1000 random elements should be retrieved from the RAM.</p>
<p>I got such measurements on my PC:</p>
<table>
<thead>
<tr>
<th>matrix size</th>
<th>execution time in cycles</th>
</tr>
</thead>
<tbody>
<tr>
<td>100x100</td>
<td>733</td>
</tr>
<tr>
<td>300x300</td>
<td>21485</td>
</tr>
<tr>
<td>500x500</td>
<td>101610</td>
</tr>
<tr>
<td>1000x1000</td>
<td>843546</td>
</tr>
<tr>
<td>2000x2000</td>
<td>25787985</td>
</tr>
<tr>
<td>3000x3000</td>
<td>107763896</td>
</tr>
</tbody>
</table>
<p>First optimization is a <code>mul2</code> transposition:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#dc322f">void</span> <span style="color:#268bd2">matrix_multiply_t</span>(size_t sz, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>mul1, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>mul2, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>res) {
</span></span><span style="display:flex;"><span>  size_t i, j, k;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">double</span> tmp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">for</span> (i <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; i <span style="color:#719e07">&lt;</span> sz; i<span style="color:#719e07">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">for</span> (j <span style="color:#719e07">=</span> i; j <span style="color:#719e07">&lt;</span> sz; j<span style="color:#719e07">++</span>) {
</span></span><span style="display:flex;"><span>      tmp <span style="color:#719e07">=</span> mul2[i][j];
</span></span><span style="display:flex;"><span>      mul2[i][j] <span style="color:#719e07">=</span> mul2[j][i];
</span></span><span style="display:flex;"><span>      mul2[j][i] <span style="color:#719e07">=</span> tmp;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">for</span> (i <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; i <span style="color:#719e07">&lt;</span> sz; i<span style="color:#719e07">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">for</span> (j <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; j <span style="color:#719e07">&lt;</span> sz; j<span style="color:#719e07">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">for</span> (k <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; k <span style="color:#719e07">&lt;</span> sz; k<span style="color:#719e07">++</span>) {
</span></span><span style="display:flex;"><span>        res[i][j] <span style="color:#719e07">+=</span> mul1[i][k] <span style="color:#719e07">*</span> mul2[j][k];
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>After <code>mul2</code> transposition, it&rsquo;s possible to access both arguments sequentially, so CPU cache is
used effectively. The function needs some time for the transposition operation that is why the
results can be similar to naive implementation for small input matrices.</p>
<p>The function modifies <code>mul2</code> argument, that is why it can&rsquo;t be used further. It&rsquo;s possible to make a
copy of <code>mul2</code>, but in this case, the function requires additional memory, so the software developer
should decide what is the best option for the particular task.</p>
<p>The execution results:</p>
<table>
<thead>
<tr>
<th>matrix size</th>
<th>execution time (cycles)</th>
<th>relative execution time</th>
</tr>
</thead>
<tbody>
<tr>
<td>100x100</td>
<td>719</td>
<td>98.09%</td>
</tr>
<tr>
<td>300x300</td>
<td>20885</td>
<td>97.21%</td>
</tr>
<tr>
<td>500x500</td>
<td>96832</td>
<td>95.30%</td>
</tr>
<tr>
<td>1000x1000</td>
<td>788834</td>
<td>93.51%</td>
</tr>
<tr>
<td>2000x2000</td>
<td>7268999</td>
<td>28.19%</td>
</tr>
<tr>
<td>3000x3000</td>
<td>24179636</td>
<td>22.44%</td>
</tr>
</tbody>
</table>
<p>The second optimization is accessing data in such a way that utilizes CPU cache as much as possible
without matrix transposition:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#719e07">#define SM (CLS / sizeof(double))
</span></span></span><span style="display:flex;"><span><span style="color:#719e07"></span>
</span></span><span style="display:flex;"><span><span style="color:#dc322f">void</span> <span style="color:#268bd2">matrix_multiply_fast</span>(size_t sz, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>mul1, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>mul2, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>res) {
</span></span><span style="display:flex;"><span>  size_t i, i2, j, j2, k, k2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">for</span> (i <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; i <span style="color:#719e07">&lt;</span> sz; i <span style="color:#719e07">+=</span> SM) {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">for</span> (j <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; j <span style="color:#719e07">&lt;</span> sz; j <span style="color:#719e07">+=</span> SM) {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">for</span> (k <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; k <span style="color:#719e07">&lt;</span> sz; k <span style="color:#719e07">+=</span> SM) {
</span></span><span style="display:flex;"><span>        size_t i2_max <span style="color:#719e07">=</span> MIN(SM, sz <span style="color:#719e07">-</span> i);
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">for</span> (i2 <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; i2 <span style="color:#719e07">&lt;</span> i2_max; i2<span style="color:#719e07">++</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#dc322f">double</span> <span style="color:#719e07">*</span>rres <span style="color:#719e07">=</span> res[i <span style="color:#719e07">+</span> i2] <span style="color:#719e07">+</span> j;
</span></span><span style="display:flex;"><span>          <span style="color:#dc322f">double</span> <span style="color:#719e07">*</span>rmul1 <span style="color:#719e07">=</span> mul1[i <span style="color:#719e07">+</span> i2] <span style="color:#719e07">+</span> k;
</span></span><span style="display:flex;"><span>          size_t k2_max <span style="color:#719e07">=</span> MIN(SM, sz <span style="color:#719e07">-</span> k);
</span></span><span style="display:flex;"><span>          <span style="color:#719e07">for</span> (k2 <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; k2 <span style="color:#719e07">&lt;</span> k2_max; k2<span style="color:#719e07">++</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#dc322f">double</span> <span style="color:#719e07">*</span>rmul2 <span style="color:#719e07">=</span> mul2[k <span style="color:#719e07">+</span> k2] <span style="color:#719e07">+</span> j;
</span></span><span style="display:flex;"><span>            size_t j2_max <span style="color:#719e07">=</span> MIN(SM, sz <span style="color:#719e07">-</span> j);
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">for</span> (j2 <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; j2 <span style="color:#719e07">&lt;</span> j2_max; j2<span style="color:#719e07">++</span>) {
</span></span><span style="display:flex;"><span>              res[i <span style="color:#719e07">+</span> i2][j <span style="color:#719e07">+</span> j2] <span style="color:#719e07">+=</span> mul1[i <span style="color:#719e07">+</span> i2][k <span style="color:#719e07">+</span> k2] <span style="color:#719e07">*</span> mul2[j <span style="color:#719e07">+</span> j2][k <span style="color:#719e07">+</span> k2];
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The algorithm makes the same calculations as a naive implementation but in a different order. There
are six nested loops. The outer loops iterate with intervals of SM (the cache line size divided by
<code>sizeof(double)</code>). This divides the multiplication into several smaller problems which can be
handled with more cache locality. The inner loops iterate over the missing indexes of the outer
loops. <code>k2</code> and <code>j2</code> loops are in a different order because, in the actual computation, only one
expression depends on <code>k2</code> but two depend on <code>j2</code>.</p>
<p><code>CLS</code> macro is defined by the command <code>getconf LEVEL1_DCACHE_LINESIZE</code> during the compilation. This
command returns L1 cache line size, so it makes it possible for inner loops to utilize CPU cache
effectively.</p>
<p>The execution results:</p>
<table>
<thead>
<tr>
<th>matrix size</th>
<th>execution time (cycles)</th>
<th>relative execution time</th>
</tr>
</thead>
<tbody>
<tr>
<td>100x100</td>
<td>606</td>
<td>82.67%</td>
</tr>
<tr>
<td>300x300</td>
<td>15503</td>
<td>72.16%</td>
</tr>
<tr>
<td>500x500</td>
<td>72558</td>
<td>71.41%</td>
</tr>
<tr>
<td>1000x1000</td>
<td>600223</td>
<td>71.15%</td>
</tr>
<tr>
<td>2000x2000</td>
<td>5203588</td>
<td>20.18%</td>
</tr>
<tr>
<td>3000x3000</td>
<td>17501126</td>
<td>16.24%</td>
</tr>
</tbody>
</table>
<p>The most optimized version can be found in the
<a href="https://people.freebsd.org/~lstewart/articles/cpumemory.pdf">article</a> (p.50):</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#719e07">#define SM (CLS / sizeof(double))
</span></span></span><span style="display:flex;"><span><span style="color:#719e07"></span>
</span></span><span style="display:flex;"><span><span style="color:#dc322f">void</span> <span style="color:#268bd2">matrix_multiply_seq</span>(size_t sz, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>mul1, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>mul2, <span style="color:#dc322f">double</span> <span style="color:#719e07">**</span>res) {
</span></span><span style="display:flex;"><span>  size_t i, i2, j, j2, k, k2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">double</span> <span style="color:#719e07">*</span>rres, <span style="color:#719e07">*</span>rmul1, <span style="color:#719e07">*</span>rmul2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">for</span> (i <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; i <span style="color:#719e07">&lt;</span> sz; i <span style="color:#719e07">+=</span> SM) {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">for</span> (j <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; j <span style="color:#719e07">&lt;</span> sz; j <span style="color:#719e07">+=</span> SM) {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">for</span> (k <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; k <span style="color:#719e07">&lt;</span> sz; k <span style="color:#719e07">+=</span> SM) {
</span></span><span style="display:flex;"><span>        size_t i2_max <span style="color:#719e07">=</span> MIN(SM, sz <span style="color:#719e07">-</span> i);
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">for</span> (i2 <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>, rres <span style="color:#719e07">=</span> <span style="color:#719e07">&amp;</span>res[i][j], rmul1 <span style="color:#719e07">=</span> <span style="color:#719e07">&amp;</span>mul1[i][k]; i2 <span style="color:#719e07">&lt;</span> i2_max; <span style="color:#719e07">++</span>i2, rres <span style="color:#719e07">+=</span> sz, rmul1 <span style="color:#719e07">+=</span> sz) {
</span></span><span style="display:flex;"><span>          size_t k2_max <span style="color:#719e07">=</span> MIN(SM, sz <span style="color:#719e07">-</span> k);
</span></span><span style="display:flex;"><span>          <span style="color:#719e07">for</span> (k2 <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>, rmul2 <span style="color:#719e07">=</span> <span style="color:#719e07">&amp;</span>mul2[k][j]; k2 <span style="color:#719e07">&lt;</span> k2_max; <span style="color:#719e07">++</span>k2, rmul2 <span style="color:#719e07">+=</span> sz) {
</span></span><span style="display:flex;"><span>            size_t j2_max <span style="color:#719e07">=</span> MIN(SM, sz <span style="color:#719e07">-</span> j);
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">for</span> (j2 <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; j2 <span style="color:#719e07">&lt;</span> j2_max; <span style="color:#719e07">++</span>j2) {
</span></span><span style="display:flex;"><span>              rres[j2] <span style="color:#719e07">+=</span> rmul1[k2] <span style="color:#719e07">*</span> rmul2[j2];
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Compared to <code>matrix_multiply_fast</code> this function uses temp variables to hold intermediate values and
also uses <code>+= sz</code> instruction to iterate over the matrices. As a result, the compilation produces
more compact machine code, so less instruction should be executed for each iteration.</p>
<p>This function requires data to be stored sequentially in the memory, so
<code>mul1[i + 1][0] == (mul1[i] + sz)[0]</code>.</p>
<p>The execution results:</p>
<table>
<thead>
<tr>
<th>matrix size</th>
<th>execution time (cycles)</th>
<th>relative execution time</th>
</tr>
</thead>
<tbody>
<tr>
<td>100x100</td>
<td>459</td>
<td>62.62%</td>
</tr>
<tr>
<td>300x300</td>
<td>11773</td>
<td>54.80%</td>
</tr>
<tr>
<td>500x500</td>
<td>56441</td>
<td>55.55%</td>
</tr>
<tr>
<td>1000x1000</td>
<td>480246</td>
<td>56.93%</td>
</tr>
<tr>
<td>2000x2000</td>
<td>4164429</td>
<td>16.15%</td>
</tr>
<tr>
<td>3000x3000</td>
<td>14001852</td>
<td>12.99%</td>
</tr>
</tbody>
</table>
<p>From the results, it can be found that execution time does not differ a lot for small matrices, but
as matrices become bigger the difference grows significantly, that is why the optimizations are
worth implementing.</p>
<p><img src="../matrix-multiply-speed.png" alt="algorithms comparation"></p>
<p>I run all examples on the machine with Intel Core i7-10700K processor and 3000 MHz DDR4 memory on
Ubuntu 20.04 with gcc 9.3.0.</p>
<p>I&rsquo;d uploaded the code I&rsquo;d used into
<a href="https://github.com/0e39bf7b/matrices-multiplication">GitHub repo</a>, so anyone can run it and measure
an execution time on the different hardware.</p>
<p>Concluding, writing the code considering cache locality can increase the performance dramatically,
but sometimes it can make the program harder to read and understand. As Donald Knuth had written in
The Art of Computer Programming: &ldquo;Premature optimization is the root of all evil&rdquo;, so make such
performance tuning if only it&rsquo;s required.</p>
  <div class="post-date">
    <a href="../posts/how-much-access-to-ram-costs/"><time datetime="2022-01-17T05:00:00Z">Jan 17, 2022 05:00</time></a>
  </div>
</article><article class="post">
  <p>Some time ago I&rsquo;d bought Focusrite Scarlett gen3 audio interface because it&rsquo;s one of the devices
that work on Linux out of the box. Unfortunately, some features of the device can be accessed only
through <a href="https://focusrite.com/ru/node/63">Focusrite Control</a> that is not available on Linux.
Recently I&rsquo;d found
<a href="https://youtu.be/1JCgQrukVBs">an interesting stream about improving Focusrite Scarlett Driver</a> that
shows how to access additional features of the device on the Linux platform. It is worth watching if
you are interested in reverse engineering and Linux drivers.</p>

  <div class="post-date">
    <a href="../notes/1641756063/"><time datetime="2022-01-09T19:21:03Z">Jan 9, 2022 19:21</time></a>
  </div>
</article><article class="post">
  <p>I have a network smb share with different videos that I want to watch over network on my devices.
Today I&rsquo;d tried to watch a video on my Kubuntu laptop with VLC. It prints errors like:</p>
<pre tabindex="0"><code>Your input can&#39;t be opened:
VLC is unable to open the MRL &#39;smb://10.0.0.1/Share/video.mkv&#39;. Check the log for details.
</code></pre><p>I&rsquo;d checked logs and found nothing. I&rsquo;d tried to set username and password in the settings as
<a href="https://www.dedoimedo.com/computers/vlc-remote-files.html">suggested on the Internet</a> with no
results. I&rsquo;d also tried to install <code>kio-fuse</code> as
<a href="https://www.reddit.com/r/kde/comments/er2udt/opening_video_files_from_dolphin_with_vlc_in/">described on Reddit</a>
— nothing changed. So I think, there is some bug in the VLC, that is why I used a different
solution:</p>
<ol>
<li>Open <code>/usr/share/applications/vlc.desktop</code>.</li>
<li>Remove line <code>X-KDE-Protocols=ftp,http,https,mms,rtmp,rtsp,sftp,smb</code>.</li>
<li>Make sure that <code>kio-fuse</code> installed.</li>
</ol>
<p><code>X-KDE-Protocols</code> instructs Dolphin to pass smb URLs directly to VLC. Without this line, <code>kio</code> mounts
smb share and allows VLC to work with a local file.</p>

  <div class="post-date">
    <a href="../notes/1641155092/"><time datetime="2022-01-02T20:24:52Z">Jan 2, 2022 20:24</time></a>
  </div>
</article><article class="post">
  <p>Today I&rsquo;ve found <a href="https://albertlauncher.github.io/">Albert</a>. It&rsquo;s a great Alfred-like app for
Linux.</p>

  <div class="post-date">
    <a href="../notes/1640974351/"><time datetime="2021-12-31T18:12:31Z">Dec 31, 2021 18:12</time></a>
  </div>
</article><article class="post">
  <p>Sometimes it can be useful to have an external HDD or SSD with a familiar environment installed.
With such a device it&rsquo;s possible to check the computer from eBay for GPU or memory faults, restore a
primary OS of the workstation after an unsuccessful software update or just work on another PC with
a familiar OS without any modifications of any software on this machine.</p>
<p>I use Ubuntu 20.04 as a primary OS, that is why in this article, I&rsquo;ll explain how to install it on
an external drive.</p>
<p>First of all, there is an
<a href="https://ubuntu.com/tutorials/create-a-usb-stick-on-ubuntu">official tutorial</a> about how to make a
bootable USB stick. It&rsquo;s a useful solution when the main goal is the installation of Ubuntu. It is
also possible to try the system before the installation. Unfortunately, all files that the user had
created during the demo session will be lost after a reboot.</p>
<p>This problem can be partially solved by the persistence file with tools like
<a href="https://github.com/pbatard/rufus">Rufus</a> or <a href="https://help.ubuntu.com/community/mkusb">mkusb</a>. All
modifications of the file system like a file creation or installation of a program will be saved
into the overlay file.</p>
<p>There are several limitations of such an approach: it&rsquo;s impossible to modify the kernel, install
hardware drivers or perform major system updates because the overlay file is mounted after the
kernel is loaded. However, users can install or update most applications, so the can always use the
latest version of the web browser or office suite.</p>
<p>I want to work around these limitations and prepare an environment that will be identical to my
desktop. It can be achieved by installing Ubuntu on an external drive.</p>
<p>I have an Ubuntu desktop and external Seagate HDD with a USB 3 interface.</p>
<p>First of all install <a href="https://www.virtualbox.org/">VirtualBox</a>:</p>
<pre tabindex="0"><code>sudo apt install virtualbox
</code></pre><p>Only members of the <code>disk</code> group can perform different actions with USB disks without <code>sudo</code>, so
execute such command:</p>
<pre tabindex="0"><code>sudo gpasswd -a `whoami` disk
</code></pre><p>After this command re-login or restart the computer to apply changes.</p>
<p>Connect the external drive and take a look on the messages from <code>/var/log/syslog</code> (it&rsquo;s also
possible to use <code>glome-logs</code> GUI tool to explore these logs):</p>
<pre tabindex="0"><code>tail -30 /var/log/syslog
</code></pre><p>There should be something like:</p>
<pre tabindex="0"><code>usb 1-11: new high-speed USB device number 8 using xhci_hcd
usb 1-11: New USB device found, idVendor=0bc2, idProduct=231a, bcdDevice= 7.08
usb 1-11: New USB device strings: Mfr=1, Product=2, SerialNumber=3
sd 5:0:0:0: [sda] Attached SCSI disk
</code></pre><p>It means that the external HDD is attached as a <code>/dev/sda</code> device. Alternatively, there is the same
info in the <code>gnome-disks</code> tool:</p>
<p><img src="../install-ubuntu-on-external-disk/gnome-disks.png" alt="gnome-disks"></p>
<p>Before continuing unmount any mounted partitions of the external drive with a command like
<code>sudo umount /dev/sda1</code>. It&rsquo;s better to avoid using GUI because it can cause errors like:</p>
<pre tabindex="0"><code>BoxManage: error: Cannot open the raw disk &#39;/dev/sda&#39;: VERR_MEDIA_NOT_PRESENT
VBoxManage: error: The raw disk vmdk file was not created
</code></pre><p>on further steps.</p>
<p>By default, VirtualBox hard drive is just a file but it&rsquo;s possible to connect a block device as a
hard drive. So the idea is to connect the external HDD as a hard drive to VirtualBox and install
Ubuntu on it in the virtual machine (VM).</p>
<p>To install Ubuntu on the external drive, create a virtual hard disk image from the existing contents
of a physical drive so VirtualBox can mount this disk to the VM:</p>
<ol>
<li>Create virtual hard drive with the command:
<code>VBoxManage internalcommands createrawvmdk -filename ~/sda.vmdk -rawdisk /dev/sda</code> where
<code>/dev/sda</code> is the device name from the syslog.</li>
<li>Open VirtualBox and press <code>ctrl-d</code> to show Virtual Media Manager.</li>
<li>Press &ldquo;Add&rdquo; and find the file from step 1.</li>
</ol>
<p>Speed of the system can be limited by the speed of an external drive: the portable system can be a
lot slower than the system with an internal m.2 SSD.</p>
<p>Create an Ubuntu VM without a hard drive:</p>
<p><img src="../install-ubuntu-on-external-disk/vm-without-hard-drive.png" alt="VM without hard drive"></p>
<p>Open VM settings with <code>Ctrl-S</code> and add previously created hard drive <code>sda.vmdk</code> in the <em>Storage</em>
section.</p>
<p>The majority of modern computers use
<a href="https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface">UEFI</a> that requires a special
disk partition to boot. Ubuntu detects the system type during the installation and creates a
bootable disk partition if required. VirtualBox has <strong>Enable EFI</strong> option that makes VM work like a
real computer, but it&rsquo;s disabled by default, so Ubuntu does not create a special disk partition and
the system will not work on the real PC. That is why it&rsquo;s required to enable this option in the
settings:</p>
<p><img src="../install-ubuntu-on-external-disk/enable-efi.png" alt="Enable EFI"></p>
<p>Install Ubuntu in the VM. I suggest enabling disk encryption because it helps with data protection
that is especially important for portable installations. When the installation is completed perform
a software upgrade and install the required hardware drivers. In my case, it&rsquo;s Nvidia drivers.</p>
<pre tabindex="0"><code>sudo apt update
sudo apt upgrade
sudo apt install nvidia-driver-460
</code></pre><p>Any additional software, like an image editor or instant messengers, can be installed now or later.</p>
<p>So, that&rsquo;s all: restart the computer, select bootable disk and use portable Ubuntu installation.</p>
  <div class="post-date">
    <a href="../posts/install-ubuntu-on-external-disk/"><time datetime="2021-12-25T10:00:00Z">Dec 25, 2021 10:00</time></a>
  </div>
</article><article class="post">
  <p><a href="https://zoom.us/">Zoom</a> has become the de facto standard for online communications for me. On Linux
Zoom depends on ibus. It looks a bit strange because Zoom works fine without this dependency and in
some cases, ibus can make problems. There is a <a href="https://hashman.ca/zoom/">nice article</a> about how to
repack Zoom to work without ibus.</p>

  <div class="post-date">
    <a href="../notes/1638453327/"><time datetime="2021-12-02T13:55:27Z">Dec 2, 2021 13:55</time></a>
  </div>
</article><article class="post">
  <p>Recently, I&rsquo;ve found <a href="https://ubuntu.com/about/packages">a page</a>, explaining the types of packages
in Ubuntu. It gives the information about strengths and weaknesses of each packaging system and
discusses what is the best choice for different usage scenarios. The article gives me a lot to think
about. Although certain solutions seem controversial to me, the article clarifies the vision of
Canonical for package systems.</p>

  <div class="post-date">
    <a href="../notes/1638126669/"><time datetime="2021-11-28T19:11:09Z">Nov 28, 2021 19:11</time></a>
  </div>
</article><article class="post">
  <p>Is it time to switch from <a href="https://www.docker.com/">Docker</a> to <a href="https://podman.io/">Podman</a>?</p>

  <div class="post-date">
    <a href="../notes/1637445162/"><time datetime="2021-11-20T21:52:42Z">Nov 20, 2021 21:52</time></a>
  </div>
</article><article class="post">
  <p>I have a dual boot setup on my PC: Ubuntu and Windows 10. Sometimes it&rsquo;s required to reload Windows
for processing system updates. By default, Grub loads the first system from the list, which is
Ubuntu. It&rsquo;s inconvenient. I think it&rsquo;s better to make Grub remember the last loaded OS and start it
after reboot.</p>
<p>To achieve this behaviour you need to perform such steps:</p>
<ol>
<li>
<p>Add to <code>/etc/default/grub</code> following strings:</p>
<pre><code> GRUB_DEFAULT=saved
 GRUB_SAVEDEFAULT=true
</code></pre>
</li>
<li>
<p>Execute <code>sudo update-grub</code>.</p>
</li>
</ol>

  <div class="post-date">
    <a href="../notes/1637062416/"><time datetime="2021-11-16T11:33:36Z">Nov 16, 2021 11:33</time></a>
  </div>
</article><article class="post">
  <p>Found <a href="https://timeline.kde.org/">KDE Timeline</a>. Looks interesting. The times of KDE 3 were really
awesome.</p>

  <div class="post-date">
    <a href="../notes/1634247448/"><time datetime="2021-10-14T21:37:28Z">Oct 14, 2021 21:37</time></a>
  </div>
</article><article class="post">
  <p>Recently I&rsquo;d found that <code>ping</code> utility on Ubuntu 20.04 and Ubuntu 21.04 works without root
permissions, suid flag, or <code>CAP_NET_RAW</code> capability. In the
<a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt">Kernel documentation</a> it is said
that <code>ping</code> uses <code>ICMP_PROTO</code> datagram sockets and it&rsquo;s possible to allow users without root
permissions to create such sockets:</p>
<blockquote>
<p><strong>ping_group_range</strong> - 2 INTEGERS</p>
</blockquote>
<blockquote>
<p>Restrict <code>ICMP_PROTO</code> datagram sockets to users in the group range. The default is &ldquo;<code>1 0</code>&rdquo;,
meaning, that nobody (not even root) may create ping sockets. Setting it to &ldquo;<code>100 100</code>&rdquo; would
grant permissions to the single group. &ldquo;<code>0 4294967295</code>&rdquo; would enable it for the world,
&ldquo;<code>100 4294967295</code>&rdquo; would enable it for the users, but not daemons.</p>
</blockquote>
<p>I&rsquo;d checked <code>/proc/sys/net/ipv4/ping_group_range</code> and found <code>0 2147483647</code> interval.</p>
<p>Also, there is a
<a href="https://sturmflut.github.io/linux/ubuntu/2015/01/17/unprivileged-icmp-sockets-on-linux/">code example</a>
that demonstrates the use of <code>ICMP_PROTO</code> sockets.</p>

  <div class="post-date">
    <a href="../notes/1632296253/"><time datetime="2021-09-22T07:37:33Z">Sep 22, 2021 07:37</time></a>
  </div>
</article><article class="post">
  <p>I use Thunderbird as an e-mail client. I&rsquo;d configured several rules on the server side for splitting
messages from INBOX into several folders (Jira, GitLab, etc.). It&rsquo;s important to execute these rules
on the server side because I have several clients and, I don&rsquo;t want to make the same rules for each
client. By default, Thunderbird checks only the INBOX folder of the IMAP account, so I had no
notifications about new mail in the other folders. Recently I&rsquo;d found that it can be fixed.</p>
<p>To make Thunderbird check for new messages in all folders:</p>
<ul>
<li>open Thunderbird preferences;</li>
<li>open Config Editor;</li>
<li>search for: <code>mail.server.default.check_all_folders_for_new</code>;</li>
<li>change value from <code>False</code> to <code>True</code>.</li>
</ul>

  <div class="post-date">
    <a href="../notes/1631610988/"><time datetime="2021-09-14T09:16:28Z">Sep 14, 2021 09:16</time></a>
  </div>
</article><article class="post">
  <p>There is a Full HD screen on my 14&quot; laptop. It looks like some sort of HiDPI for me, and that is why
controls of an interface on native resolution are too small, so it&rsquo;s difficult to use. On Windows,
an interface was scaled for 125% and looks a lot better.</p>
<p>I tried to make the same settings on Ubuntu 21.04, and there were some issues. There are two
options: a new Wayland session and a more traditional Xorg session.</p>
<p>When I set up a 125% scale for the interface in the Wayland session, it looks great, but some apps
like Google Chrome, VS Code, or Slack look blurry out of the box. For some apps, it&rsquo;s possible to
fix it in some way using experimental features, that can lead to instability and random crashes.
Also, there is
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1718727">an extremely annoying bug in Firefox</a>: some
popups like Multi-Account Containers are cropped and it&rsquo;s impossible to use them. It will be fixed
only in Firefox 93 which will be released in October. There are a lot of small issues on Wayland
like <a href="https://github.com/vim/vim/issues/5157">Vim clipboard</a>, that is why I&rsquo;m not sure that Wayland
is ready for desktop now.</p>
<p>When I set up a 125% scale for the interface in the Xorg session all apps work properly, but there
are some artifacts in the interface like black rectangles around windows or black lines in random
places of the screen. It&rsquo;s better than Wayland but still not good enough.</p>
<p>I&rsquo;d tried different Linux distributions and different desktop environments to find the best solution
for cases like mine. Xfce and Cinnamon work fine only with x2 and x3 scales. Elementary works with
x2 scale and allows to increase fonts, so texts look fine, but controls are too small. The
co-founder of Elementary
<a href="https://blog.elementary.io/what-is-hidpi/">says it&rsquo;s OK and I just need to buy another laptop</a>.</p>
<p>The solution I found is Kubuntu 21.04 with KDE 5.21.4. It allows setting 125% scale out of the box.
Everything works: Qt apps, GTK apps, Firefox, Google Chrome, and so on. That is why now I&rsquo;m a happy
KDE user.</p>

  <div class="post-date">
    <a href="../notes/1631122832/"><time datetime="2021-09-08T17:40:32Z">Sep 8, 2021 17:40</time></a>
  </div>
</article><article class="post">
  <p>I&rsquo;ve used to ask questions about different open source projects on Freenode IRC several years ago.
Today I&rsquo;ve found that Freenode staff members had left the company and started
<a href="https://libera.chat/">Libera.Chat</a>. You can find the roots of this decision on
<a href="https://en.wikipedia.org/wiki/Libera_Chat">Wiki page</a>.</p>

  <div class="post-date">
    <a href="../notes/1630740946/"><time datetime="2021-09-04T07:35:46Z">Sep 4, 2021 07:35</time></a>
  </div>
</article><article class="post">
  <p>Recently Docker
<a href="https://www.docker.com/blog/updating-product-subscriptions/">has updated subscriptions</a>, and now
Docker Desktop remains free only for individuals or small businesses. I think it&rsquo;s OK that Docker as
a company wants to get money from their products. At the same time, it&rsquo;s a bit strange to change the
rules of the game for existing products. We&rsquo;ll see how the community reacts to this announcement.</p>

  <div class="post-date">
    <a href="../notes/1630503528/"><time datetime="2021-09-01T13:38:48Z">Sep 1, 2021 13:38</time></a>
  </div>
</article><article class="post">
  <p>One of the most important parts of laptop security is disk encryption. It can help to save your
personal data if you lost your computer or it was stolen. It&rsquo;s impossible to encrypt everything. You
need some code to ask for the password from the user and decrypt the system.</p>
<p>There are several options when you work with Ubuntu:</p>
<ul>
<li>encrypt only home directory;</li>
<li>encrypt the operating system partition during the installation process and rely on UEFI Secure
Boot for Linux kernel verification;</li>
<li>encrypt not only the operating system partition, but also the boot partition; look at
<a href="https://help.ubuntu.com/community/Full_Disk_Encryption_Howto_2019">Full Disk Encryption Howto</a>
for more details.</li>
</ul>
<p>It&rsquo;s important to remember that disk encryption is not free. There is always a performance hit if
you use full disk encryption, but it can be unnoticeable on modern hardware. There are some tests
from Phoronix about disk encryption:</p>
<ul>
<li><a href="https://www.phoronix.com/scan.php?page=article&amp;item=ubuntu-1804-encrypt&amp;num=1">The Cost Of Home Directory Encryption &amp; LUKS Full Disk Encryption On Ubuntu 18.04</a>;</li>
<li><a href="https://www.phoronix.com/scan.php?page=article&amp;item=ryzen-disk-encrypt&amp;num=1">Linux Full Disk Encryption Performance With AMD Ryzen 5 + SATA 3.0 SSD</a>.</li>
</ul>

  <div class="post-date">
    <a href="../notes/1630395790/"><time datetime="2021-08-31T07:43:10Z">Aug 31, 2021 07:43</time></a>
  </div>
</article><article class="post">
  <p>I have been using macOS on the laptop for a few years, but recently I switched back to Ubuntu. It
has several advantages for my usage pattern: the environment which my programs use in production,
Docker with fast FS and without <a href="https://github.com/docker/roadmap/issues/183">imposed updates</a>, and
a lot more control over the system.</p>
<p>One thing that I miss is Time Machine. Having up-to-date backups is extremely important. It helps
when your computer stops working normally, or it has been stolen, or you just want to move from one
laptop to another.</p>
<p>Of cause, there are a lot of different backup solutions on Linux. I&rsquo;d found articles like
<a href="https://www.fosslinux.com/44619/best-linux-backup-tools.htm">The 10 Best Linux Backup Tools</a>,
<a href="https://www.ubuntupit.com/best-backup-software-for-linux/">The 15 Best Backup Software For Linux Desktop</a>,
or even
<a href="https://www.tecmint.com/linux-system-backup-tools/">25 Outstanding Backup Utilities for Linux Systems in 2020</a>.
All Linux backup utilities can be divided into two groups.</p>
<p>The utilities from the first group allow you to make incremental backups, data encryption and you
don&rsquo;t have to stop working during the backup creation, but you have to select a directory to backup.
Usually, it&rsquo;s a home directory because there are some pitfalls that stop me from selecting <code>/</code>. That
is why when you need to restore from the backup you have to install fresh Linux distribution
yourself with all your programs and only then restore your data like documents or photos from the
backup.</p>
<p>The second group includes the utilities that make the backup of the entire hard drive and you can
restore the entire system from such a backup. Unfortunately, you can&rsquo;t use the computer during the
backup creation process and I&rsquo;m not sure that it&rsquo;s possible to make incremental backups in this
case. When you need to restore from such a backup you can restore only all or nothing. It can be
inconvenient.</p>
<p>I want to find a tool that can backup my data from the home directory but also saves the system
configuration somehow. When I need to restore from the backup the tool should help me to install the
system with all settings and then restore the user data. Unfortunately, I&rsquo;ve not found such a tool
yet, so I have to use Gnome&rsquo;s default backup solution —
<a href="https://wiki.gnome.org/Apps/DejaDup">Déjà Dup</a>.</p>

  <div class="post-date">
    <a href="../notes/1630181380/"><time datetime="2021-08-28T20:09:40Z">Aug 28, 2021 20:09</time></a>
  </div>
</article><article class="post">
  <p>Sometimes I find interesting links or have some thoughts about software engineering problems that I
want to save and share. It&rsquo;s not enough for an article in the blog, so I don&rsquo;t publish it there.
That is why I&rsquo;d created this page, and I&rsquo;m going to post some short messages here.</p>

  <div class="post-date">
    <a href="../notes/1630170209/"><time datetime="2021-08-28T17:03:29Z">Aug 28, 2021 17:03</time></a>
  </div>
</article><article class="post">
  <p>Hello world!</p>

  <div class="post-date">
    <a href="../notes/1630067102/"><time datetime="2021-08-27T12:25:02Z">Aug 27, 2021 12:25</time></a>
  </div>
</article><article class="post">
  <p>Ubuntu is an open-source system that allows users to control different components. Default desktop
installation has a bunch of periodic tasks out of the box. It&rsquo;s important to understand what is the
purpose of these tasks and how often they are called. This knowledge allows to predict the network
activity, reduce the number of unexpected CPU spikes and improve user experience. Moreover, some of
the default tasks can be redundant for the particular user and that is why should be disabled.</p>
<p>Ubuntu 21.04 on my laptop uses <a href="https://www.freedesktop.org/wiki/Software/systemd/">systemd</a> as a
core component, so periodic jobs are implemented as
<a href="https://wiki.archlinux.org/title/Systemd/Timers">timer units</a>. Timers mechanism is an alternative
for the <a href="https://wiki.archlinux.org/title/Cron">cron</a>, the most well-known job scheduler. For
backward compatibility, cron is also installed into default Ubuntu distribution. It&rsquo;s started by the
<code>cron.service</code> on a boot time. Systemd timers are more flexible than cron jobs. It&rsquo;s possible to
point out such advantages of systemd timers:</p>
<ul>
<li>easier debugging with verbose logging in systemd journal;</li>
<li>advanced resource management as for any other systemd service: syscall filtering, IO scheduling,
etc;</li>
<li>possibility to define the relationships between the timer and any other systemd service, e.g.
forbid parallel execution with another service using <code>Conflicts</code> instruction;</li>
<li>systemd timer can be activated not only at the specified time but also by the complex conditions,
like a minute after some hardware had been plugged.</li>
</ul>
<p>The command <code>systemctl list-timers</code> lists all active timers in the system. A fresh Ubuntu 21.04
installation gives such output:</p>
<pre tabindex="0"><code>logrotate.timer
fstrim.timer
systemd-tmpfiles-clean.timer
e2scrub_all.timer
man-db.timer
ua-messaging.timer
apt-daily.timer
apt-daily-upgrade.timer
update-notifier-download.timer
update-notifier-motd.timer
fwupd-refresh.timer
motd-news.timer
anacron.timer
</code></pre><p>The timer is defined by the corresponding file in the <code>/usr/lib/systemd/system</code> directory. It
describes when the process should be started. Each timer has a service that describes what process
and how should be started. Almost any file in the system belongs to a particular package. It&rsquo;s
possible to find the package using the command <code>dpkg -S file-name</code>.</p>
<p>The timers described above can be split into several groups. Detailed information on each of them is
represented below.</p>
<h3 id="regular-maintenance-jobs">Regular maintenance jobs</h3>
<p>Every system needs some maintenance from time to time. It allows to check integrity, increase
performance and reduce disk usage. Here are the timers responsible for such jobs:</p>
<ul>
<li><code>logrotate.timer</code> allows automatic rotation, compression, removal, and mailing of log files once a
day;</li>
<li><code>fstrim.timer</code> discards (or &ldquo;trim&rdquo;) blocks that are not in use by the filesystem once a week; it&rsquo;s
useful for solid-state drives (SSDs);</li>
<li><code>systemd-tmpfiles-clean.timer</code> — daily cleanup of temporary directories;</li>
<li><code>e2scrub_all.timer</code> — periodic ext4 online metadata check for all filesystems;</li>
<li><code>man-db.timer</code> — daily man-db regeneration.</li>
</ul>
<p>I don&rsquo;t fully understand the purpose of the <code>man-db.timer</code>: it&rsquo;s better to regenerate man-db indexes
by <code>dpkg</code> when a new package is being installed, that is why additional periodic updates look
redundant.</p>
<h3 id="ubuntu-advantage">Ubuntu Advantage</h3>
<p><code>ua-messaging.timer</code> is a part of <code>ubuntu-advantage-tools</code> package — management tools for
<a href="https://ubuntu.com/support">Ubuntu Advantage</a>, the paid support for enterprises. The timer starts
updating the messaging text for use in MOTD and APT custom Ubuntu Advantage messages.</p>
<p>The package is installed by default. From the description of the package, I&rsquo;d found that it provides
users with a simple mechanism to view, enable, and disable offerings from Canonical on their system.
I don&rsquo;t use Canonical paid services on my laptop, that is why I prefer to delete the package with
<code>apt purge ubuntu-advantage-tools</code> command.</p>
<h3 id="software-updates">Software updates</h3>
<p>A bunch of timers is responsible for automatic software updates:</p>
<ul>
<li><code>apt-daily.timer</code> checks for updates and downloads new packages;</li>
<li><code>apt-daily-upgrade.timer</code> installs new packages without interaction with user;</li>
<li><code>update-notifier-download.timer</code> download data for packages that failed at package install time;</li>
<li><code>update-notifier-motd.timer</code> checks if new release available.</li>
</ul>
<p>On the one side, it&rsquo;s important to keep the system up to date, because of security issues. On the
other side, auto-updates can cause unexpected network traffic, poor user experience (like the
requirement to restart Firefox with a lot of opened tabs after background update), or even system
instability. I prefer to remove <code>update-notifier-common</code> package, which is responsible for
auto-updates, and execute command <code>apt update &amp;&amp; apt upgrade</code> several times a week by hands only
when I&rsquo;m ready for updates.</p>
<h3 id="firmware-update">Firmware update</h3>
<p>Modern hardware is sophisticated and often has internal firmware that needs to be updated from time
to time to improve the user experience, increase stability and fix security issues. Updating
firmware on devices is difficult for Linux users due to the lack of Windows-specific flashing tools.
That is why <a href="https://fwupd.org/">Linux Vendor Firmware Service</a> (LVFS) was introduced. It allows
hardware vendors to upload firmware updates that will be used by all major Linux distributions.</p>
<p><a href="https://github.com/fwupd/fwupd">fwupdmgr</a> is a client for LVFS. <code>fwupd-refresh.timer</code> is a timer
that downloads the latest metadata from LVFS regularly using fwupdmgr. It&rsquo;s an important process and
should be done from time to time but I prefer to do it by hand. That is why I choose to disable
this timer with such commands:</p>
<pre tabindex="0"><code>sudo systemctl stop fwupd-refresh.timer
sudo systemctl disable fwupd-refresh.timer
</code></pre><h3 id="motd-news">motd news</h3>
<p>There is a message displayed on different Unix-like systems on the login called &ldquo;message of the day&rdquo;
(<a href="https://en.wikipedia.org/wiki/Motd_(Unix)">motd</a>). On Ubuntu, a part of motd is a news message
from <a href="https://motd.ubuntu.com">https://motd.ubuntu.com</a>. According to <code>/etc/update-motd.d/50-motd-news</code> file the system sends a
request to the Ubuntu server containing information about release version, kernel version, CPU
architecture, and cloud ID, so the server can send messages that are relevant to a particular
distribution or hardware. The typical message looks like this:</p>
<pre tabindex="0"><code> * Super-optimized for small spaces - read how we shrank the memory
   footprint of MicroK8s to make it the smallest full K8s around.

   https://ubuntu.com/blog/microk8s-memory-optimisation
</code></pre><p>The idea is to show the user some useful information on login looks reasonable, but I don&rsquo;t like
when the system sends some data about my configuration to an external server from time to time even
if it&rsquo;s a server of Canonical. Also, the messages from <a href="https://motd.ubuntu.com">https://motd.ubuntu.com</a> look like tech
advertising rather than useful info.</p>
<p>The <code>/etc/update-motd.d/50-motd-news</code> file belongs to one of the core packages of the system —
<code>base-files</code>, that is why it&rsquo;s difficult to delete it safely. Fortunately, this feature is disabled
for desktops and no external requests are being sent. Also, I turn off this timer with such
commands:</p>
<pre tabindex="0"><code>sudo systemctl stop motd-news.timer
sudo systemctl disable motd-news.timer
</code></pre><h3 id="anacron">anacron</h3>
<p><a href="https://man7.org/linux/man-pages/man8/anacron.8.html">Anacron</a> is a tool that is used to execute
commands with a frequency specified in days. I&rsquo;d checked <code>/etc/anacrontab</code> and found three groups of
tasks:</p>
<ul>
<li><code>/etc/cron.daily</code>;</li>
<li><code>/etc/cron.weekly</code>;</li>
<li><code>/etc/cron.monthly</code>.</li>
</ul>
<p>There are no weekly and monthly tasks, but <code>/etc/cron.daily</code> directory contains several files. Some
of tasks have systemd timers equivalents:</p>
<ul>
<li><code>apt-compat</code> -&gt; <code>apt-daily.timer</code>;</li>
<li><code>logrotate</code> -&gt; <code>logrotate.timer</code>;</li>
<li><code>man-db</code> -&gt; <code>man-db.timer</code>.</li>
</ul>
<p>These files contain a check for systemd existence and if it&rsquo;s found — tasks do nothing and exit.</p>
<p>Also, there are some maintenance tasks:</p>
<ul>
<li><code>apport</code> cleans all crash reports that are older than a week;</li>
<li><code>dpkg</code> backups the 7 last versions of dpkg databases containing user data, so it&rsquo;s possible to
recover in case of corruption.</li>
<li><code>cracklib-runtime</code> updates <a href="http://www.fifi.org/doc/cracklib2/">cracklib</a> dictionaries if
required. For me such decision looks a bit strange: why don&rsquo;t update dictionaries in case of
deb-package upgrade instead of running the same task periodically without any data changes?</li>
</ul>
<p>Also, I use some third-party software: Google Chrome and Slack. I found the tasks for each of them:
<code>/etc/cron.daily/google-chrome</code> and <code>/etc/cron.daily/slack</code>. Each piece of software creates the
repository configuration file for the package updates. The idea of the periodic task is monitoring
that config to see if it has been disabled by the overly aggressive distro upgrade process. When
this situation is detected, the repository will be re-enabled.</p>
<h3 id="conclusion">Conclusion</h3>
<p>Linux is a complicated system. It can be configured in different ways. Ubuntu can provide the
defaults that look reasonable for maintainers but can be a bit controversial for a particular user.
The only option to find the best decision is a system exploration. The user should understand what
some particular process does. Only in this case he can decide is it suitable for his setup or it&rsquo;s
better to make some changes.</p>
<p>In the article, I&rsquo;d described the decisions I&rsquo;d made for my setup and why. Some people will agree
with them and others will not. It&rsquo;s OK. The idea of the article is not to suggest some particular
solution but to encourage users to explore the system and make their own meaningful choice.</p>
  <div class="post-date">
    <a href="../posts/ubuntu-periodic-tasks/"><time datetime="2021-07-17T06:00:00Z">Jul 17, 2021 06:00</time></a>
  </div>
</article><article class="post">
  <p>Recently I was configuring a virtual network of several KVM machines for the testing of Gitlab
installation. It&rsquo;s more convenient when I can access machines by hostname but I don&rsquo;t want to
install and support a DNS server. So I&rsquo;d decided to use mDNS.</p>
<p>First of all, I&rsquo;d tried to configure mDNS using <a href="https://netplan.io/">Netplan</a> — the default network
configuration tool in Ubuntu. I&rsquo;d found nothing about mDNS support in Netplan documentation. There
is <a href="https://bugs.launchpad.net/netplan/+bug/1830507">a ticket on the launchpad</a> about this issue and
it was marked as resolved, but I&rsquo;d found no changes in the master branch the
<a href="https://github.com/canonical/netplan">Netplan&rsquo;s Github</a>, connected to mDNS. I&rsquo;m sure this feature
will be implemented in the future, but for now, it&rsquo;s impossible to configure mDNS with Netplan.</p>
<p>Ubuntu Server 20.04 uses systemd-resolved as a DNS configuration tool. It supports mDNS, but by
default mDNS is disabled. To use mDNS it&rsquo;s required to enable it globally and for a particular
network interface.</p>
<p>To enable mDNS globally I need to set option <code>MulticastDNS=yes</code> in the <code>/etc/systemd/resolved.conf</code>
file. According to the
<a href="https://manpages.ubuntu.com/manpages/focal/man5/systemd.network.5.html">man page</a> to turn on mDNS
for <code>enp1s0</code> network interface I need to create a file <code>/etc/systemd/network/enp1s0.network</code> and add
<code>MulticastDNS=yes</code> option there. This solution does not work out of the box, because Netplan creates
configuration file for the network interface in the <code>/run</code> directory and this file has a higher
priority than the file in <code>/etc</code>. It&rsquo;s possible to enable mDNS with a command like
<code>sudo systemd-resolve --set-mdns=yes --interface=enp1s0</code> but it&rsquo;s a temporary solution that works
only until reboot.</p>
<p>In my case, Netplan creates more problems than benefits, so I&rsquo;d decided to remove it completely and
configure the network with systemd-network by hand.</p>
<p>To remove Netplan I&rsquo;d executed the command <code>sudo apt purge netplan.io</code>. And for the network
configuration I&rsquo;d created file <code>/etc/systemd/network/enp1s0.network</code> with such contents:</p>
<pre tabindex="0"><code>[Match]
Name=enp1s0

[Network]
MulticastDNS=yes
DHCP=ipv4
LinkLocalAddressing=ipv6

[DHCP]
RouteMetric=100
UseMTU=true
</code></pre><p>After the reboot, everything worked as expected.</p>
  <div class="post-date">
    <a href="../posts/mdns-on-ubuntu-server/"><time datetime="2021-05-25T03:00:00Z">May 25, 2021 03:00</time></a>
  </div>
</article><article class="post">
  <p>Almost every user sooner or later faces network problems, so it&rsquo;s essential to have at least a basic
understanding of network troubleshooting. In this article, I&rsquo;d like to overview tools I use to
explore network configuration and solve network issues on the Ubuntu desktop. Most of these
applications can be used on a server but some of them are specific to desktop systems.</p>
<h3 id="ip-and-networkmanager">ip and NetworkManager</h3>
<p><code>ip</code> is a tool that allows to show or manipulate routing and network devices. Older Ubuntu
distributions used the <code>ifconfig</code> for the same purpose. There are some commands I use in everyday
life:</p>
<ul>
<li><code>ip addr</code> — show system IP and MAC addresses;</li>
<li><code>ip route</code> — show routing table;</li>
<li><code>ip addr show docker0 | grep -Po 'inet \K[\d.]+'</code> — print Docker host address.</li>
</ul>
<p><code>ip</code> has a lot more options described on man page. Even though <code>ip</code> allows to manipulate network
settings I prefer to avoid it because it&rsquo;s a temporary solution and all modifications will be lost
after a reboot.</p>
<p><a href="https://netplan.io/">Netplan</a> is a default tool for network configuration in Ubuntu 20.04. It
allows to create declarative representation of complex networks. Netplan does not configure the
network itself but generates configs for the underlying backend. It supports two backends:
NetworkManager (usually used on desktops) and systemd-networkd (usually used on servers). There is
more explanation about why Ubuntu switched from <code>ifupdown</code> to Netplan on
<a href="https://wiki.ubuntu.com/MigratingToNetplan">MigratingToNetplan page</a>.</p>
<p>Although Netplan may be convenient for complex solutions like clouds or enterprise networks, for my
desktop is a bit overkill. So I prefer to configure
<a href="https://wiki.gnome.org/Projects/NetworkManager">NetworkManager</a> directly. All config files of
NetowkManager are stored in <code>/etc/NetworkManager</code> directory. It&rsquo;s possible to modify configs by hand
but I prefer to use <code>nmcli</code> utility. E.g. to make static IP ethernet connection with preconfigured
DNS address I use these commands:</p>
<pre tabindex="0"><code># eno1 - my network interface
nmcli con mod eno1 ipv4.addresses 192.168.2.10/24
nmcli con mod eno1 ipv4.gateway 192.168.2.1
nmcli con mod eno1 ipv4.dns &#34;8.8.8.8&#34;
nmcli con mod eno1 ipv4.method manual
nmcli con up eno1
</code></pre><p>One more useful command is <code>nmcli general status</code>. It prints the current network status including
information about network connectivity.</p>
<h3 id="ss">ss</h3>
<p><code>ss</code> is a utility for sockets investigation. It dumps socket statistics of the system and shows
information similar to <code>netstat</code>. Some examples:</p>
<ul>
<li><code>sudo ss -ltpn '( sport = :8080 )'</code> — show the process listening port 8080 (it helps me with
errors like &ldquo;Address already in use&rdquo;)</li>
<li><code>ss -s</code> — show connections statistics.</li>
</ul>
<h3 id="traceroute-and-mtr">traceroute and mtr</h3>
<p>Sometimes network request is executed slowly or even fails. <code>traceroute</code> can help to find out what
is going on. It&rsquo;s a network diagnostic tool that tracks the path of IP packets using ICMP and
different TTL values. It also measures transit delays for every host in a chain so it&rsquo;s possible to
determine which host causes problems. The most common use case for me looks like
<code>traceroute example.com</code>.</p>
<p>It&rsquo;s also possible to use <code>mtr</code> instead of <code>traceroute</code>. It works almost the same but has more
user-friendly output and allows to export statistics into XML file what is convenient for scripting
purposes.</p>
<p>System administrators may
<a href="https://blog.securityevaluators.com/icmp-the-good-the-bad-and-the-ugly-130413e56030">disable ICMP for security reasons</a>
that is why even if network connections work properly <code>traceroute</code> and <code>mtr</code> may not work at all or
at least show incomplete information.</p>
<h3 id="dns-dig-and-systemd-resolved">DNS: dig and systemd-resolved</h3>
<p>Hostname resolution is an important part of the network configuration. During network issues
debugging there are two common tasks: resolving a hostname and checking system DNS configuration.</p>
<p>For resolving a hostname I use <code>dig</code> utility. It&rsquo;s a powerful command-line tool for querying DNS
servers. E.g. <code>dig example.com</code> uses the default system DNS server to find and show all records for
<code>example.com</code>.</p>
<p>In Ubuntu 20.04 DNS is managed by <code>systemd-resolved</code>. <code>resolvectl status</code> gives details about the
uplink DNS servers currently in use.</p>
<h3 id="iptables">iptables</h3>
<p><code>iptables</code> is an application that allows creating rules for the kernel that controls network
traffic.  It acts as a firewall that examines and directs packets based on address, port, and other
criteria.  <code>iptables</code> is a sophisticated tool, so it&rsquo;s a good idea to read some tutorials explaining
how to use it (e.g. <a href="https://wiki.archlinux.org/title/iptables">tutorial from archlinux wiki</a>).</p>
<p>I usually check <code>iptables</code> rules when network configuration looks OK but some applications can&rsquo;t
establish network connections or Docker containers can&rsquo;t access the external network. First of all,
I type <code>sudo iptables -L</code> to find out what is going on.</p>
<h3 id="tcpdump-and-wireshark">tcpdump and wireshark</h3>
<p>Network debugging becomes easier when you can capture and analyze the traffic going through the
system.  <code>tcpdump</code> can help with this task. This utility reads packets from the network interface
that match the boolean expression and then prints them on the screen or stores them in a file.</p>
<p>I have two use cases for <code>tcpdump</code>:</p>
<ul>
<li>check if some packets match an expression like <code>tcp and port 80</code> (I use it when an application is
not working as expected and I want to make sure that it receives or sends any data; I don&rsquo;t need
to store these packets anywhere);</li>
<li>write all packets into a file to analyze it in more detail later.</li>
</ul>
<p>Using <code>tcpdump</code> can be suitable not only for troubleshooting but also for network exploration.</p>
<p>On the desktop, it can be more convenient to use <a href="https://www.wireshark.org/">Wireshark</a>. It&rsquo;s a GUI
that uses the same mechanisms as a <code>tcpdump</code>.</p>
<h3 id="conclusion">Conclusion</h3>
<p>There are a lot of articles and tutorials on the Internet about each of these tools, so check it if
you need more info. Described tools always give me a clue to what is wrong with the network
configuration and then I can decide what to do to fix a problem.</p>

  <div class="post-date">
    <a href="../posts/network-tools/"><time datetime="2021-05-15T08:00:00Z">May 15, 2021 08:00</time></a>
  </div>
</article><article class="post">
  <p>A few days ago I&rsquo;d decided to configure Raspberry PI as a weather station to check temperature,
humidity, and pressure. So I need to access it on the network with SSH and a web browser. The
easiest way of solving this problem is using a static IP address. In this case, I have to set static
IP for Raspberry PI and then use this address in a browser. For me, it&rsquo;s more convenient to use a
human-readable hostname than remembering an IP address. I can modify <code>/etc/hosts</code> to associate
Raspberry PI IP with custom hostname but I have to perform this action on all of my devices. It&rsquo;s a
bit monotonous work if you have several computers and for some mobile devices, it&rsquo;s impossible to
configure.</p>
<p>In the case of complicated enterprise networks, it&rsquo;s common to configure a name server to perform
hostname resolution, but for a small home network with several computers, it can be a bit overkill
to configure and support a dedicated DNS server. Searching through the Internet I&rsquo;d found
<a href="https://www.khoi.io/post/raspberry-pi-ipad-pro-usb-c/">an article</a> about connecting Raspberry PI to
an iPad with a USB cable. The author accessed a device with the address <code>raspberrypi.local</code> without
any additional DNS configuration. So it should be a more lightweight alternative than a dedicated
DNS server for home networks.</p>
<p>A computer connected to a network has an address of the DNS server as a part of its network
configuration. When a piece of software (e.g. web browser) tries to access a remote host using
hostname it asks the DNS server to resolve a hostname into an IP address and then access a remote
host using the received IP address.</p>
<p>But what if there is no DNS server? Is it possible to perform hostname resolution? There is a set of
technologies called <a href="https://en.wikipedia.org/wiki/Zero-configuration_networking">zeroconf</a>. It
allows to creates a usable computer network without any additional manual configuration. One part of
zeroconf is a Multicast DNS (<a href="https://en.wikipedia.org/wiki/Multicast_DNS">mDNS</a>) — a technology
that allows resolving some hostnames without a dedicated DNS server. When a mDNS client needs to
resolve a hostname, it sends a multicast message to <code>224.0.0.251</code> (or <code>ff02::fb</code> for IPv6) that asks
the host having that name to identify itself. The target machine multicasts a response with its
address, so all computers in the network can use this information to update their mDNS caches.</p>
<p>Multicast DNS is supported by various operating systems like Linux, MacOS X, or Windows 10.</p>
<p>Usually, there is a file on Linux devices named <code>/etc/nnswitch.conf</code> that allows different
applications to determine the sources from which to obtain name-service information and in what
order. On my Ubuntu 20.04 desktop the configuration looks like this:</p>
<pre tabindex="0"><code>hosts: files mdns4_minimal [NOTFOUND=return] dns mymachines
</code></pre><p>It describes such a chain of actions:</p>
<ul>
<li>check <code>/etc/hosts</code> for a requested address;</li>
<li>if <code>.local</code> domain was requested make a mDNS IPv4 request with avahi-daemon;</li>
<li>if mDNS lookup succeeded, but the requested entry was not found stop any further attempts;</li>
<li>make a DNS request;</li>
<li>try to resolve a hostname of container registered with
<a href="https://www.freedesktop.org/wiki/Software/systemd/machined/">systemd-machined</a>.</li>
</ul>
<p>There are two services on Ubuntu that provide mDNS support: <a href="https://www.avahi.org/">Avahi</a> and
<a href="https://wiki.archlinux.org/index.php/Systemd-resolved">systemd-resolved</a>. By default, Ubuntu 20.04
uses Avahi for mDNS requests and systemd-resolved for DNS requests.</p>
<p>One more useful service connected with mDNS is
<a href="https://en.wikipedia.org/wiki/Zero-configuration_networking#DNS-based_service_discovery">DNS Service Discovery</a>.
It&rsquo;s a way of using standard DNS programming interfaces, servers, and packet formats to browse the
network for services like printers, file-sharing, or chats.</p>
<p>It&rsquo;s a pity but I haven&rsquo;t found how to configure Android Chrome to support mDNS. Moreover by default
my Android phone ignores DNS server from the router and uses <code>8.8.8.8</code> that is why even
configuration with a dedicated DNS server will not work out of the box. So I need to access my
Raspberry PI with IP address from my Android devices.</p>
<p>After all, a just set a hostname <code>weather</code> for the Raspberry PI, configured nginx to listen to port
80 and it made it possible to check the weather with <code>http://weather.local</code> from my computers and
iOS devices.</p>
  <div class="post-date">
    <a href="../posts/dns-wihtout-a-server/"><time datetime="2021-03-20T10:00:00Z">Mar 20, 2021 10:00</time></a>
  </div>
</article><article class="post">
  <p><img src="../unmount-freezes.png" alt="Unmount freezes"></p>
<p>Sometimes I need to copy files from an internal SSD to an external hard drive. Recently I&rsquo;ve found a
strange behavior on Ubuntu 20.04. When I try to copy a fairly big file (like 2Gb - 4Gb) Nautilus
shows insane writing speed and the progress bar instantly reaches 100%, but when I want to unmount
the device - it freezes for several minutes. I tried different file managers like
<a href="https://docs.xfce.org/xfce/thunar/start">Thunar</a> from Xfce,
<a href="https://midnight-commander.org/">midnight-commander</a>, or even utilities like <code>rsync</code> or <code>pv</code> - the
result was the same. For me, it&rsquo;s a bit inconvenient when I don&rsquo;t know how much time I have to wait
until all data will be transferred, so I tried to find the solution to this problem.</p>
<p>Searching on the Internet leads me to the fact that this problem is not specified to the file
manager or Linux distribution. It can be explained by the Linux virtual memory subsystem and
<a href="https://en.wikipedia.org/wiki/Page_cache">page cache</a> mechanism.</p>
<p>All types of computer memory can be divided into two groups: volatile and non-volatile. Volatile
memory usually fast but it has a limited size and requires power to maintain the stored information.
In contrast, non-volatile memory like HDD or the optical disc can retain the stored information even
after power is removed but it&rsquo;s slower than RAM. Due to this fact, Linux and other operating systems
use different approaches for accessing the memory of different kinds.</p>
<p>RAM is fast enough, that is why when a process needs to access the RAM it just specifies an address
and waits until the operation completes. For non-volatile storage, such an algorithm increases
latency and makes the system unresponsive, so it&rsquo;s better to use the asynchronous approach as much
as possible. Linux stages disk writes into the cache in RAM, and over time asynchronously flushes
them to disk. This algorithm has a positive effect on speeding disk I/O, but it has some issues.</p>
<p>When the cache is empty, and a process tries to execute a <code>write</code> operation it receives almost
instant feedback, but when the <code>flush</code> command is called there is a large pause for the actual data
transfer between RAM and HDD. By default, Ubuntu uses 20% of RAM for file caches that is why when I
have a lot of free RAM the cache can hold the whole file what leads to the problem described in the
first paragraph.</p>
<p>There are several possible solutions.</p>
<h4 id="reduce-cache-size">Reduce cache size</h4>
<p>There are some tunable settings that influence how the Linux kernel deals with the file system
cache. All of them are connected with dirty data (or dirty memory) - data that is written into the
cache but not saved on disk.</p>
<ul>
<li><code>dirty_ratio</code> - maximum percentage of dirty system memory</li>
<li><code>dirty_bytes</code> - the same as <code>dirty_ratio</code> but specified in bytes</li>
<li><code>dirty_background_ratio</code> - percentage of dirty system memory at which background writeback will
start</li>
<li><code>dirty_background_bytes</code> - the same as <code>dirty_background_ratio</code> but specified in bytes</li>
</ul>
<p>If my computer has 32Gb of RAM and <code>dirty_ratio</code> is 20 then the cache size will be over 6Gb what
leads to a long unmounting time. It&rsquo;s possible to reduce cache size to 48Mb and ask operating system
to start writing to the device when the cache has more than 16Mb of data using the command:</p>
<pre tabindex="0"><code>sudo bash -c &#39;echo $((16*1024*1024)) &gt; /proc/sys/vm/dirty_background_bytes&#39;
sudo bash -c &#39;echo $((48*1024*1024)) &gt; /proc/sys/vm/dirty_bytes&#39;
</code></pre><p>In this case, coping progress shows correct speed, and unmounting takes only several seconds.
To save this setting after reboot it&rsquo;s required to add such a line into <code>/etc/sysctl.conf</code>:</p>
<pre tabindex="0"><code>vm.dirty_background_bytes = 16777216
vm.dirty_bytes = 50331648
</code></pre><p>This option is applied to all disks - external and internal ones what can reduce system performance.</p>
<h4 id="mount-usb-flash-drive-with-sync-or-flush-option">Mount USB flash drive with &ldquo;sync&rdquo; or &ldquo;flush&rdquo; option</h4>
<p>By default, Ubuntu mounts flash drives with the <code>async</code> option. It means that cache and asynchronous
writes will be used. It&rsquo;s possible to ask the kernel to write all data synchronously. Assume flash
drive is a <code>/dev/sda1</code> device and it&rsquo;s required to mount it on <code>/mnt</code> directory. I can use a command
like:</p>
<pre tabindex="0"><code>sudo mount /dev/sda1 /mnt -o rw,sync
</code></pre><p>This option can
<a href="https://askubuntu.com/questions/1176927/is-there-an-alternative-to-the-sync-option-of-mount-when-mounting-an-external">reduce write speed dramatically</a>
and moreover it can influence the lifetime of the device: Linux kernel can&rsquo;t reorder writes and has
to write every sector in the order requested by the applications. On cheap USB drives that don&rsquo;t
reallocate sectors, the repeated writes to the file allocation table on (V)FAT or to the journal on
a typical modern filesystem can kill the stick
<a href="http://readlist.com/lists/vger.kernel.org/linux-kernel/22/111748.html">pretty fast</a>.</p>
<p>On FAT filesystems it&rsquo;s possible to use the <code>flush</code> option instead of <code>sync</code>. It asks the kernel to
flush all writes as soon as the drive becomes idle, but it does not preserve the order of writes, so
the kernel can optimize the write process.</p>
<h4 id="use-autofsync">Use autofsync</h4>
<p>On Ubuntu, it&rsquo;s possible to intercept some system calls for a process and add custom behavior. This
idea is used in the library called <a href="https://github.com/i-rinat/autofsync">autofsync</a>. It intercepts
<code>write()</code> call and performs <code>sync</code> operation when a certain amount of data were written to a file.
Limit size is adjusted at run time to keep <code>sync</code> durations around predefined value. The goal is to
express the writeback cache size limit in seconds rather than in bytes.</p>
<p>The library should be attached to the process using <code>LD_PRELOAD</code>:</p>
<pre tabindex="0"><code># Download and build library
git clone https://github.com/i-rinat/autofsync.git
cd autofsync
cmake .
make

# Start file manager
LD_PRELOAD=$PWD/autofsync.so mc
</code></pre><p>I prefer this method because it does not depend on the RAM size, flash drive speed, and also it is
filesystem independent solution. It changes the behavior of a particular process and does not affect
the whole system&rsquo;s performance.</p>
<h4 id="conclusion">Conclusion</h4>
<p>Using external disks is a rare operation nowadays, but it does not mean that it should be
inconvenient, so one of the solutions from the article can make the user experience much better.</p>
  <div class="post-date">
    <a href="../posts/wrong-copying-progress-and-long-disk-unmounting-on-ubuntu/"><time datetime="2021-01-04T11:00:00Z">Jan 4, 2021 11:00</time></a>
  </div>
</article><article class="post">
  <p>The idea of the majority of Linux distributions is to compile Linux kernel, collect existing Open
Source and proprietary software, test and then patch it if required, add something own and pack the
results into the packages, so users can install and use these programs. Ubuntu packages grouped into
APT repositories. Users can manage packages with <code>apt</code> command.</p>
<p>Software developers usually do not write all the code required by their programs, but use different
libraries and frameworks (e.g. graphical applications can use GTK to draw widgets like button or
label). It allows developers to save some time and make fewer bugs. As a result the majority of
software nowadays has dependencies. Different programs can depend on the same library (most of the
GUI programs in Gnome depend on GTK) that is why there is no need to install the same library
several times. Each APT package defines a list of dependencies, so when the user executes a command
like <code>apt install gnome-calculator</code> package manager install not only <code>gnome-calculator</code> itself but
also its dependencies like <code>libgtksourceview-4-0</code>.</p>
<p>Such an approach allows users to save disk space and reduce security risks: if there is some problem
in the common library it&rsquo;s enough to update it once and all dependent programs will use the new
version. Unfortunately, such an approach is not a silver bullet and has some downsides:</p>
<ul>
<li>Suppose two programs depend on different versions of the same library. It this case there will be
a conflict during dependencies resolution that is why <code>apt</code> command will fail and the user can&rsquo;t
install both programs at the same time.</li>
<li>Providers of third-party software like Viber or Skype have to make different packages of the same
product for different Ubuntu distributions, e.g. 18.04 and 20.04 have different versions of system
libraries that, so it&rsquo;s required to build and maintain two different packages for one program.</li>
<li><code>apt</code> installs each program globally so it will be a conflict when two packages try to create a
file with the same name.</li>
<li>Traditional programs can access all user files and resources that is why it&rsquo;s difficult to control
such software. In case of a security vulnerability in one program all user&rsquo;s files are in danger.</li>
</ul>
<p>Several years ago Ubuntu introduced <a href="https://snapcraft.io/">Snap</a> - a package manager with an
alternative approach, designed to solve <code>apt</code> problems.</p>
<p>The idea of this package manager is to pack not only the program but also all its dependencies into
one package called snap. In this case software maintainer prepares only one package for all versions
of Ubuntu and even other Linux distributions like Arch Linux, CentOS, or Manjaro. There are no
conflicts between different packages because there are no common dependencies, so it&rsquo;s normal when
two JavaScript applications use different versions of the Node.JS.</p>
<p>Snap especially useful when the user wants to try a new version of some program, e.g.
<a href="https://www.videolan.org/vlc/index.html">VLC</a>. With <code>apt</code>, it&rsquo;s not always safe because the
installation of one program can lead to updating some libraries required by another program and this
can make a conflict preventing the installation of the new program or even break the entire system.
That is why when I want to try some new unstable version of some software I have to use a virtual
machine that uses a lot more resources and also has some limitations. With Snap the programs are
isolated from each other that is why it&rsquo;s safe to try a new version of the software and return to a
stable one in case of troubles. For VLC I just execute a command:</p>
<pre tabindex="0"><code>sudo snap install vlc --channel=latest/edge
</code></pre><p>It installs a bleeding edge version of the popular media player. User can find their own balance
between stability and the latest features for each program.</p>
<p>By default each snap is isolated from the external world but what if it&rsquo;s required to interact with
the system? There is a well-known image editor <a href="https://www.gimp.org/">GIMP</a>. It&rsquo;s obvious that the
user wants to give GIMP access to the home directory, so it will be possible to edit photos. To
achieve this goal the <a href="https://snapcraft.io/docs/interface-management">mechanism of plugs and slots</a>
was introduced.  A snap describes the interfaces it requires. For each of the required interface,
snap defines a plug which will be connected to the corresponding slot by the <code>snapd</code> daemon either
automatically, or manually, depending on the interface. GIMP snap requires the <code>home</code> interface and
defines <code>gimp:home</code> plug. <code>snapd</code> daemon connects this plug to the <code>:home</code> slot, so GIMP can read
and write files in the user&rsquo;s home directory. There are a
<a href="https://snapcraft.io/docs/supported-interfaces">lot of different interfaces</a> that allow programs to
request access for resources like network, sound, or gpio. I think such an approach is very
convenient and increases security level because the user can give programs only required permissions
(like in iOS or Android) e.g. the user can forbid the browser to access the webcam and it will be
impossible to record the video from the webcam even in case of browser jailbreak.</p>
<p>Unfortunately, the isolation is not a free feature and the user has to pay some price for it:</p>
<ul>
<li>More data have to be downloaded: <code>apt install gimp</code> - 19Mb, <code>snap install gimp</code> - 263Mb.</li>
<li>Applications need more time to startup.</li>
<li>Application maintainers have to keep in mind that their applications would be run in the
isolated container. For one application there will be no difference but for another, there will be
plenty of issues with logging, packaging, and so on.</li>
</ul>
<p>Things I&rsquo;ve described above are fundamental problems of containerization and isolation. I agree to
pay such a price for the benefits I get, but there is an issue specific to Ubuntu snap. I know that
updates are important and it&rsquo;s better to update the system as soon as possible to reduce security
risks but I like to control updates myself. Usually, I disable auto-updates and call <code>apt upgrade</code>
every week but only when I have an actual backup and some time to solve possible update issues.
Auto-updates are one of the core concepts of Snap and it&rsquo;s impossible to disable this feature. I can
use
<a href="https://askubuntu.com/questions/1131182/how-can-i-disable-automatic-update-for-a-single-snap-in-ubuntu">some hacks</a>
like setting <code>refresh.hold=&quot;2030-01-01T00:00:00-00:00&quot;</code> to disable updates til 2030 but it looks
strange.</p>
<p><strong>Update</strong>: January 10, 2023, snapd 2.58 released, it&rsquo;s possible to disable auto-updates in Snap
from the stable channel.</p>
<p>Concluding, I don&rsquo;t think that all the software should be containerized but a Snap approach is very
useful for third-party programs. It can save a lot of time for developers and make the distribution
of Linux programs much easier for the developers and safer for the users. I think the Snaps package
manager or its alternatives like <a href="https://appimage.org/">AppImage</a> or
<a href="https://flatpak.org/">Flatpak</a> will be very widespread in near future.</p>
  <div class="post-date">
    <a href="../posts/ubuntu-snap-the-price-of-the-isolation/"><time datetime="2020-09-12T06:00:00Z">Sep 12, 2020 06:00</time></a>
  </div>
</article><article class="post">
  <p>JavaScript is one of the most popular programming languages nowadays. Originally it was created in
10 days by Brendan Eich in 1995 for building simple scripts on the web pages but now it&rsquo;s used for
the development of different types of applications like sophisticated frontend or highload backend
or even terminal tools - the one language to rule them all.</p>
<p>JavaScript evolves dramatically during the last 25 years. In 2020 it has a bunch of features that
allow developers to write elegant code for solving everyday problems. JavaScript object model
differs a lot from other languages like Java or Python. Some people in the community love
JavaScript, but it would be futile to deny that the language has some weird moments. In this
article, I&rsquo;ll try to describe the top 3 things in JavaScript that are most weird for me.</p>
<h2 id="3-inheritance">3. Inheritance</h2>
<p>JavaScript introduces the concept of objects as a collection of related data and functionality.
Programs create and manipulate objects to perform different actions and solve software problems. One
of the core concepts connected with objects is a
<a href="https://javascript.info/prototype-inheritance">prototypal inheritance</a>.</p>
<p>The idea of prototypal inheritance is simple: every object has a prototype and when the program
tries to receive one of the object&rsquo;s properties and doesn&rsquo;t find any value it tries to find this
property in the object&rsquo;s prototype.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> langs <span style="color:#719e07">=</span> [<span style="color:#2aa198">&#39;JavaScript&#39;</span>, <span style="color:#2aa198">&#39;Python&#39;</span>, <span style="color:#2aa198">&#39;Java&#39;</span>];
</span></span><span style="display:flex;"><span>console.log(langs.indexOf(<span style="color:#2aa198">&#39;Python&#39;</span>)); <span style="color:#586e75">// 1
</span></span></span></code></pre></div><p>In the example above object <code>langs</code> has no <code>indexOf</code> property but it has a prototype equals to
<code>Array.prototype</code> which has such property. That is why this code works.</p>
<p>It&rsquo;s possible to implement some functionality in the prototype and use it in all objects inherited
from this prototype:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">function</span> Country(name, capital) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">this</span>.name <span style="color:#719e07">=</span> name;
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">this</span>.capital <span style="color:#719e07">=</span> capital;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Country.prototype.print <span style="color:#719e07">=</span> <span style="color:#268bd2">function</span>() {
</span></span><span style="display:flex;"><span>  console.log(<span style="color:#586e75">`Country </span><span style="color:#2aa198">${</span><span style="color:#719e07">this</span>.name<span style="color:#2aa198">}</span><span style="color:#586e75"> with capital </span><span style="color:#2aa198">${</span><span style="color:#719e07">this</span>.capital<span style="color:#2aa198">}</span><span style="color:#586e75">`</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> Italy <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> Country(<span style="color:#2aa198">&#39;Italy&#39;</span>, <span style="color:#2aa198">&#39;Rome&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> Vietnam <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> Country(<span style="color:#2aa198">&#39;Vietnam&#39;</span>, <span style="color:#2aa198">&#39;Hanoi&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> Dominicana <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> Country(<span style="color:#2aa198">&#39;Dominican Republic&#39;</span>, <span style="color:#2aa198">&#39;Santo Domingo&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Italy.print();
</span></span><span style="display:flex;"><span>Vietnam.print();
</span></span><span style="display:flex;"><span>Dominicana.print();
</span></span></code></pre></div><p>All objects can use <code>print</code> method because it&rsquo;s defined in the prototype <code>Country.prototype</code>.</p>
<p>The idea of prototypal inheritance is simple but the devil is in the detail.</p>
<p>Almost every object has <code>Object.prototype</code> in its prototype chain and it can be mutated. This means
it&rsquo;s possible to add or overwrite some behavior for almost all objects:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#b58900">Object</span>.prototype.sayHello <span style="color:#719e07">=</span> () =&gt; { console.log(<span style="color:#2aa198">&#39;Hello!&#39;</span>) };
</span></span><span style="display:flex;"><span><span style="color:#2aa198">&#34;test string&#34;</span>.sayHello(); <span style="color:#586e75">// Hello!
</span></span></span></code></pre></div><p>From the one side, such a feature allows you to implement polyfills (like
<a href="https://github.com/zloirock/core-js">core-js</a> does) but from the other side, it can affect
performance if you accidentally replace native code by the polyfill or even break down some code
because you can&rsquo;t predict who and when will change core objects behavior.</p>
<p>Another operator related to inheritance is <a href="https://javascript.info/instanceof"><code>instanceof</code></a>. It
allows to check whether an object has some other object in its prototype chain:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">function</span> Country(name, capital) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">this</span>.name <span style="color:#719e07">=</span> name;
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">this</span>.capital <span style="color:#719e07">=</span> capital;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> Italy <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> Country(<span style="color:#2aa198">&#39;Italy&#39;</span>, <span style="color:#2aa198">&#39;Rome&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>console.log(Italy <span style="color:#719e07">instanceof</span> Country); <span style="color:#586e75">// true
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>console.log(Italy <span style="color:#719e07">instanceof</span> <span style="color:#b58900">Object</span>); <span style="color:#586e75">// true
</span></span></span></code></pre></div><p>In the code above <code>instanceof</code> checks if <code>Italy</code> object has <code>Country.prototype</code> and
<code>Object.prototype</code> in its prototype chain:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>Italy.__proto__ <span style="color:#719e07">===</span> Country.prototype
</span></span><span style="display:flex;"><span>Italy.__proto__ <span style="color:#719e07">===</span> <span style="color:#b58900">Object</span>.prototype
</span></span><span style="display:flex;"><span>Italy.__proto__.__proto__ <span style="color:#719e07">===</span> <span style="color:#b58900">Object</span>.prototype
</span></span></code></pre></div><p>The tricky question, is it possible to evaluate such code as true?</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>(a <span style="color:#719e07">instanceof</span> b) <span style="color:#719e07">&amp;&amp;</span> (b <span style="color:#719e07">instanceof</span> a);
</span></span></code></pre></div><p>At first sight, it seems impossible but <code>instanceof</code> checks not objects <code>a</code> and <code>b</code> but
<code>a.__proto__</code> and <code>b.prototype</code>. After such an observation it&rsquo;s possible to write such code:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> a <span style="color:#719e07">=</span> <span style="color:#268bd2">function</span>() {};
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> b <span style="color:#719e07">=</span> <span style="color:#268bd2">function</span>() {};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>a.__proto__ <span style="color:#719e07">=</span> b.prototype;
</span></span><span style="display:flex;"><span>b.__proto__ <span style="color:#719e07">=</span> a.prototype;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>console.log((a <span style="color:#719e07">instanceof</span> b) <span style="color:#719e07">&amp;&amp;</span> (b <span style="color:#719e07">instanceof</span> a)); <span style="color:#586e75">// true
</span></span></span></code></pre></div><p>The example above looks like a hack but it&rsquo;s easy to meet such case in real life:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> a <span style="color:#719e07">=</span> <span style="color:#b58900">Object</span>;
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> b <span style="color:#719e07">=</span> <span style="color:#b58900">Function</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>console.log((a <span style="color:#719e07">instanceof</span> b) <span style="color:#719e07">&amp;&amp;</span> (b <span style="color:#719e07">instanceof</span> a)); <span style="color:#586e75">// true
</span></span></span></code></pre></div><p>Almost every object in JavaScript has Object.prototype in it&rsquo;s prototype chain, but at the same time
Object is a constructor that is why it has Function.prototype in it&rsquo;s prototype chain.</p>
<p>Moreover for some objects even such case is possible:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>console.log(<span style="color:#b58900">Object</span> <span style="color:#719e07">instanceof</span> <span style="color:#b58900">Object</span>); <span style="color:#586e75">// true
</span></span></span></code></pre></div><h2 id="2-equality-operator-">2. Equality operator (==)</h2>
<p>As JavaScript is a dynamically typed language there is a problem of comparing values of different
types. E.g. there is a text field and a script expects user to input number but the value of the
text field is always a string. Developers can cast a value to a number manually or use an equality
operator. Sometimes it works as expected but in some cases, the behavior can be counterintuitive:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#2aa198">&#39;&#39;</span> <span style="color:#719e07">==</span> []; <span style="color:#586e75">// true
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>[] <span style="color:#719e07">==</span> []; <span style="color:#586e75">// false
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>[] <span style="color:#719e07">==</span> <span style="color:#719e07">!</span>[]; <span style="color:#586e75">// true
</span></span></span></code></pre></div><p>This example looks strange when array equals to an empty string but not equals to another empty
array and even more strange when <code>[]</code> equals <code>![]</code>. Fortunately, this behavior is described in
detail in the
<a href="https://www.ecma-international.org/ecma-262/#sec-abstract-equality-comparison">language spec</a> or
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Equality">MDN docs</a>:</p>
<ul>
<li>it is said that if one operand is an object and another is a string JavaScript tries to convert
an object into a string using <code>valueOf</code> and <code>toString</code> methods. That is why <code>'' == []</code>;</li>
<li>in case the operands are both objects equality operator returns true only if both operands
reference the same object. So <code>[] != []</code>, because there are two different objects;</li>
<li>in the last example <code>![]</code> converts the empty array to boolean value <code>true</code>, applies logical <code>NOT</code>
and make it <code>false</code> and then compares object and a boolean value. Logical <code>false</code> converted into
<code>0</code> and an empty array converted into <code>0</code>, so <code>0 == 0</code>.</li>
</ul>
<p>Equality operator can be tricky that is why I prefer to perform necessary type conversions myself
and use
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Strict_equality">strict equality</a>
which has a simpler algorithm.</p>
<h2 id="1-documentall">1. document.all</h2>
<p>The most insane thing in JavaScript that blows my mind completely is <code>document.all</code>. This property
is an <code>HTMLAllCollection</code> rooted at the document node. It returns all of the document&rsquo;s elements
accessible by order as in an array:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#b58900">document</span>.all[<span style="color:#2aa198">0</span>]; <span style="color:#586e75">// html node
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#b58900">document</span>.all[<span style="color:#2aa198">1</span>]; <span style="color:#586e75">// head node
</span></span></span></code></pre></div><p>At the same time, it&rsquo;s possible to use <code>document.all</code> as a function to access elements by identifier
like <code>document.getElementById</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#b58900">document</span>.all(<span style="color:#2aa198">&#39;btn&#39;</span>); <span style="color:#586e75">// equivalent to document.getElementById(&#39;btn&#39;)
</span></span></span></code></pre></div><p>Moreover <code>document.all</code> is the only falsy object accessible to JavaScript:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>console.log(<span style="color:#719e07">typeof</span> <span style="color:#b58900">document</span>.all); <span style="color:#586e75">// undefined
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>console.log(<span style="color:#b58900">document</span>.all <span style="color:#719e07">?</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">:</span> <span style="color:#2aa198">0</span>); <span style="color:#586e75">// 0
</span></span></span></code></pre></div><p>This was done using
<a href="https://tc39.es/ecma262/#sec-IsHTMLDDA-internal-slot">[[IsHTMLDDA]] internal slot</a> because of
compatibility with older versions of Internet Explorer.</p>
<p><code>document.all</code> is a proprietary Microsoft extension to the W3C standard. It&rsquo;s not recommended to use
but it still works in modern browsers like Firefox 78 or Google Chrome 83.</p>
<blockquote>
<p>– Proprietary extension in a Microsoft&rsquo;s browser. Take that off, what are you?</p>
</blockquote>
<blockquote>
<p>– Function, array, object, undefined.</p>
</blockquote>
<h2 id="conclusion">Conclusion</h2>
<p>When you start learning a new language there are a lot of weird things especially if the language
evolved a lot during the time. If you can&rsquo;t understand some behavior I suggest reading
<a href="https://www.ecma-international.org/ecma-262/">ECMAScript specification</a> or at least
<a href="https://developer.mozilla.org/en-US/docs/Web">developer.mozilla.org</a>. Also, there is an interesting
GitHub repo <a href="https://github.com/denysdovhan/wtfjs">wtfjs</a> which describes and explains a lot of
tricky JavaScript examples.</p>
<p>There is a game called <a href="https://alf.nu/ReturnTrue">ReturnTrue</a>. I don&rsquo;t think everyone would like it
but if you like competitive programming or want to understand JavaScript better it worth playing.</p>
  <div class="post-date">
    <a href="../posts/the-most-weird-parts-of-javascript/"><time datetime="2020-07-16T12:00:00Z">Jul 16, 2020 12:00</time></a>
  </div>
</article><article class="post">
  <p>A lot of frontend projects use <a href="https://webpack.js.org/">webpack</a> as a bundler tool. It allows to
transform, bundle, or package different resources like JavaScript, styles, images, or fonts.
Recently I&rsquo;d been exploring <a href="https://github.com/webpack/webpack">webpack sources</a> and I found
several interesting solutions to different programming problems that can be used in JavaScript
projects.</p>
<h2 id="function-context">Function context</h2>
<p>Webpack is a highly extensible tool. It allows to process different types of content like
<a href="https://github.com/webpack-contrib/coffee-loader">coffeescript</a> or
<a href="https://github.com/webpack-contrib/css-loader">css</a> using
<a href="https://webpack.js.org/api/loaders/">loaders</a>. The majority of loaders transform input content into
JavaScript, which can be handled by webpack. The simplest loader receives input data as an argument
and returns the result as a string:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>module.exports <span style="color:#719e07">=</span> <span style="color:#268bd2">function</span>(content, map, meta) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> <span style="color:#2aa198">&#34;module.exports = \&#34;Hello world\&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>More complicated loaders often perform different operations like async function calls, cache
control, or adding dependencies. In this case, a loader requires some sort of communication with
webpack but there is no explicit argument for this purpose. Loaders use a different approach:
calling methods of <code>this</code> context:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>module.exports <span style="color:#719e07">=</span> <span style="color:#268bd2">function</span>(content, map, meta) {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> callback <span style="color:#719e07">=</span> <span style="color:#719e07">this</span>.<span style="color:#268bd2">async</span>();
</span></span><span style="display:flex;"><span>  someAsyncOperation(content, <span style="color:#268bd2">function</span>(err, result) {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (err) <span style="color:#719e07">return</span> callback(err);
</span></span><span style="display:flex;"><span>    callback(<span style="color:#cb4b16">null</span>, result, map, meta);
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>The same approach was popular several years ago with <a href="https://jquery.com/">jQuery</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>$(<span style="color:#2aa198">&#34;li&#34;</span>).each(<span style="color:#268bd2">function</span>(index) {
</span></span><span style="display:flex;"><span>  console.log(index <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;: &#34;</span> <span style="color:#719e07">+</span> $(<span style="color:#719e07">this</span>).text());
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>The idea of providing <code>this</code> for a function call is one of the core ideas of JavaScript. E.g. it&rsquo;s
possible to bind the same callback to different links and determine which link was clicked using
<code>this</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#b58900">document</span>.querySelectorAll(<span style="color:#2aa198">&#39;a&#39;</span>).forEach(a =&gt; a.onclick <span style="color:#719e07">=</span> onLinkClick);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> onLinkClick() {
</span></span><span style="display:flex;"><span>  console.log(<span style="color:#586e75">`link clicked: </span><span style="color:#2aa198">${</span><span style="color:#719e07">this</span>.innerText<span style="color:#2aa198">}</span><span style="color:#586e75">`</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To implement webpack-like approach for loaders such code can be used:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#586e75">// Assume loader is a function described earlier
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> processLoaderResult(err, result) {
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// do something with loader result
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> context <span style="color:#719e07">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">async</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.callbackRequired <span style="color:#719e07">=</span> <span style="color:#cb4b16">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> (err, result) =&gt; {
</span></span><span style="display:flex;"><span>      processLoaderResult(err, result);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> result <span style="color:#719e07">=</span> loader.call(context, <span style="color:#2aa198">&#34;some module content&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>context.callbackRequired) {
</span></span><span style="display:flex;"><span>  processLoaderResult(<span style="color:#cb4b16">null</span>, result);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It&rsquo;s important to remember that
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">arrow functions</a>
do not allow to change <code>this</code> that is why it&rsquo;s impossible to use the arrow function as a complicated
loader:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>module.exports <span style="color:#719e07">=</span> content =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// this === global
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  <span style="color:#586e75">// this.async === undefined
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  <span style="color:#268bd2">const</span> callback <span style="color:#719e07">=</span> <span style="color:#719e07">this</span>.<span style="color:#268bd2">async</span>(); <span style="color:#586e75">// undefined is not a function
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>  someAsyncOperation(content, (err, result) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (err) <span style="color:#719e07">return</span> callback(err);
</span></span><span style="display:flex;"><span>    callback(<span style="color:#cb4b16">null</span>, result);
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>The idea of changing <code>this</code> context can be useful in different frameworks and libraries but in my
projects, I prefer to minimize using it. I think it&rsquo;s better to use <code>this</code> with classes and objects.
When I write a function I provide data for it as explicit arguments. If a function requires some
sort of context I provide it as a first argument:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">function</span> processRequest(context, request) {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> session <span style="color:#719e07">=</span> context.db.findSessionForUser(request.user);
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>}
</span></span></code></pre></div><p>In my opinion, such code is easier to understand (e.g. arguments can be described with
<a href="https://jsdoc.app/">JSDoc</a>) and it&rsquo;s possible to use arrow functions.</p>
<h2 id="tapable">Tapable</h2>
<p>Some of webpack algorithms consist of two parts: backbone behavior and customizations, e.g.
<a href="https://github.com/webpack/webpack/blob/542c6607c82879951005dd92bc9cdc9df1e76e2c/lib/Compilation.js#L1422-L1466">adding an entrypoint</a>
performs some operations and then calls <code>addEntry</code> hook:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#719e07">this</span>.hooks.addEntry.call(entry, options);
</span></span></code></pre></div><p>A hook is a way of defining an extension point. Plugins can bind callbacks to a hook and webpack
will execute these callbacks at some point in its algorithm.</p>
<p>Such an approach allows to customize different stages of the build process. Moreover some internal
code like
<a href="https://github.com/webpack/webpack/blob/542c6607c82879951005dd92bc9cdc9df1e76e2c/lib/rules/RuleSetCompiler.js#L1">RuleSetCompiler</a>
consists of hooks almost completely. Webpack uses <a href="https://github.com/webpack/tapable">Tapable</a>
library to introduce and execute hooks.</p>
<p>Take a look at the example. Assume there is a task of processing user requests. There are some
common logic and several independent actions that should be performed for each request. Code for
such case can be implemented like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> { SyncHook } <span style="color:#719e07">=</span> require(<span style="color:#2aa198">&#34;tapable&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">class</span> RequestProcessor {
</span></span><span style="display:flex;"><span>  constructor() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.hooks <span style="color:#719e07">=</span> {
</span></span><span style="display:flex;"><span>      processRequest<span style="color:#719e07">:</span> <span style="color:#719e07">new</span> SyncHook(<span style="color:#2aa198">&#34;request&#34;</span>)
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">async</span> processRequests() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">while</span> (<span style="color:#cb4b16">true</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">const</span> request <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> <span style="color:#719e07">this</span>.getRequest();
</span></span><span style="display:flex;"><span>      logRequest(request);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.hooks.call(request);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> requestProcessor <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> RequestProcessor();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>requestProcessor.hooks.tap(<span style="color:#2aa198">&#34;email&#34;</span>, (request) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// send email
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>requestProcessor.hooks.tap(<span style="color:#2aa198">&#34;db&#34;</span>, (request) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// save info to db
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>requestProcessor.hooks.tap(<span style="color:#2aa198">&#34;stats&#34;</span>, (request) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// calculate some stats
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>requestProcessor.processRequests();
</span></span></code></pre></div><p>It&rsquo;s similar with events processing in the browser when the developer adds several callbacks for
some event of the DOM node and the browser calls them when the event occurs:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> btn <span style="color:#719e07">=</span> ducument.getElementById(<span style="color:#2aa198">&#39;main-btn&#39;</span>);
</span></span><span style="display:flex;"><span>btn.addEventListener(<span style="color:#2aa198">&#39;click&#39;</span>, showBanner);
</span></span><span style="display:flex;"><span>btn.addEventListener(<span style="color:#2aa198">&#39;click&#39;</span>, calculateStats);
</span></span></code></pre></div><p>Tapable provides different types of hooks: synchronous, asynchronous, sequential, parallel, and so
on. That is why it&rsquo;s possible to embed hooks in almost every algorithm when required.</p>
<p>The idea of hooks looks reasonable for libraries and big projects but can be an overkill for the
small ones: sometimes it can be very difficult to debug such code because of hidden connection
between the event emitter and the event listener.</p>
<h2 id="neo-async">neo-async</h2>
<p>A lot of projects noways uses collection methods like <code>forEach</code> or <code>map</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>users.forEach(user =&gt; print(user));
</span></span><span style="display:flex;"><span>emails <span style="color:#719e07">=</span> users.map(user =&gt; user.email);
</span></span></code></pre></div><p>These methods are useful for synchronous code but can&rsquo;t be used with asynchronous code. One of the
solutions to such a problem is a <a href="https://github.com/suguru03/neo-async">neo-async</a> library:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> <span style="color:#268bd2">async</span> <span style="color:#719e07">=</span> require(<span style="color:#2aa198">&#39;neo-async&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">// array
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#268bd2">const</span> userIds <span style="color:#719e07">=</span> [<span style="color:#2aa198">1</span>, <span style="color:#2aa198">2</span>, <span style="color:#2aa198">3</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> iterator <span style="color:#719e07">=</span> (userId, done) {
</span></span><span style="display:flex;"><span>  fetchUserInfo(userId).then(info =&gt; {
</span></span><span style="display:flex;"><span>    done(<span style="color:#cb4b16">null</span>, info);
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">async</span>.map(array, iterator, (err, res) =&gt; {
</span></span><span style="display:flex;"><span>  console.log(res);
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>neo-async is useful for the code with callbacks but my code often uses <code>Promises</code> and <code>async/await</code>
that is why I prefer a different approach. When the order of execution is not important I write such
code:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> userIds <span style="color:#719e07">=</span> [<span style="color:#2aa198">1</span>, <span style="color:#2aa198">2</span>, <span style="color:#2aa198">3</span>];
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> res <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> <span style="color:#b58900">Promise</span>.all(userIds.map(fetchUserInfo));
</span></span><span style="display:flex;"><span>console.log(res);
</span></span></code></pre></div><p>In case when the order is important and functions should be performed one after another I write such
code:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> userIds <span style="color:#719e07">=</span> [<span style="color:#2aa198">1</span>, <span style="color:#2aa198">2</span>, <span style="color:#2aa198">3</span>];
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> res <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> userIds.reduce(<span style="color:#268bd2">async</span> (promise, userId) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> infos <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> promise;
</span></span><span style="display:flex;"><span>  infos.push(<span style="color:#268bd2">await</span> fetchUserInfo(userId));
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> infos;
</span></span><span style="display:flex;"><span>}, <span style="color:#b58900">Promise</span>.resolve([]));
</span></span><span style="display:flex;"><span>console.log(res);
</span></span></code></pre></div><h2 id="needcalls">needCalls</h2>
<p>In the
<a href="https://github.com/webpack/webpack/blob/8070bcd333cd1d07ce13fe5e91530c80779d51c6/lib/NormalModuleFactory.js#L91-L101">NormalModuleFactory.js</a>
I&rsquo;ve found helper:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> needCalls <span style="color:#719e07">=</span> (times, callback) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> err =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">--</span>times <span style="color:#719e07">===</span> <span style="color:#2aa198">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> callback(err);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (err <span style="color:#719e07">&amp;&amp;</span> times <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span>) {
</span></span><span style="display:flex;"><span>      times <span style="color:#719e07">=</span> <span style="color:#cb4b16">NaN</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> callback(err);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>The idea of it is to call some callback after several asynchronous operations or as soon as an error
occurs:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> callback <span style="color:#719e07">=</span> needCalls(<span style="color:#2aa198">3</span>, (err) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">if</span> (err) {
</span></span><span style="display:flex;"><span>    console.log(<span style="color:#586e75">`Error found: </span><span style="color:#2aa198">${</span>err<span style="color:#2aa198">}</span><span style="color:#586e75">`</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#719e07">else</span> {
</span></span><span style="display:flex;"><span>    console.log(<span style="color:#2aa198">&#34;Operations completed&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncOperation1(callback);
</span></span><span style="display:flex;"><span>asyncOperation2(callback);
</span></span><span style="display:flex;"><span>asyncOperation3(callback);
</span></span></code></pre></div><p>I think this helper can be very useful in some cases.</p>
<h2 id="recursion-and-stack">Recursion and stack</h2>
<p>When a program calls the function JavaScript Virtual Machine saves the current position of the code,
executes the required function, and returns to the saved position.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> result <span style="color:#719e07">=</span> add(<span style="color:#2aa198">1</span>, <span style="color:#2aa198">2</span>);
</span></span><span style="display:flex;"><span>console.log(result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> add(a, b) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> a <span style="color:#719e07">+</span> b;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In the example above at the first line function <code>add</code> is called. At this moment JavaScript saves
the position at line 1 and starts execution of <code>add</code> function. After the function returns the value
JavaScript returns to line 1 and continues the execution.</p>
<p>A mechanism that stores these positions is called the
<a href="https://developer.mozilla.org/en-US/docs/Glossary/Call_Stack">call stack</a>. The size of the call
stack is limited so if a program has a lot of nested function calls it can lead to the stack
overflow error.</p>
<p>When a program processes graph structures it&rsquo;s essential to use recursion algorithms. Each step of
recursion adds a new frame into the call stack that is why if graph depth is big enough it&rsquo;s
possible to receive a stack overflow error.</p>
<p>It&rsquo;s easy to check maximum stack size using the example from
<a href="https://stackoverflow.com/questions/7826992/browser-javascript-stack-size-limit">StackOverflow</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">let</span> i <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setTimeout(<span style="color:#268bd2">function</span>() {
</span></span><span style="display:flex;"><span>  console.log(i);
</span></span><span style="display:flex;"><span>}, <span style="color:#2aa198">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> inc() {
</span></span><span style="display:flex;"><span>  i<span style="color:#719e07">++</span>;
</span></span><span style="display:flex;"><span>  inc();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>inc();
</span></span></code></pre></div><p>Webpack can process a huge amount of modules and dependencies during the building of the chunk graph
that is why an interesting solution of stack overflow problem was introduced: recursion was replaced
by the
<a href="https://github.com/webpack/webpack/blob/292036f714543530e0465ebced4585fc26685409/lib/buildChunkGraph.js#L760-L800">loop over actions queue</a>.
Webpack starts building a chunk graph from entrypoints. When a new module is discovered webpack adds
it into the queue, processes it, and remove it from the queue. The queue looks like a call stack but
its size is not limited that is why it can use the whole available memory of the computer.</p>
<p>Let&rsquo;s solve a simple task with such an approach. Assume there is such graph structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> graph <span style="color:#719e07">=</span> {
</span></span><span style="display:flex;"><span>  value<span style="color:#719e07">:</span> <span style="color:#2aa198">10</span>,
</span></span><span style="display:flex;"><span>  children<span style="color:#719e07">:</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      value<span style="color:#719e07">:</span> <span style="color:#2aa198">5</span>,
</span></span><span style="display:flex;"><span>      children<span style="color:#719e07">:</span> [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          value<span style="color:#719e07">:</span> <span style="color:#2aa198">15</span>,
</span></span><span style="display:flex;"><span>          children<span style="color:#719e07">:</span> []
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      value<span style="color:#719e07">:</span> <span style="color:#2aa198">20</span>,
</span></span><span style="display:flex;"><span>      children<span style="color:#719e07">:</span> [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          value<span style="color:#719e07">:</span> <span style="color:#2aa198">1</span>,
</span></span><span style="display:flex;"><span>          children<span style="color:#719e07">:</span> []
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Each node has a positive integer value and an array of children. The task is to find the maximum
value in such a graph.</p>
<p>A solution using recursion can be like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>console.log(findMax(graph));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> findMax(node) {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">let</span> maxValue <span style="color:#719e07">=</span> node.value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  node.children.forEach(child =&gt; {
</span></span><span style="display:flex;"><span>    maxValue <span style="color:#719e07">=</span> <span style="color:#b58900">Math</span>.max(maxValue, findMax(child));
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> maxValue;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>A solution using a manual stack can be like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>console.log(findMax(graph));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> findMax(node) {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">let</span> maxValue <span style="color:#719e07">=</span> node.value;
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> queue <span style="color:#719e07">=</span> [node];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">while</span> (queue.length) {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">const</span> queueItem <span style="color:#719e07">=</span> queue.pop();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    maxValue <span style="color:#719e07">=</span> <span style="color:#b58900">Math</span>.max(maxValue, queueItem.value);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    queueItem.children.forEach(child =&gt; {
</span></span><span style="display:flex;"><span>      queue.push(child);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> maxValue;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I think a code with a manual stack is more difficult to read and understand so use it only if you
have some problems with recursion.</p>
<p>Coming to a conclusion I want to say that it&rsquo;s very useful to explore the code of open source
projects. Even if you will not use such algorithms in your software it lets you look on everyday
problems from another perspective and become a better developer.</p>
  <div class="post-date">
    <a href="../posts/interesting-things-from-webpack-sources/"><time datetime="2020-06-17T11:00:00Z">Jun 17, 2020 11:00</time></a>
  </div>
</article><article class="post">
  <p>Once upon a time my colleague and I were working on end-to-end tests of one Angular.JS application.
We used Node.js v8.9.1. Tests had such workflow:</p>
<ul>
<li>open a page;</li>
<li>click an element;</li>
<li>check if the page has some content.</li>
</ul>
<p>As you can see it&rsquo;s just a regular workflow for end-to-end tests, nothing special. Such tests allow
us to reduce the amount of manual testing and eliminate bugs before the code will be delivered to
the users. There was a piece of code that makes a screenshot of the page in case of test failure.
Such behavior makes it easier to debug tests. The problem was that sometimes a test fails but there
was no screenshot.</p>
<p>The code of a test looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>beforeEach(<span style="color:#268bd2">async</span> <span style="color:#268bd2">function</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">this</span>.browser <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> prepareBrowser();
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>afterEach(<span style="color:#268bd2">async</span> <span style="color:#268bd2">function</span>() =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">if</span> (<span style="color:#719e07">this</span>.currentTest.state <span style="color:#719e07">===</span> <span style="color:#2aa198">&#39;failed&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">await</span> <span style="color:#719e07">this</span>.browser.makeScreenshot();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>it(<span style="color:#2aa198">&#39;likes post&#39;</span>, <span style="color:#268bd2">async</span> <span style="color:#268bd2">function</span>() =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">await</span> <span style="color:#719e07">this</span>.browser.open(<span style="color:#2aa198">&#39;/&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">await</span> <span style="color:#719e07">this</span>.browser.click(<span style="color:#2aa198">&#39;like&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">await</span> <span style="color:#719e07">this</span>.browser.waitForText(<span style="color:#2aa198">&#39;1 like&#39;</span>);
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>It uses <a href="https://mochajs.org/">mocha</a> test runner and <code>this.browser</code> object uses
<a href="https://github.com/puppeteer/puppeteer/">puppeteer</a> under the hood. It was a heisenbug: when I was
trying to reproduce it on the local machine a screenshot was always in place. Moreover, after a
simple <code>console.log</code> had been added into <code>afterEach</code> block the bug disappeared completely:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>afterEach(<span style="color:#268bd2">async</span> <span style="color:#268bd2">function</span>() =&gt; {
</span></span><span style="display:flex;"><span>  console.log(<span style="color:#719e07">this</span>.browser);
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">if</span> (<span style="color:#719e07">this</span>.currentTest.state <span style="color:#719e07">===</span> <span style="color:#2aa198">&#39;failed&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">await</span> <span style="color:#719e07">this</span>.browser.makeScreenshot();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>How is it possible?</p>
<p>To understand it we need to go deeper. There are two sources of errors in this test:</p>
<ul>
<li>errors caused by test commands (<code>open</code>, <code>click</code>, <code>waitForText</code>);</li>
<li>errors caused by the browser (if some script on the page emits an error - the test should fail).</li>
</ul>
<p>If a test command throws an exception then mocha processes it and fails the test. <code>afterEach</code> block
checks that the test has been failed and makes a screenshot. There was such code for the browser
object:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#586e75">// commands directory contains a file per command
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">// (click, waitForText, makeScreenshot, etc.)
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#268bd2">const</span> commands <span style="color:#719e07">=</span> require(<span style="color:#2aa198">&#39;./commands&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> proxyHandler <span style="color:#719e07">=</span> {
</span></span><span style="display:flex;"><span>  get(target, property) {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (property <span style="color:#719e07">in</span> commands) {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> (...args) =&gt; {
</span></span><span style="display:flex;"><span>        target.checkForErrors();
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> commands[property](target, ...args);
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> target[property];
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">class</span> Browser {
</span></span><span style="display:flex;"><span>  <span style="color:#586e75">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>
</span></span><span style="display:flex;"><span>  checkForErrors() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">this</span>.browserErrors.length <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.browserErrors <span style="color:#719e07">=</span> [];
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">throw</span> <span style="color:#719e07">new</span> <span style="color:#b58900">Error</span>(<span style="color:#2aa198">&#39;Browser has errors&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> prepareBrowser() {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> browser <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> Browser();
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> <span style="color:#719e07">new</span> <span style="color:#b58900">Proxy</span>(browser, proxyHandler);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Every command is a function stored in a separate file from the <code>commands</code> directory. Commands
are connected to the browser object using a
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">proxy</a>
mechanism. A proxy is an object which stands in front of the other object and intercepts every
property lookup, assignment, and other fundamental operations. Before performing the command proxy
checks if there were some errors emitted by the browser and throws an error if required.</p>
<p>Consider the case when &ldquo;like&rdquo; button is broken:</p>
<ul>
<li><code>browser.open('/')</code> opens the page;</li>
<li><code>browser.click('like')</code> executed successfuly;</li>
<li><code>browser.waitForText('1 like')</code> fails;</li>
<li><code>browser.makeScreenshot()</code> works as expected.</li>
</ul>
<p>Consider another case when some script on the page (let it be called <code>script.js</code>) throws an error:</p>
<ul>
<li><code>browser.open('/')</code> opens the page;</li>
<li><code>script.js</code> throws an error so <code>browserErrors</code> is not empty;</li>
<li><code>browser.click('like')</code> checks <code>browserErrors</code> and throws an error;</li>
<li><code>browser.makeScreenshot()</code> works as expected.</li>
</ul>
<p>Finally, consider the rare case which can be reproduced only on the heavily loaded machine (e.g.  CI
server running tests of several projects simultaneously): &ldquo;like&rdquo; button is broken and <code>script.js</code>
throws an error during the execution of <code>browser.waitForText</code> command:</p>
<ul>
<li><code>browser.open('/')</code> opens the page;</li>
<li><code>browser.click('like')</code> executed successfully;</li>
<li><code>browser.waitForText('1 like')</code> is waiting for the text;</li>
<li><code>script.js</code> throws an error so <code>browserErrors</code> is not empty;</li>
<li><code>browser.waitForText('1 like')</code> fails;</li>
<li><code>browser.makeScreenshot()</code> checks <code>browserErrors</code> and throws an error.</li>
</ul>
<p>In this case, screenshot is not generated. It&rsquo;s difficult to predict when <code>script.js</code> will throw an
error that is why it was difficult to reproduce the bug. The reason for the bug is found and it can
be fixed by removing checking for errors for particular command:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#268bd2">const</span> proxyHandler <span style="color:#719e07">=</span> {
</span></span><span style="display:flex;"><span>  get(target, property) {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (property <span style="color:#719e07">in</span> commands) {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> (...args) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>commands[property].skipCheckForErrors) {
</span></span><span style="display:flex;"><span>          target.checkForErrors();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> commands[property](target, ...args);
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> target[property];
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>How <code>console.log</code> can influence this situation? Why adding <code>console.log</code> makes <code>makeScreenshot</code>
function work as expected?  When Node.js prints object it tries to convert it to a string using
<code>valueOf</code> method that is why it works so:</p>
<ul>
<li><code>console.log(browser)</code> causes call of <code>browser.valueOf()</code>;</li>
<li><code>browser.valueOf()</code> intercepted by proxy;</li>
<li><code>commands</code> array has <code>valueOf</code> property because of prototype inheritance, so proxy calls
<code>checkForErrors</code>, clean up <code>browserErrors</code> and emits an error;</li>
<li>Node.js supress this error;</li>
<li><code>browser.makeScreenshot()</code> works without errors.</li>
</ul>
<p>To remove such unexpected behavior it&rsquo;s better to check availability of <code>property</code> in the <code>commands</code>
object using <code>Object.keys()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#268bd2">const</span> proxyHandler <span style="color:#719e07">=</span> {
</span></span><span style="display:flex;"><span>  get(target, property) {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (<span style="color:#b58900">Object</span>.keys(commands).includes(property)) {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> (...args) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>commands[property].skipCheckForErrors) {
</span></span><span style="display:flex;"><span>          target.checkForErrors();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> commands[property](target, ...args);
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> target[property];
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>The behavior of <code>console.log</code> is different in different versions of Node.js. I used such a piece of
code to check it:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#268bd2">class</span> Foo {
</span></span><span style="display:flex;"><span>  constructor() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.a <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;b&#39;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> foo <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> Foo();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> p <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> <span style="color:#b58900">Proxy</span>(foo, {
</span></span><span style="display:flex;"><span>  get(obj, prop) {
</span></span><span style="display:flex;"><span>    console.log(<span style="color:#586e75">`</span><span style="color:#2aa198">${</span>prop.toString()<span style="color:#2aa198">}</span><span style="color:#586e75"> called`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> obj[prop];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>console.log(p);
</span></span></code></pre></div><p>I got such results:</p>
<table>
<thead>
<tr>
<th>Version</th>
<th>Methods called sequentially</th>
</tr>
</thead>
<tbody>
<tr>
<td>v8.9.1</td>
<td><code>util.inspect.custom</code>, <code>inspect</code>, <code>Symbol.iterator</code>, <code>Symbol.toStringTag</code>, <code>valueOf</code></td>
</tr>
<tr>
<td>v10.15.1</td>
<td><code>nodejs.util.inspect.custom</code>, <code>inspect</code>, <code>Symbol.toStringTag</code>, <code>Symbol.iterator</code></td>
</tr>
<tr>
<td>v12.14.1</td>
<td>no methods called</td>
</tr>
</tbody>
</table>
<p>Coming to the conclusion remember about prototype inheritance checking object&rsquo;s properties and be
cautious with <code>console.log</code> because it can have different behavior for complex structures in
different JavaScript engines.</p>

  <div class="post-date">
    <a href="../posts/proxy-and-magical-print/"><time datetime="2020-01-22T08:00:00Z">Jan 22, 2020 08:00</time></a>
  </div>
</article><article class="post">
  <p>Several days ago I was updating one of my React projects and I found deprecation warning like:</p>
<blockquote>
<p>Warning: componentWillMount has been renamed, and is not recommended for use. See
<a href="https://fb.me/react-unsafe-component-lifecycles">https://fb.me/react-unsafe-component-lifecycles</a> for details.</p>
<ul>
<li>Move code with side effects to componentDidMount, and set initial state in the constructor.</li>
<li>Rename componentWillMount to UNSAFE_componentWillMount to suppress this warning in non-strict
mode. In React 17.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their
new names, you can run <code>npx react-codemod rename-unsafe-lifecycles</code> in your project source folder.</li>
</ul>
</blockquote>
<p>I had followed <a href="https://fb.me/react-unsafe-component-lifecycles">the link from this warning</a> and
found such an explanation about why this method is deprecated:</p>
<blockquote>
<p>One of the biggest lessons we’ve learned is that some of our legacy component lifecycles tend to
encourage unsafe coding practices. They are:</p>
<ul>
<li>componentWillMount</li>
<li>componentWillReceiveProps</li>
<li>componentWillUpdate</li>
</ul>
<p>These lifecycle methods have often been misunderstood and subtly misused; furthermore, we
anticipate that their potential misuse may be more problematic with async rendering.</p>
</blockquote>
<p>I think it&rsquo;s important to understand why using <code>componentWillMount</code> callback can be unsafe and why
you need to change your code somehow. First of all, let&rsquo;s find out different usage examples of
<code>componentWillMount</code> callback and check if it is safe or not to use this callback in different
situations in the stable version of React 16.12.0 for browser rendering (there are some issues
with server rendering but it&rsquo;s a subject of a separate article).</p>
<h3 id="initializing-state">Initializing state</h3>
<p>When a component needs initial state it can be provided like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">class</span> Counter <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>  state <span style="color:#719e07">=</span> {};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  componentWillMount() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.setState({ value<span style="color:#719e07">:</span> <span style="color:#2aa198">0</span> });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In this case, using <code>componentWillMount</code> is safe and it makes no troubles. It&rsquo;s possible to make
your code a bit more clear and use property initializer like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">class</span> Counter <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>  state <span style="color:#719e07">=</span> { value<span style="color:#719e07">:</span> <span style="color:#2aa198">0</span> };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>But I think there are no problems with <code>componentWillMount</code> here.</p>
<h3 id="fetching-external-data">Fetching external data</h3>
<p>Some components need external data from the server and it&rsquo;s possible to fetch it this way:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">class</span> TariffSelector <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>  state <span style="color:#719e07">=</span> { tariffs<span style="color:#719e07">:</span> [] };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  componentWillMount() {
</span></span><span style="display:flex;"><span>    fetchTariffs().then(tariffs =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.setState({ tariffs });
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  render() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">select</span>&gt;
</span></span><span style="display:flex;"><span>        {<span style="color:#719e07">this</span>.tariffs.map(tariff =&gt; &lt;<span style="color:#268bd2">option</span> value<span style="color:#719e07">=</span>{tariff.value}&gt;{tariff.caption}&lt;/<span style="color:#268bd2">option</span>&gt;)}
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#268bd2">select</span>&gt;
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>React documentation says:</p>
<blockquote>
<p>The above code is problematic for both server rendering (where the external data won’t be used)
and the upcoming async rendering mode (where the request might be initiated multiple times).</p>
</blockquote>
<p>There are two different conceptions in React: async rendering and concurrent rendering. They are
similar but not the same. We&rsquo;ll discuss it later in more details but for now, I can say that there
are no problems with <code>componentWillMount</code> when we are talking about async rendering. The callback
will be called only once. Async rendering is enabled in React 16.12.0 by default. There can be
some troubles with <code>componentWillMount</code> when we are talking about
<a href="https://reactjs.org/docs/concurrent-mode-intro.html">concurrent rendering</a> but it&rsquo;s still
experimental and disabled in the current version of React by default.</p>
<p>It&rsquo;s important to remember that <code>componentWillMount</code> is a sync function so in the example above
the first call of <code>render</code> will be performed with empty <code>tariffs</code>. That is why it&rsquo;s essential to be
ready for such a case and provide some loading state if it is required.</p>
<h3 id="adding-event-listeners">Adding event listeners</h3>
<p>Some components subscribe to an external event dispatcher on the mount stage and unsubscribe on the
unmount stage:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">class</span> Chat <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>  componentWillMount() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.props.chatService.subscribe(<span style="color:#2aa198">&#39;newMessage&#39;</span>, <span style="color:#719e07">this</span>.handleNewMessage);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  componentWillUnmount() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.props.chatService.unsubscribe(<span style="color:#2aa198">&#39;newMessage&#39;</span>, <span style="color:#719e07">this</span>.handleNewMessage);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  handleNewMessage <span style="color:#719e07">=</span> (msg) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.setState({ newMessage<span style="color:#719e07">:</span> msg });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As it is said in React documentation this code can be dangerous for server rendering and async
rendering mode. Actually, it&rsquo;s safe for async rendering mode and dangerous for concurrent mode.</p>
<p>Async rendering mode was mentioned several times in React documentation when talking about
<code>componentWillMount</code>. Let&rsquo;s talk a bit more about it.</p>
<h3 id="react-fiber-architecture-and-async-rendering">React Fiber Architecture and Async Rendering</h3>
<p>When you have a lot of components on the page rendering can take a lot of time but the browser has
to update screen 60 times per second to make animations and scrolling smooth. If the rendering takes
more than 16ms browser has to drop frames and animations look choppy. React 15 and older versions
perform rendering of the whole application as a single task that is why it was difficult to provide
good user experience for big applications.</p>
<p>In React 16 new Fiber Architecture was introduced. The idea is to split rendering into several
chunks and perform them independently. Let&rsquo;s take a look at the example:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">function</span> App() {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">Header</span> /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">Content</span> /&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> Header() {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#268bd2">header</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">h1</span>&gt;My Application&lt;/<span style="color:#268bd2">h1</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#268bd2">header</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">class</span> Content <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>  state <span style="color:#719e07">=</span> { article<span style="color:#719e07">:</span> <span style="color:#cb4b16">null</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  componentDidMount() {
</span></span><span style="display:flex;"><span>    fetchArticle().then(article =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.setState({ article });
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  render() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">this</span>.state.article) {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> &lt;<span style="color:#268bd2">div</span> className<span style="color:#719e07">=</span>{<span style="color:#2aa198">&#39;content&#39;</span>}&gt;{<span style="color:#719e07">this</span>.state.article}&lt;/<span style="color:#268bd2">div</span>&gt;;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> <span style="color:#cb4b16">null</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ReactDOM.render(&lt;<span style="color:#268bd2">App</span> /&gt;, <span style="color:#b58900">document</span>.getElementById(<span style="color:#2aa198">&#39;root&#39;</span>));
</span></span></code></pre></div><p>To understand how this code works, first of all, let&rsquo;s remove jsx and see how this code will look
like:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#268bd2">function</span> App() {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> React.createElement(
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#39;div&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cb4b16">null</span>,
</span></span><span style="display:flex;"><span>    React.createElement(
</span></span><span style="display:flex;"><span>      Header,
</span></span><span style="display:flex;"><span>      <span style="color:#cb4b16">null</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    React.createElement(
</span></span><span style="display:flex;"><span>      Content,
</span></span><span style="display:flex;"><span>      <span style="color:#cb4b16">null</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> Header() {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> React.createElement(
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#39;header&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cb4b16">null</span>,
</span></span><span style="display:flex;"><span>    React.createElement(
</span></span><span style="display:flex;"><span>      <span style="color:#2aa198">&#39;h1&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#cb4b16">null</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#2aa198">&#39;My Application&#39;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">class</span> Content <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>  state <span style="color:#719e07">=</span> { article<span style="color:#719e07">:</span> <span style="color:#cb4b16">null</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  componentDidMount() {
</span></span><span style="display:flex;"><span>    fetchArticle().then(article =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.setState({
</span></span><span style="display:flex;"><span>        article
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  render() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">this</span>.state.article) {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> React.createElement(
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#39;div&#39;</span>, {
</span></span><span style="display:flex;"><span>        className<span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;content&#39;</span>
</span></span><span style="display:flex;"><span>      }, <span style="color:#719e07">this</span>.state.article);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> <span style="color:#cb4b16">null</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ReactDOM.render(React.createElement(App, <span style="color:#cb4b16">null</span>), <span style="color:#b58900">document</span>.getElementById(<span style="color:#2aa198">&#39;root&#39;</span>));
</span></span></code></pre></div><p>As you can see React creates elements using <code>createElement</code> function. This function returns plain
JS object like:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  type<span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;h1&#39;</span>,
</span></span><span style="display:flex;"><span>  props<span style="color:#719e07">:</span> {
</span></span><span style="display:flex;"><span>    children<span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;My Application&#39;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>You can find more information about this topic in
<a href="https://reactjs.org/docs/introducing-jsx.html">Introducing JSX</a> article.</p>
<p>To build the final virtual DOM React needs to perform several steps.</p>
<p><strong>Step 1:</strong> convert</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  type<span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;App&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>into</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  type<span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;div&#39;</span>,
</span></span><span style="display:flex;"><span>  props<span style="color:#719e07">:</span> {
</span></span><span style="display:flex;"><span>    children<span style="color:#719e07">:</span> [
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        type<span style="color:#719e07">:</span> Header
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        type<span style="color:#719e07">:</span> Content
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Step 2:</strong> convert <code>Header</code> child into</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  type<span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;header&#39;</span>,
</span></span><span style="display:flex;"><span>  props<span style="color:#719e07">:</span> {
</span></span><span style="display:flex;"><span>    children<span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;My Application&#39;</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p><strong>Step 3:</strong> create instance of <code>Content</code> class and call it&rsquo;s <code>render</code> function. It returns <code>null</code>
because data is loaded asynchronously in the <code>componentDidUpdate</code> hook.</p>
<p><strong>Step 4:</strong> in response to <code>setState</code> update state and call <code>render</code> for <code>Content</code> class instance
again what will lead to final result like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  type<span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;div&#39;</span>,
</span></span><span style="display:flex;"><span>  props<span style="color:#719e07">:</span> {
</span></span><span style="display:flex;"><span>    className<span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;content&#39;</span>,
</span></span><span style="display:flex;"><span>    children<span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;Hello world&#39;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>After these steps React can get final virtual DOM and perform changes in the browser&rsquo;s DOM. The
process described above is called <a href="https://reactjs.org/docs/reconciliation.html">Reconciliation</a>.</p>
<p>In React 15 and earlier versions steps 1 - 3 processed synchronously as a single task. It&rsquo;s OK
for simple cases but when a component tree is big enough it can become a problem.</p>
<p>In React 16 Fiber Architecture was introduced. This approach treats each step as a separate task
that is why rendering can be paused and the browser can process animations. It makes the application
more smooth and responsive. <a href="https://github.com/acdlite">Andrew Clark</a> wrote
<a href="https://github.com/acdlite/react-fiber-architecture">a good description of Fiber Architecture</a> and
also present it on ReactNext 2016: <a href="https://youtu.be/aV1271hd9ew">https://youtu.be/aV1271hd9ew</a>.</p>
<p>Even more detailed explanation can be found in a post by
<a href="https://blog.ag-grid.com/author/maxkoretskyi/">Max Koretskyi</a>
<a href="https://blog.ag-grid.com/inside-fiber-an-in-depth-overview-of-the-new-reconciliation-algorithm-in-react/">Inside Fiber: an in-depth overview of the new reconciliation algorithm in React</a>.
It&rsquo;s definitely worth reading.</p>
<p>There was a lot of information about Fiber during React Conf 2017. You can find
<a href="https://www.youtube.com/playlist?list=PLb0IAmt7-GS3fZ46IGFirdqKTIxlws7e0">records of the conference on youtube</a>.</p>
<p>And of course, the best way to understand Fiber Architecture is by exploring the code of React.
You can create a small application set breakpoints and follow the execution step by step. A lot of
interesting things can be found this way.</p>
<p>For now, you need to remember that React uses Fiber Architecture. It splits rendering into pieces
and executes each piece asynchronously until all work is done. There is a task queue and new tasks
are added into the end of it.</p>
<h3 id="concurrent-mode">Concurrent Mode</h3>
<p>As it was said earlier React splits reconciliation into pieces and executes them one by one. It
solves the problem of choppy animations because rendering is interruptible for browser tasks but
it does not solve the problem of responsiveness. Let&rsquo;s take a look at the example:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">class</span> ArticlesList {
</span></span><span style="display:flex;"><span>  state <span style="color:#719e07">=</span> {
</span></span><span style="display:flex;"><span>    articles<span style="color:#719e07">:</span> [],
</span></span><span style="display:flex;"><span>    filter<span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  handleFilter <span style="color:#719e07">=</span> (event) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.setState({ filter<span style="color:#719e07">:</span> event.target.value });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  componentDidMount() {
</span></span><span style="display:flex;"><span>    fetchArticles().then(articles =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.setState({ articles });
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  render() {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">const</span> { articles, filter } <span style="color:#719e07">=</span> <span style="color:#719e07">this</span>.state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#268bd2">input</span> type<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;text&#34;</span> name<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;filter&#34;</span> onChange<span style="color:#719e07">=</span>{<span style="color:#719e07">this</span>.handleFilter} /&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>          {applyFilter(articles, filter).map(article =&gt; &lt;<span style="color:#268bd2">Article</span> data<span style="color:#719e07">=</span>{article} /&gt;)}
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Assume there are a lot of articles and the rendering takes a lot of time. If a user changes the
filter value new task for updating the interface will be enqueued but it will be executed only after
the current rendering will be finished. Such behavior makes the user experience poor that is why
developers have to use different approaches (e.g. debouncing) to solve this problem.</p>
<p>React has an experimental feature called
<a href="https://reactjs.org/docs/concurrent-mode-intro.html">Concurrent Mode</a>. It defines
<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/SchedulerWithReactIntegration.js#L58-L64">priorities</a>
and allows rendering with lower priority to be interrupted by rendering with higher priority. So it
is possible to work on multiple tasks at the same time and switch between them according to their
priority. E.g.  immediate response to user input is more important than updating interface after
fetching data from the network.</p>
<p>How Concurrent Mode works?</p>
<ol>
<li>split rendering into pieces;</li>
<li>process each piece but do not update the interface;</li>
<li>when work is done - update interface.</li>
</ol>
<p>React docs comparing this with SCM like Git when developer create a separate branch for some
feature, work on in and then merge it into the main branch of the project.</p>
<p>What if the user clicks some button during long rendering? In this case, React pauses current
rendering and initializes new one for a processing button click, commits new rendering results into
the browser&rsquo;s DOM and returns to processing long rendering. If it&rsquo;s not possible to continue long
rendering it will be restarted.</p>
<p>This example illustrates Concurrent Mode in action:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">let</span> lastCounter <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; <span style="color:#586e75">// Global variable for multiple mounts detection
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">class</span> Counter <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>  componentWillMount() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (lastCounter <span style="color:#719e07">===</span> <span style="color:#719e07">this</span>.props.value) {
</span></span><span style="display:flex;"><span>      console.log(<span style="color:#586e75">`mount counter with value = </span><span style="color:#2aa198">${</span><span style="color:#719e07">this</span>.props.value<span style="color:#2aa198">}</span><span style="color:#586e75"> multiple times`</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    lastCounter <span style="color:#719e07">=</span> <span style="color:#719e07">this</span>.props.value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// Syncronously wait for 100ms to emulate long work
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>    <span style="color:#268bd2">const</span> start <span style="color:#719e07">=</span> <span style="color:#b58900">Date</span>.now();
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">while</span> (<span style="color:#b58900">Date</span>.now() <span style="color:#719e07">-</span> start <span style="color:#719e07">&lt;</span> <span style="color:#2aa198">100</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  render() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> &lt;<span style="color:#268bd2">div</span>&gt;{<span style="color:#719e07">this</span>.props.value}&lt;/<span style="color:#268bd2">div</span>&gt;;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">class</span> App <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>  state <span style="color:#719e07">=</span> { counter<span style="color:#719e07">:</span> <span style="color:#2aa198">0</span>, showGreetings<span style="color:#719e07">:</span> <span style="color:#cb4b16">true</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  componentDidMount() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.interval <span style="color:#719e07">=</span> setInterval(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.setState({ counter<span style="color:#719e07">:</span> <span style="color:#719e07">this</span>.state.counter <span style="color:#719e07">+</span> <span style="color:#2aa198">1</span> });
</span></span><span style="display:flex;"><span>    }, <span style="color:#2aa198">500</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  componentWillUnmount() {
</span></span><span style="display:flex;"><span>    clearInterval(<span style="color:#719e07">this</span>.interval);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  toggleGreetings <span style="color:#719e07">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.setState({ showGreetings<span style="color:#719e07">:</span> <span style="color:#719e07">!</span><span style="color:#719e07">this</span>.state.showGreetings });
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  render() {
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// Use key attribute to force React to remount Counter component
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>    <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>      &lt;&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#268bd2">button</span> onClick<span style="color:#719e07">=</span>{<span style="color:#719e07">this</span>.toggleGreetings}&gt;Toggle greetings&lt;/<span style="color:#268bd2">button</span>&gt;
</span></span><span style="display:flex;"><span>        {<span style="color:#719e07">this</span>.state.showGreetings <span style="color:#719e07">&amp;&amp;</span> &lt;<span style="color:#268bd2">h1</span>&gt;Hello world<span style="color:#719e07">!</span>&lt;/<span style="color:#268bd2">h1</span>&gt;}
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#268bd2">Counter</span> value<span style="color:#719e07">=</span>{<span style="color:#719e07">this</span>.state.counter} key<span style="color:#719e07">=</span>{<span style="color:#586e75">`counter-</span><span style="color:#2aa198">${</span><span style="color:#719e07">this</span>.state.counter<span style="color:#2aa198">}</span><span style="color:#586e75">`</span>} /&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#268bd2">div</span>&gt;{<span style="color:#719e07">this</span>.state.counter2}&lt;/<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;/&gt;
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">// Instead of regular initialization
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">// ReactDOM.render(&lt;App /&gt;, document.getElementById(&#39;root&#39;));
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">// use Concurrent Rendering for this component
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>ReactDOM.createRoot(<span style="color:#b58900">document</span>.getElementById(<span style="color:#2aa198">&#39;root&#39;</span>)).render(&lt;<span style="color:#268bd2">App</span> /&gt;);
</span></span></code></pre></div><p>There is a counter increased with <code>setInterval</code> every 500ms. Every change of the counter initiate
rendering of the <code>App</code> component and as a result - remounting and rendering of the <code>Counter</code>
component. There is a button that can be used to hide and show greetings caption. It means that
clicking on the button initiate rendering of the <code>App</code> component. Rendering initiated by button
click has higher priority than rendering initiated by <code>setInterval</code>. Rendering of the <code>Counter</code>
component splits into several steps:</p>
<ol>
<li><a href="https://github.com/facebook/react/blob/0253ee9a2e94d43e220a997eeedfcc6847c4542b/packages/react-reconciler/src/ReactFiberClassComponent.js#L525">constructClassInstance</a>;</li>
<li><a href="https://github.com/facebook/react/blob/0253ee9a2e94d43e220a997eeedfcc6847c4542b/packages/react-reconciler/src/ReactFiberClassComponent.js#L760">mountClassIntance</a>;</li>
<li><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberBeginWork.js#L853">render</a>;</li>
<li>reconciling children.</li>
</ol>
<p>Steps 1 - 2 performed one after another as a single chunk of work for React. Step 3 is a separate
chunk. Step 4 is a separate chunk of work but for complex components, it can lead to several chunks
of work.</p>
<p>Rendering of the <code>Counter</code> component can be interrupted after step 2. In this case, React needs
to restart mounting. You can run the example above on the local machine or online service like
<a href="https://codesandbox.io/">https://codesandbox.io/</a> and click the button multiple times. It&rsquo;s possible that you will see
something like this in the browser console:</p>
<blockquote>
<p>mount counter with value = 10 multiple times</p>
</blockquote>
<p>It means <code>Counter</code> rendering was interrupted and restarted. In this case, <code>componentWillMount</code> is
called several times, but for each time new class instance will be created, so it&rsquo;s better to say
that <code>constructor</code> + <code>componentWillMount</code> will be called several times.</p>
<p>When is it unsafe?</p>
<ul>
<li>when component subscribes to some events in <code>componentWillMount</code> and unsubscribes in
<code>componentWillUnmount</code> (it can be a memory leak because <code>componentWillUnmount</code> is not called if
rendering was interrupted);</li>
<li>if it&rsquo;s required to perform some code only once (e.g. some request to the server or modifying
global state).</li>
</ul>
<p>That is why you need to be aware of these possible technical difficulties using
<code>componentWillMount</code> (or <code>UNSAFE_componentWillMount</code>) with Concurrent Mode.</p>
<p>There are some interesting videos devoted to this subject:</p>
<ul>
<li><a href="https://youtu.be/nLF0n9SACd4">Dan Abramov: Beyond React 16 | JSConf Iceland 2018</a>;</li>
<li><a href="https://youtu.be/ByBPyMBTzM0">Concurrent Rendering in React - Andrew Clark and Brian Vaughn - React Conf 2018</a>.</li>
</ul>
<p>Coming to a conclusion I want to mention several points:</p>
<ul>
<li>it&rsquo;s safe to use <code>componentWillMount</code> in React 16.12.0;</li>
<li>it&rsquo;s unsafe to use <code>componentWillMount</code> with Concurrent Mode;</li>
<li><code>componentWillMount</code> can be replaced with more suitable solutions in most cases.</li>
</ul>
  <div class="post-date">
    <a href="../posts/react-journey-componentwillmount-in-concurrent-mode/"><time datetime="2019-12-17T12:00:00Z">Dec 17, 2019 12:00</time></a>
  </div>
</article><article class="post">
  <p>I like to have the same development environment on the local machine and remote servers. In this
case it&rsquo;s possible to write and debug programs not only with your laptop, but also using lightweight
tablet or netbook and at the same time have all stuff you have used to like fast CPU, enough memory
and all the features of IDE like code navigation or autocompletion. I prefer using Emacs on the
Ubuntu machine to achieve this goal.</p>
<p><img src="../emacs-gui.png" alt="Emacs GUI version"></p>
<p>In this article I&rsquo;ll show how to install and configure Emacs for Python development.</p>
<p>Assume you have minimal installation of Ubuntu 18.04. First of all, install python and dependencies:</p>
<pre tabindex="0"><code>sudo apt-get install python3 python3-pip python3-venv
</code></pre><p>Install Emacs (<code>emacs</code> package for desktop or <code>emacs-nox</code> for server):</p>
<pre tabindex="0"><code>sudo apt-get install emacs-nox
</code></pre><p>A lot of projects use <a href="https://www.git-scm.com/">git</a> as a version control system, so it&rsquo;s better to
have it installed:</p>
<pre tabindex="0"><code>sudo apt-get install git
</code></pre><p>Emacs has it&rsquo;s own package system <code>package.el</code>. It allows to download and install different Emacs
extensions from the Internet. <code>package.el</code> allows to use different repositories with packages. One
of the most popular is <a href="https://melpa.org/">MELPA</a>. Add such lines into <code>~/.emacs/init.el</code> file to
configure <code>package.el</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elisp" data-lang="elisp"><span style="display:flex;"><span>(<span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;package</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#268bd2">add-to-list</span> <span style="color:#2aa198">&#39;package-archives</span>
</span></span><span style="display:flex;"><span>             <span style="color:#719e07">&#39;</span>(<span style="color:#2aa198">&#34;melpa&#34;</span> <span style="color:#719e07">.</span> <span style="color:#2aa198">&#34;https://melpa.org/packages/&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#268bd2">package-initialize</span>)
</span></span></code></pre></div><p>When Emacs installs packages it checks integrity using package signature. Unfortunately Emacs in
Ubuntu 18.04 distribution doesn&rsquo;t have public keys to verify MELPA packages, so if signature
checking is enabled then you&rsquo;ll have error like this during package installation:</p>
<pre tabindex="0"><code>Failed to verify signature archive-contents.sig:
No public key for 066DAFCB81E42C40
Command output:
gpg: Can&#39;t check signature: No public key
</code></pre><p>There are to options how to solve this problem:</p>
<ol>
<li>disable signature checking;</li>
<li>update public keys.</li>
</ol>
<p>The first option increases security risks, so we&rsquo;ll use the second one.</p>
<p>Add such line at the beginning of <code>~/.emacs/init.el</code> to disable signature checking temporarily:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elisp" data-lang="elisp"><span style="display:flex;"><span>(<span style="color:#b58900">setq</span> <span style="color:#268bd2">package-check-signature</span> <span style="color:#cb4b16">nil</span>)
</span></span></code></pre></div><p>Then open Emacs, press <code>M-x</code> and type <code>package-refresh-contents</code> to download packages info. Press
<code>M-x</code> and type <code>package-install</code> then enter package name <code>gnu-elpa-keyring-update</code>. This package
updates the GPG keys used by Emacs package manager to verify authenticity of packages downloaded
from the MELPA archive.</p>
<p>Then delete <code>(setq package-check-signature nil)</code> from Emacs config and restart editor.</p>
<p>Open Emacs, press <code>M-x</code> and type <code>package-list-packages</code>. Select packages:</p>
<ul>
<li><a href="https://github.com/technomancy/better-defaults">better-defaults</a> - project title speaks for
itself;</li>
<li><a href="https://github.com/jorgenschaefer/elpy">elpy</a> - Emacs Python Development Environment;</li>
<li><a href="https://github.com/bbatsov/projectile">projectile</a> - Project Interaction Library for Emacs;</li>
<li><a href="https://github.com/magit/magit">magit</a> - an interface to the Git, implemented as an Emacs
package;</li>
<li><a href="https://github.com/bbatsov/zenburn-emacs">zenburn-theme</a> - low contrast color theme available for
Emacs and popular terminal emulators.</li>
</ul>
<p>To select package use <code>i</code>. After all packages have been selected use <code>x</code> to install them.</p>
<p>To enable and configure installed package add following lines into <code>~/.emacs/init.el</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elisp" data-lang="elisp"><span style="display:flex;"><span><span style="color:#586e75">;; Activate better-defaults package</span>
</span></span><span style="display:flex;"><span>(<span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;better-defaults</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">;; Activate zenburn theme</span>
</span></span><span style="display:flex;"><span>(<span style="color:#268bd2">load-theme</span> <span style="color:#2aa198">&#39;zenburn</span> <span style="color:#cb4b16">t</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">;; Enable line numbers for python files</span>
</span></span><span style="display:flex;"><span>(<span style="color:#268bd2">add-hook</span> <span style="color:#2aa198">&#39;python-mode-hook</span> <span style="color:#2aa198">&#39;linum-mode</span>)
</span></span><span style="display:flex;"><span><span style="color:#586e75">;; Insert space after line number to make it easier to read</span>
</span></span><span style="display:flex;"><span>(<span style="color:#b58900">setq</span> <span style="color:#268bd2">linum-format</span> <span style="color:#2aa198">&#34;%d &#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">;; Use python3 for autocompletion and code navigation</span>
</span></span><span style="display:flex;"><span>(<span style="color:#b58900">setq</span> <span style="color:#268bd2">elpy-rpc-python-command</span> <span style="color:#2aa198">&#34;python3&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#586e75">;; Use python3 as a interpreter in integrated python shell</span>
</span></span><span style="display:flex;"><span>(<span style="color:#b58900">setq</span> <span style="color:#268bd2">python-shell-interpreter</span> <span style="color:#2aa198">&#34;python3&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">;; Activate elpy</span>
</span></span><span style="display:flex;"><span>(<span style="color:#268bd2">elpy-enable</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">;; Activate projectile</span>
</span></span><span style="display:flex;"><span>(<span style="color:#268bd2">projectile-mode</span> <span style="color:#2aa198">+1</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#268bd2">define-key</span> <span style="color:#268bd2">projectile-mode-map</span> (<span style="color:#268bd2">kbd</span> <span style="color:#2aa198">&#34;C-c p&#34;</span>) <span style="color:#2aa198">&#39;projectile-command-map</span>)
</span></span></code></pre></div><p>Open some python file and start typing. Emacs will ask you for installing elpy dependencies required
for autocompletion and code navigation. Install it and that&rsquo;s it.</p>
<p>If you use Emacs from terminal make sure your <code>TERM</code> environment variable equals to
<code>xterm-256color</code>. Terminal version looks almost the same as GUI one:</p>
<p><img src="../emacs-terminal.png" alt="Emacs terminal version"></p>
<p>Now you can write python code in Emacs using desktop or remote server. For remote server I recommend
using <a href="https://en.wikipedia.org/wiki/Tmux">tmux</a>. It allows to make only one connection to the
server and run multiple shells in it. Also if you use unstable Internet connection you will not
loose any data in case of disconnect.</p>
<p>You may continue exploring the world of Emacs packages or try one of Emacs distributions like
<a href="https://prelude.emacsredux.com/en/latest/">Prelude</a> or <a href="http://spacemacs.org/">Spacemacs</a>.
There are a lot of interesting staff.</p>
  <div class="post-date">
    <a href="../posts/configure-emacs-for-python-development/"><time datetime="2019-10-19T10:30:00Z">Oct 19, 2019 10:30</time></a>
  </div>
</article><article class="post">
  <p>One of the most challenging problems for frontend developers is the reuse of code. It&rsquo;s especially
important for big applications. Traditional approaches with higher-order components and render-props
have advantages and disadvantages. In some cases, it can be inconvenient to use them. React 16.8
introduced a new feature called React Hooks. Let&rsquo;s take a look at it and try to figure out how does
it work and how does it solve the problem of code reuse.</p>
<h2 id="problem-of-code-reuse">Problem of code reuse</h2>
<p>During the software development process of frontend project, every developer meets code reuse
problem sooner or later. This code can be stateless or stateful. A typical example of stateless
shared code is date formatting function. It can be used like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">import</span> { formatDate } from <span style="color:#2aa198">&#39;utils&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> Comment(props) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#268bd2">div</span> className<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;comment&#34;</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">div</span> className<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;createdAt&#34;</span>&gt;{formatDate(props.createdAt)}&lt;/<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">p</span>&gt;{props.text}&lt;/<span style="color:#268bd2">p</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It&rsquo;s easy to use stateless shared code because you don&rsquo;t need to think about the state, so it can be
moved into <a href="https://www.freecodecamp.org/news/what-is-a-pure-function-in-javascript-acb887375dfe/">pure functions</a>.</p>
<p>A More difficult situation is when you need some state. E.g. several components need the current
user name and array of comments. The logic of data fetching is the same and we want to share it
between all components.</p>
<p>Let&rsquo;s compare different approaches to solving this problem.</p>
<h2 id="render-props">Render props</h2>
<p><a href="https://reactjs.org/docs/render-props.html">Render props</a> is a technique for sharing the code
between React components using a prop whose value is a function. Such an approach makes it possible
to separate logic and rendering into two different components.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">class</span> UserProvider <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>  state <span style="color:#719e07">=</span> { user<span style="color:#719e07">:</span> <span style="color:#cb4b16">null</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">async</span> componentDidMount() {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">const</span> user <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> fetchUser();
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.setState({ user });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  render() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> <span style="color:#719e07">this</span>.props.render(<span style="color:#719e07">this</span>.state.user);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> App(user) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#268bd2">p</span>&gt;
</span></span><span style="display:flex;"><span>      Current user<span style="color:#719e07">:</span> {user <span style="color:#719e07">?</span> user.name <span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;anonymous&#39;</span>}
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#268bd2">p</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ReactDOM.render(&lt;<span style="color:#268bd2">UserProvider</span> render<span style="color:#719e07">=</span>{App} /&gt;, <span style="color:#b58900">document</span>.getElementById(<span style="color:#2aa198">&#39;app&#39;</span>));
</span></span></code></pre></div><p>In the example above user fetching extracted into separate <code>UserProvider</code> component. This component
takes a function as a <code>render</code> prop that returns a React element and calls it instead of
implementing its own render logic, so different components can reuse <code>UserProvider</code>.</p>
<p>If some component needs two different render props components it can be implemented like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">class</span> UserProvider <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>  state <span style="color:#719e07">=</span> { user<span style="color:#719e07">:</span> <span style="color:#cb4b16">null</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">async</span> componentDidMount() {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">const</span> user <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> fetchUser();
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.setState({ user });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  render() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> <span style="color:#719e07">this</span>.props.render(<span style="color:#719e07">this</span>.state.user);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">class</span> CommentsProvider <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>  state <span style="color:#719e07">=</span> { comments<span style="color:#719e07">:</span> [] };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">async</span> componentDidMount() {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">const</span> comments <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> fetchComments();
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">this</span>.setState({ comments });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  render() {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> <span style="color:#719e07">this</span>.props.render(<span style="color:#719e07">this</span>.state.comments);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> App(user, comments) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>    &lt;&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">p</span>&gt;Current user<span style="color:#719e07">:</span> {user <span style="color:#719e07">?</span> user.name <span style="color:#719e07">:</span> <span style="color:#2aa198">&#34;anonymous&#34;</span>}&lt;/<span style="color:#268bd2">p</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">div</span> className<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;comments&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        {comments.map(c =&gt; (
</span></span><span style="display:flex;"><span>          &lt;<span style="color:#268bd2">div</span> className<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;comment&#34;</span>&gt;{c.text}&lt;/<span style="color:#268bd2">div</span>&gt;)
</span></span><span style="display:flex;"><span>        )}
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ReactDOM.render(
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#268bd2">UserProvider</span>
</span></span><span style="display:flex;"><span>    render<span style="color:#719e07">=</span>{user =&gt; (
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">CommentsProvider</span> render<span style="color:#719e07">=</span>{comments =&gt; (
</span></span><span style="display:flex;"><span>        App(user, comments)
</span></span><span style="display:flex;"><span>      )} /&gt;;
</span></span><span style="display:flex;"><span>    )}
</span></span><span style="display:flex;"><span>  /&gt;,
</span></span><span style="display:flex;"><span>  <span style="color:#b58900">document</span>.getElementById(<span style="color:#2aa198">&#34;app&#34;</span>)
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>As you can see, this code looks a bit dirty.</p>
<h2 id="higher-order-components">Higher-Order Components</h2>
<p><a href="https://reactjs.org/docs/higher-order-components.html">Higher-order components</a> (HOC) is a function
that takes a component and returns a new component. Such a technique can be used for extracting
logic into a wrapper-component and reuse it later in several places.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">function</span> withUser(WrappedComponent) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>    constructor(props) {
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">super</span>(props);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.state <span style="color:#719e07">=</span> { user<span style="color:#719e07">:</span> <span style="color:#cb4b16">null</span> };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">async</span> componentDidMount() {
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">const</span> user <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> fetchUser();
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.setState({ user });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#268bd2">WrappedComponent</span> {...this.props} user<span style="color:#719e07">=</span>{<span style="color:#719e07">this</span>.state.user} /&gt;
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> App({ user }) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#268bd2">p</span>&gt;
</span></span><span style="display:flex;"><span>      Current user<span style="color:#719e07">:</span> {user <span style="color:#719e07">?</span> user.name <span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;anonymous&#39;</span>}
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#268bd2">p</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> WrappedApp <span style="color:#719e07">=</span> withUser(App);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ReactDOM.render(&lt;<span style="color:#268bd2">WrappedApp</span> /&gt;, <span style="color:#b58900">document</span>.getElementById(<span style="color:#2aa198">&#39;app&#39;</span>));
</span></span></code></pre></div><p>In the example above user fetching extracted into separate component returned by <code>withUser</code>
function. This component wraps the original <code>App</code> component and provides <code>user</code> property for it.</p>
<p>Any component can be wrapped by several HOCs to connect different logic:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">function</span> withUser(WrappedComponent) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>    constructor(props) {
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">super</span>(props);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.state <span style="color:#719e07">=</span> { user<span style="color:#719e07">:</span> <span style="color:#cb4b16">null</span> };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">async</span> componentDidMount() {
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">const</span> user <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> fetchUser();
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.setState({ user });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#268bd2">WrappedComponent</span> {...this.props} user<span style="color:#719e07">=</span>{<span style="color:#719e07">this</span>.state.user} /&gt;
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> withComments(WrappedComponent) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">extends</span> React.Component {
</span></span><span style="display:flex;"><span>    constructor(props) {
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">super</span>(props);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.state <span style="color:#719e07">=</span> { comments<span style="color:#719e07">:</span> [] };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">async</span> componentDidMount() {
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">const</span> comments <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> fetchComments();
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">this</span>.setState({ comments });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#268bd2">WrappedComponent</span> {...this.props} comments<span style="color:#719e07">=</span>{<span style="color:#719e07">this</span>.state.comments} /&gt;
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> App({ user, comments }) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>    &lt;&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">p</span>&gt;Current user<span style="color:#719e07">:</span> {user <span style="color:#719e07">?</span> user.name <span style="color:#719e07">:</span> <span style="color:#2aa198">&#34;anonymous&#34;</span>}&lt;/<span style="color:#268bd2">p</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">div</span> className<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;comments&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        {comments.map(c =&gt; (
</span></span><span style="display:flex;"><span>          &lt;<span style="color:#268bd2">div</span> className<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;comment&#34;</span>&gt;{c.text}&lt;/<span style="color:#268bd2">div</span>&gt;)
</span></span><span style="display:flex;"><span>        )}
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">const</span> WrappedApp <span style="color:#719e07">=</span> withComments(withUser(App));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ReactDOM.render(&lt;<span style="color:#268bd2">WrappedApp</span> /&gt;, <span style="color:#b58900">document</span>.getElementById(<span style="color:#2aa198">&#39;app&#39;</span>));
</span></span></code></pre></div><p>I think such chain <code>withCommens(withUser(App))</code> looks much better than render props variant.</p>
<p>All wrapper-components are displayed in React Debugger:</p>
<p><img src="../wrappers.png" alt="Wrappers"></p>
<p>For the long chains, it can be difficult to inspect and debug such tree but I think if an
application contains such chains maybe its structure needs to be redesigned.</p>
<h2 id="react-hooks">React Hooks</h2>
<p>Before React 16.8 there were two types of components: stateless functional components and
stateful class components. In <a href="https://reactjs.org/blog/2019/02/06/react-v16.8.0.html">React 16.8</a>
Hooks were introduced. As it is said in the
<a href="https://reactjs.org/docs/hooks-state.html#whats-a-hook">official documentation</a>:</p>
<blockquote>
<p>If you write a function component and realize you need to add some state to it, previously you had
to convert it to a class. Now you can use a Hook inside the existing function component.</p>
</blockquote>
<p>So the border between stateful and stateless components is blurring.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">function</span> useUser() {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> [user, setUser] <span style="color:#719e07">=</span> useState(<span style="color:#cb4b16">null</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  useEffect(<span style="color:#268bd2">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">const</span> u <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> fetchUser();
</span></span><span style="display:flex;"><span>    setUser(u);
</span></span><span style="display:flex;"><span>  }, []);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> user;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> App() {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> user <span style="color:#719e07">=</span> useUser();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#268bd2">p</span>&gt;
</span></span><span style="display:flex;"><span>      Current user<span style="color:#719e07">:</span> {user <span style="color:#719e07">?</span> user.name <span style="color:#719e07">:</span> <span style="color:#2aa198">&#39;anonymous&#39;</span>}
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#268bd2">p</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ReactDOM.render(&lt;<span style="color:#268bd2">App</span> /&gt;, <span style="color:#b58900">document</span>.getElementById(<span style="color:#2aa198">&#39;app&#39;</span>));
</span></span></code></pre></div><p>Before React Hooks it was a rule that functional components do not have any state but now it&rsquo;s not
true. React provides some sort of external context for every functional component and React Hooks
use this context to store state and perform some effects like <code>componentDidMount</code> hook does for
class components. I suggest reading
<a href="https://github.com/acdlite/react-fiber-architecture">react fiber architecture description</a> to
understand better how React Hooks is implemented.</p>
<p>In the example above custom hook <code>useUser</code> was introduced. It encapsulates user state and makes it
possible to use it in <code>App</code> functional component. Several custom hooks can be used in one functional
component:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">function</span> useUser() {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> [user, setUser] <span style="color:#719e07">=</span> useState(<span style="color:#cb4b16">null</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  useEffect(<span style="color:#268bd2">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">const</span> u <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> fetchUser();
</span></span><span style="display:flex;"><span>    setUser(u);
</span></span><span style="display:flex;"><span>  }, []);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> user;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> useComments() {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> [comments, setComments] <span style="color:#719e07">=</span> useState([]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  useEffect(<span style="color:#268bd2">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">const</span> c <span style="color:#719e07">=</span> <span style="color:#268bd2">await</span> fetchComments();
</span></span><span style="display:flex;"><span>    setComments(c);
</span></span><span style="display:flex;"><span>  }, []);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> user;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> App() {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> user <span style="color:#719e07">=</span> useUser();
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> comments <span style="color:#719e07">=</span> useUser();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>    &lt;&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">p</span>&gt;Current user<span style="color:#719e07">:</span> {user <span style="color:#719e07">?</span> user.name <span style="color:#719e07">:</span> <span style="color:#2aa198">&#34;anonymous&#34;</span>}&lt;/<span style="color:#268bd2">p</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">div</span> className<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;comments&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        {comments.map(c =&gt; (
</span></span><span style="display:flex;"><span>          &lt;<span style="color:#268bd2">div</span> className<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;comment&#34;</span>&gt;{c.text}&lt;/<span style="color:#268bd2">div</span>&gt;)
</span></span><span style="display:flex;"><span>        )}
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ReactDOM.render(&lt;<span style="color:#268bd2">App</span> /&gt;, <span style="color:#b58900">document</span>.getElementById(<span style="color:#2aa198">&#39;app&#39;</span>));
</span></span></code></pre></div><p>The example with hooks requires less code and it seems that it is easier to read but there are some
disadvantages to this approach.</p>
<p>First of all, it&rsquo;s more difficult to understand how all this stuff works. When you use class
components internal data is stored in <code>this.state</code> variable and the only source of external data is
props. It&rsquo;s easy to understand such code works and easy to debug it because all your internal data
encapsulated in your instance. When you use hooks you have to know that your function is being
executed in some special React context and Hooks can store and extract data using some sort of
magic, you need to remember <a href="https://reactjs.org/docs/hooks-rules.html">Rules of Hooks</a> to write
code without errors.</p>
<p>Also, it&rsquo;s more difficult to test your code with React Hooks. Assume you want to check rendering
logic. In case of render props or HOC you just provide some attributes for your presentational
component and check the result:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#268bd2">function</span> App({ user, comments }) {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> (
</span></span><span style="display:flex;"><span>    &lt;&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">p</span>&gt;Current user<span style="color:#719e07">:</span> {user <span style="color:#719e07">?</span> user.name <span style="color:#719e07">:</span> <span style="color:#2aa198">&#34;anonymous&#34;</span>}&lt;/<span style="color:#268bd2">p</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#268bd2">div</span> className<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;comments&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        {comments.map(c =&gt; (
</span></span><span style="display:flex;"><span>          &lt;<span style="color:#268bd2">div</span> className<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;comment&#34;</span>&gt;{c.text}&lt;/<span style="color:#268bd2">div</span>&gt;)
</span></span><span style="display:flex;"><span>        )}
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#268bd2">div</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>it(<span style="color:#2aa198">&#39;Renders &#34;anonymous&#34; if user prop is null&#39;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">const</span> app <span style="color:#719e07">=</span> shallow(&lt;<span style="color:#268bd2">App</span> user<span style="color:#719e07">=</span>{<span style="color:#cb4b16">null</span>} comments<span style="color:#719e07">=</span>{[]} /&gt;);
</span></span><span style="display:flex;"><span>  expect(app.text()).to.contain(<span style="color:#2aa198">&#39;anonymous&#39;</span>);
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>In case of React Hooks, you have to mock <code>fetchUser</code> and <code>fetchComments</code> function somehow. Sometimes
it can tricky and moreover you check not only rendering logic but custom hooks logic too.</p>
<h2 id="conclusion">Conclusion</h2>
<p>I think React Hooks is a tricky feature which has advantages and disadvantages. Sometimes it can be
useful and sometimes it can make your code harder to understand, so think twice before integrate it
into your project.</p>
  <div class="post-date">
    <a href="../posts/code-reuse-with-react-hooks/"><time datetime="2019-07-07T12:00:00Z">Jul 7, 2019 12:00</time></a>
  </div>
</article><article class="post">
  <p><img src="../js-vs-jpg.png" alt="Comparation between JS and JPG processing"></p>
<p><strong>TL;DR: sometimes processing of JS file can be faster than the processing of JPG of the same size
in bytes, you&rsquo;d better check your own project before optimizing it.</strong></p>
<p>Several days ago I&rsquo;ve read an article by Addy Osmani
<a href="https://medium.com/dev-channel/the-cost-of-javascript-84009f51e99e">The Cost Of JavaScript</a>. It&rsquo;s a
great explanation about the importance of optimization of JS, especially for mobile resources. The
main idea of the article is that JS processing consists of not only network data transferring but
also decompression, parsing, compiling and executing. These operations can take a lot of time,
especially on slow mobile devices. So to make fast and convenient web application it&rsquo;s important to
track JS files size and content.</p>
<p>I agree with Addy&rsquo;s ideas but one thing which confused me is this picture:</p>
<p><img src="../js-vs-jpeg-addyosmani.png" alt="Comparison between JS and JPG processing"></p>
<p>Addy wants to show us that it&rsquo;s faster to load an image than process a JS file of the same size. It
looks logical because everyone knows that JS parsing and compilation is a very sophisticated process
and image parsing is not. Unfortunately, I haven&rsquo;t found any source code or images which were used
to make this picture and that is why I have a question: Is JS processing always slower than images
processing for the files of the same size?</p>
<p>Let&rsquo;s talk a bit about images processing. <a href="https://en.wikipedia.org/wiki/JPEG">JPEG</a> is a method of
lossy compression for digital images. This statement leads to several consequences:</p>
<ol>
<li>two files of the same size can be images of different resolution (e.g. 20x20 and 400x400);</li>
<li>the browser has to convert JPEG into some sort of BMP to render an image.</li>
</ol>
<p>Let&rsquo;s check two cases:</p>
<ol>
<li><strong>the normal image</strong> I used classic <a href="https://en.wikipedia.org/wiki/Lenna">Lenna</a> image from
Wikipedia converted to 320x320 JPEG using ImageMagick command
<code>convert Lenna.png -resize 320x320 Lenna.jpg</code>. It produced 43KB file;</li>
<li><strong>edge case image</strong> I used ImageMagick command <code>convert -size 3000x3000 xc:white empty.jpg</code> to
create 3000x3000 image filled with white color. It produced 35KB file.</li>
</ol>
<p>These files have a similar size. I want to check if it will be processed for the same period of
time.</p>
<p>Now I want to write several words about JS. JS compilation is very complicated and it&rsquo;s obvious that
two different JS files of the same size can be processed for a different time. To see this
difference let&rsquo;s take a look at two examples:</p>
<ol>
<li><strong>React.js Hello World app</strong> stored in <a href="https://github.com/0e39bf7b/js-perf-test">GitHUb repo</a>. I
used <a href="https://github.com/facebook/create-react-app">create-react-app</a> to build it. It produced
37KB file;</li>
<li><strong>syntactically correct useless JS</strong>. I used the script from
<a href="https://gist.github.com/0e39bf7b/ff8f160f4d113fee22d74052c01a903f">this gist</a> to produce 37KB
file.</li>
</ol>
<h3 id="hardware-and-software">Hardware and software</h3>
<ul>
<li>MacBook Pro Retina 15&quot; Mid 2014 2,5 GHz Core i7 16 GB RAM</li>
<li>Node.js v10.15.1</li>
<li>nginx 1.15.8</li>
<li>Google Chrome 74.0.3729.157</li>
</ul>
<h3 id="results">Results</h3>
<table>
<thead>
<tr>
<th>Use case</th>
<th>Processing time</th>
</tr>
</thead>
<tbody>
<tr>
<td>Normal image 320x320 34KB</td>
<td>1.32ms</td>
</tr>
<tr>
<td>Blank synthetic image 3000x3000 35KB</td>
<td>37.18ms</td>
</tr>
<tr>
<td>React Hello world 37KB</td>
<td>19.19ms</td>
</tr>
<tr>
<td>Simple synthetic JS 37KB</td>
<td>1.39ms</td>
</tr>
</tbody>
</table>
<p>Coming to a conclusion I want to mention the following:</p>
<ol>
<li>It&rsquo;s important to describe all code and tools which can be used to reproduce experiment;</li>
<li>The browser can spend different time to process pictures of the same size in bytes;</li>
<li>The browser can spend different time to process JS files of the same size in bytes;</li>
<li>The browser can spend more time process some pictures than to process some JS of the same size in
bytes;</li>
<li>Optimization is important.</li>
</ol>
<h3 id="useful-links">Useful links</h3>
<ul>
<li><a href="https://medium.com/dev-channel/the-cost-of-javascript-84009f51e99e">The Cost Of JavaScript</a></li>
<li><a href="https://medium.com/@addyosmani/the-cost-of-javascript-in-2018-7d8950fbb5d4">The Cost Of JavaScript In 2018</a></li>
<li><a href="https://medium.com/@roderickhsiao/performance-101-i-know-how-to-load-images-a262d556250f">Performance 101 — I Know How to Load Images</a></li>
</ul>
  <div class="post-date">
    <a href="../posts/js-vs-jpg/"><time datetime="2019-05-25T10:00:00Z">May 25, 2019 10:00</time></a>
  </div>
</article><article class="post">
  <p>In the modern, world there are a lot of different libraries and tools which were created to simplify
software development, make it faster and less error-prone. Let&rsquo;s talk about frontend development. 10</p>
<ul>
<li>15 years ago the size of the JavaScript code on a regular Internet resource was much smaller.
The majority of resources used <a href="https://jquery.com/">jQuery</a> with several plugins and a bit of
business logic. Nowadays web applications become much more complicated, contain a lot of business
logic and that is why being built using the Single Page Application (SPA) approach. When an
application is written like SPA it creates page content in the browser dynamically instead of
rendering HTML received from a server.</li>
</ul>
<p>Such an approach requires complicated frameworks like <a href="https://reactjs.org/">React</a> or
<a href="https://angular.io/">Angular</a> so the size of <code>vendor.js</code> is measured in thousands of Kb. It looks
reasonable when we talk about big enterprise applications but for a simple resource it&rsquo;s strange.
I&rsquo;ve seen a lot of situations when developers tried to solve consequences of this problem but not
the problem itself, i.e. they configured code splitting for big <code>vendor.js</code> instead of refusing
using complicated libraries which actually are not required for the project of that size.</p>
<p>Almost every popular framework or library requires a lot of dependencies, i.e. today I&rsquo;ve created
empty Angular application using <code>ng new</code> command and it has 1143 dependencies. Furthermore, if you
need some additional features you install some plugins with additional dependencies. So the size of
<code>node_modules</code> can reach thousands of megabytes and application building process can take a lot of
time.</p>
<p>If you have a fast network and high-performance computers such problem is invisible or unimportant.
There is another problem which can&rsquo;t be solved using better hardware, the problem familiar for every
developer - overengineering. Let&rsquo;s take a look at a classic &ldquo;Hello world&rdquo; application in JavaScript:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>console.log(<span style="color:#2aa198">&#34;Hello world&#34;</span>);
</span></span></code></pre></div><p>Nice and easy, but what if tomorrow I&rsquo;ll need to print this text several times in different
functions? It&rsquo;s good practice to extract it into a constant.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> HELLO_TEXT <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Hello world&#34;</span>;
</span></span><span style="display:flex;"><span>console.log(HELLO_TEXT);
</span></span></code></pre></div><p>I think the logging is tightly coupled with the application logic. It&rsquo;s not OK. Well known books
suggest to avoid such situations, so let&rsquo;s add a bit of dependency injection.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> HELLO_TEXT <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Hello world&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> run(log) {
</span></span><span style="display:flex;"><span>  log(HELLO_TEXT);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>run(console.log.bind(console));
</span></span></code></pre></div><p>I want my application to be extensible because I don&rsquo;t want to rewrite all the code from scratch
every time when requirements are changed. What if tomorrow I&rsquo;ll need to send this text over the
network instead of simple printing to the console? Let&rsquo;s add some logger class which I can inherit
from and overwrite its behavior.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#268bd2">const</span> HELLO_TEXT <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Hello world&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">class</span> Logger {
</span></span><span style="display:flex;"><span>  log(msg) {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">throw</span> <span style="color:#719e07">new</span> <span style="color:#b58900">Error</span>(<span style="color:#2aa198">&#34;Not Implemented&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">class</span> DefaultLogger {
</span></span><span style="display:flex;"><span>  log(msg) {
</span></span><span style="display:flex;"><span>    console.log(msg);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">function</span> run(logger) {
</span></span><span style="display:flex;"><span>  logger.log(HELLO_TEXT);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>run(<span style="color:#719e07">new</span> DefaultLogger);
</span></span></code></pre></div><p>As you see simple one line application grew up a lot. Do you think it&rsquo;s easier to read? Do you think
this application solves some new problem? Do you think this application will cover all new
requirements in the future? The only thing I see is that the application became bigger and more
sophisticated.</p>
<p>Let&rsquo;s consider a real-life example. I&rsquo;ve read an article about <a href="https://redux.js.org/">Redux</a> and
have watched video from the big respectful frontend conference about the separation of the state and
the presentation. I&rsquo;ve understood the importance of such ideas and now I want to integrate Redux
into my pet project for the state management, <a href="https://redux-form.com">Redux Form</a> for forms
management (I have only one simple form in this project) and
<a href="https://github.com/redux-saga/redux-saga">redux-saga</a> to make application side effects easier to
manage (I have only one request to the server) and test (for now I don&rsquo;t have any tests at all).
From the one side if this project grows up there will be some probability that project structure
won&rsquo;t change and it&rsquo;ll save some time. From the other side let&rsquo;s take a look at what I have for now:</p>
<ul>
<li>If I want to understand where some data is using, I need to search over the whole project,
because any component can connect to Redux and change the data in some way;</li>
<li>If I need to understand the way some data is being processed I need to look through several files
(component, store, file with action name constants, action creator, saga);</li>
<li>If I want to add a new request to the server I have to add or modify several files.</li>
</ul>
<p>If you consider Redux integration as some sort of training then it&rsquo;s OK, but if you integrate Redux
in a small application and don&rsquo;t see all these negative consequences it&rsquo;s a bit strange. I can
oversimplify and say that Redux is some sort of global variable with several coding conventions
which protect developers from shooting themselves in the foot. But there is a well-known piece of
advice being given to any junior developer: avoid global variables if you can. So why Redux or
<a href="https://reactjs.org/docs/context.html">React Context</a> is different?</p>
<p>I wonder why some developers see only positive sides of technologies they use. They think their code
is clear and beautiful but for someone who isn&rsquo;t familiar with a new modern complicated library it&rsquo;s
very difficult to understand anything and requires a lot of time joining the project.</p>
<p>Sometimes developers trust every word of famous engineers: if they say object-oriented programming
is bad and functional programming is good so it is, if they say use global storage in your project
you need to rewrite your application and integrate global storage in it, if someone on frontend
conference says that every application need server side rendering you&rsquo;d better do so.</p>
<p>In my opinion, every developer should think before using any of such suggestions. Maybe a famous
developer works in a big company which solves its own tasks. What if these tasks require such
approaches and instruments which will be unacceptable for some other tasks. Sometimes
object-oriented programming can be more suitable than functional programming and the global store
isn&rsquo;t the best solution. One more thing, every developer even experienced one is a human and that is
why can make mistakes. Blind faith in a person leads to an inability of making reasonable decisions
and that is why it slows down the developer&rsquo;s growth.</p>
<p>Another situation which I meet from time to time is incomprehension of libraries and frameworks used
in a project. Almost every project use <a href="https://webpack.js.org/">Webpack</a> but only a few developers
can say how the code of Webpack works and why. Ok, maybe such type of knowledge is too specific but
almost no one even looks at the bundled file structure. Sometimes during code review, I ask
developers if they took a look on a code of used libraries and the most popular answer is: &ldquo;No, why
do I need to do so?&rdquo;</p>
<p>Some developers think that it&rsquo;s unimportant technical details and they can solve business problems
without it, but it&rsquo;s not true: you can&rsquo;t understand why you can&rsquo;t use <code>if/else</code> in jsx if you don&rsquo;t
know how it processed with <a href="https://babeljs.io/">Babel</a>, you can&rsquo;t understand why sometimes Webpack
during building process returns to 30% after it shows 50% if you don&rsquo;t know how it performs
building, you can&rsquo;t write safe code if you don&rsquo;t know how Webpack modules isolated from each other
and so on.</p>
<p>Some developers can say that all this information is very interesting but they don&rsquo;t have time to
explore it, because every day some new instrument is released and they need to look at it to stay in
trend. As I know employers always need two kinds of developers: someone with deep knowledge of a
particular instrument or business field and someone who can learn such instrument very quickly.
From the one side, people who don&rsquo;t spend time on learning instruments deeply obviously can&rsquo;t belong
to the first group. From the other side, all libraries and frameworks are alike, so if you learn one
of them deeply it&rsquo;ll be easy to switch to another one.</p>
<p>Coming to a conclusion I want to underline three main points:</p>
<ul>
<li>Do not overcomplicate your code</li>
<li>Trust no one even famous engineers, always check if some advice or solution is suitable for
your particular case</li>
<li>Learn your instruments deeply</li>
</ul>
<p>These points will make you a better developer.</p>
  <div class="post-date">
    <a href="../posts/overengineering/"><time datetime="2019-04-20T11:05:05Z">Apr 20, 2019 11:05</time></a>
  </div>
</article>
</div>
    </main>
  </body>
</html>
